
; Generate a single frame of HDMA data for animated backgrounds
GENERATE_BATTLEBG_FRAME:
	BEGIN_C_FUNCTION_FAR
	STACK_RESERVE_VARS
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT8
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16 ;NEAR loaded_bg_data* bgState
	STACK_RESERVE_PARAM_INT16 ;int layer
	END_STACK_VARS
	STX @LOCAL08
	STA @LOCAL07
	LDA (@LOCAL07)
	AND #$00FF
	STA @LOCAL06
	LDY #loaded_bg_data::freeze_palette_scrolling
	LDA (@LOCAL07),Y
	AND #$00FF
	BNEL @TARGET_BG_LAYER_SELECTION_COMPLETE
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::palette_change_duration_left
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA @LOCAL05
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BEQL @UNKNOWN23
	SEP #PROC_FLAGS::ACCUM8
	LDA @LOCAL05
	DEC
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BNEL @UNKNOWN23
	LDY #loaded_bg_data::palette_change_speed
	SEP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
	STA __BSS_START__,X
	LDY #loaded_bg_data::palette_shifting_style
	REP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
	AND #$00FF
	CMP #2
	BEQ @PALETTE_SHIFTING_STYLE2
	CMP #1
	BEQL @PALETTE_SHIFTING_STYLE1
	CMP #3
	BEQL @PALETTE_SHIFTING_STYLE3
	JMP @PALETTE_SHIFTING_DONE
@PALETTE_SHIFTING_STYLE2:
	LDY #loaded_bg_data::palette_cycle_2_last
	SEP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
	LDY #loaded_bg_data::palette_cycle_2_first
	SEC
	SBC (@LOCAL07),Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA @VIRTUAL02
	INC @VIRTUAL02
	LDX #0
	STX @LOCAL04
	BRA @UNKNOWN9
@UNKNOWN6:
	LDY #loaded_bg_data::palette_cycle_2_step
	LDA (@LOCAL07),Y
	AND #$00FF
	STA @VIRTUAL04
	TXA
	CMP @VIRTUAL04
	BCS @UNKNOWN7
	TXA
	CLC
	ADC @VIRTUAL02
	SEC
	SBC @VIRTUAL04
	STA @LOCAL03
	BRA @UNKNOWN8
@UNKNOWN7:
	TXA
	SEC
	SBC @VIRTUAL04
	STA @LOCAL03
@UNKNOWN8:
	LDY #loaded_bg_data::palette_cycle_2_first
	LDA (@LOCAL07),Y
	AND #$00FF
	TAY
	STY @LOCAL02
	STX @VIRTUAL04
	TYA
	CLC
	ADC @VIRTUAL04
	ASL
	LDY #loaded_bg_data::palette_pointer
	CLC
	ADC (@LOCAL07),Y
	PHA
	LDA @LOCAL03
	STA @VIRTUAL04
	LDY @LOCAL02
	TYA
	CLC
	ADC @VIRTUAL04
	ASL
	CLC
	ADC @LOCAL07
	TAX
	LDA __BSS_START__+12,X
	PLX
	STA __BSS_START__,X
	LDX @LOCAL04
	INX
	STX @LOCAL04
@UNKNOWN9:
	TXA
	CMP @VIRTUAL02
	BCC @UNKNOWN6
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::palette_cycle_2_step
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	CMP @VIRTUAL02
	BCC @PALETTE_SHIFTING_STYLE1
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA __BSS_START__,X
@PALETTE_SHIFTING_STYLE1:
	LDY #loaded_bg_data::palette_cycle_1_last
	SEP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
	LDY #loaded_bg_data::palette_cycle_1_first
	SEC
	SBC (@LOCAL07),Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA @VIRTUAL02
	INC @VIRTUAL02
	LDX #0
	STX @LOCAL04
	BRA @UNKNOWN14
@UNKNOWN11:
	LDY #loaded_bg_data::palette_cycle_1_step
	LDA (@LOCAL07),Y
	AND #$00FF
	STA @VIRTUAL04
	TXA
	CMP @VIRTUAL04
	BCS @UNKNOWN12
	TXA
	CLC
	ADC @VIRTUAL02
	SEC
	SBC @VIRTUAL04
	STA @LOCAL03
	BRA @UNKNOWN13
@UNKNOWN12:
	TXA
	SEC
	SBC @VIRTUAL04
	STA @LOCAL03
@UNKNOWN13:
	LDY #loaded_bg_data::palette_cycle_1_first
	LDA (@LOCAL07),Y
	AND #$00FF
	TAY
	STY @LOCAL02
	STX @VIRTUAL04
	TYA
	CLC
	ADC @VIRTUAL04
	ASL
	LDY #loaded_bg_data::palette_pointer
	CLC
	ADC (@LOCAL07),Y
	PHA
	LDA @LOCAL03
	STA @VIRTUAL04
	LDY @LOCAL02
	TYA
	CLC
	ADC @VIRTUAL04
	ASL
	CLC
	ADC @LOCAL07
	TAX
	LDA __BSS_START__+12,X
	PLX
	STA __BSS_START__,X
	LDX @LOCAL04
	INX
	STX @LOCAL04
@UNKNOWN14:
	TXA
	CMP @VIRTUAL02
	BCC @UNKNOWN11
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::palette_cycle_1_step
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	CMP @VIRTUAL02
	BCCL @PALETTE_SHIFTING_DONE
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA __BSS_START__,X
	JMP @PALETTE_SHIFTING_DONE
@PALETTE_SHIFTING_STYLE3:
	LDY #loaded_bg_data::palette_cycle_1_last
	SEP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
	LDY #loaded_bg_data::palette_cycle_1_first
	SEC
	SBC (@LOCAL07),Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	INC
	STA @LOCAL01
	LDY #0
	STY @LOCAL00
	BRA @UNKNOWN20
@UNKNOWN17:
	LDY #loaded_bg_data::palette_cycle_1_step
	LDA (@LOCAL07),Y
	AND #$00FF
	STA @VIRTUAL04
	LDY @LOCAL00
	TYA
	CLC
	ADC @VIRTUAL04
	STA @VIRTUAL02
	STA @LOCAL03
	LDA @LOCAL01
	ASL
	STA @VIRTUAL04
	LDA @VIRTUAL02
	CMP @VIRTUAL04
	BCC @UNKNOWN18
	LDA @VIRTUAL02
	SEC
	SBC @VIRTUAL04
	STA @VIRTUAL02
	STA @LOCAL03
	BRA @UNKNOWN19
@UNKNOWN18:
	LDA @LOCAL01
	PHA
	LDA @VIRTUAL02
	PLY
	STY @VIRTUAL02
	CMP @VIRTUAL02
	BCC @UNKNOWN19
	LDA @LOCAL03
	STA @VIRTUAL02
	LDA @VIRTUAL04
	DEC
	SEC
	SBC @VIRTUAL02
	STA @VIRTUAL02
	STA @LOCAL03
@UNKNOWN19:
	LDY #loaded_bg_data::palette_cycle_1_first
	LDA (@LOCAL07),Y
	AND #$00FF
	TAX
	LDY @LOCAL00
	STY @VIRTUAL02
	TXA
	CLC
	ADC @VIRTUAL02
	ASL
	LDY #loaded_bg_data::palette_pointer
	CLC
	ADC (@LOCAL07),Y
	PHA
	LDA @LOCAL03
	STA @VIRTUAL02
	TXA
	CLC
	ADC @VIRTUAL02
	ASL
	CLC
	ADC @LOCAL07
	TAX
	LDA __BSS_START__+12,X
	PLX
	STA __BSS_START__,X
	LDY @LOCAL00
	INY
	STY @LOCAL00
@UNKNOWN20:
	LDA @LOCAL01
	STA @VIRTUAL02
	TYA
	CMP @VIRTUAL02
	BCCL @UNKNOWN17
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::palette_cycle_1_step
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA @VIRTUAL00
	INC @VIRTUAL00
	LDA @VIRTUAL00
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL01
	ASL
	STA @VIRTUAL02
	LDA @VIRTUAL00
	AND #$00FF
	CMP @VIRTUAL02
	BCC @PALETTE_SHIFTING_DONE
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA __BSS_START__,X
@PALETTE_SHIFTING_DONE:
	REP #PROC_FLAGS::ACCUM8
	LDA #24
	JSL UNKNOWN_C0856B
@UNKNOWN23:
	LDA GIYGAS_PHASE
	CMP #GIYGAS_PHASES::DEFEATED
	BEQL @RETURN
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::scrolling_duration_left
	TAX
	LDA __BSS_START__,X
	BEQL @UNKNOWN29
	DEC
	STA __BSS_START__,X
	BNEL @UNKNOWN29
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::current_scrolling_movement
	TAX
	STX @LOCAL00
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	AND #$0003
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	CLC
	ADC @LOCAL07
	TAX
	LDA __BSS_START__+78,X
	AND #$00FF
	STA @LOCAL01
	BNE @UNKNOWN27
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	LDX @LOCAL00
	STA __BSS_START__,X
.IF .DEFINED(JPN)
	LDX @LOCAL07
	REP #PROC_FLAGS::ACCUM8
	LDA a:loaded_bg_data::scrolling_movements,X
.ELSE
	LDY #loaded_bg_data::scrolling_movements
	REP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
.ENDIF
	AND #$00FF
	STA @LOCAL01
@UNKNOWN27:
	CMP #0
	BEQL @UNKNOWN29
	LOADPTR BG_SCROLLING_TABLE, @VIRTUAL06
	LDA @LOCAL01
	OPTIMIZED_MULT @VIRTUAL04, 10
	STA @LOCAL02
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::scrolling_duration_left
	STA (@LOCAL07),Y
	LDA @LOCAL02
	;bg_scrolling_entry::horizontal_movement
	INC
	INC
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::horizontal_velocity
	STA (@LOCAL07),Y
	LDA @LOCAL02
	;bg_scrolling_entry::vertical_movement
	INC
	INC
	INC
	INC
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::vertical_velocity
	STA (@LOCAL07),Y
	LDA @LOCAL02
	CLC
	ADC #bg_scrolling_entry::horizontal_acceleration
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::horizontal_acceleration
	STA (@LOCAL07),Y
	LDA @LOCAL02
	CLC
	ADC #bg_scrolling_entry::vertical_acceleration
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	LDY #loaded_bg_data::vertical_acceleration
	STA (@LOCAL07),Y
@UNKNOWN29:
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::horizontal_position
	STA @VIRTUAL02
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::horizontal_velocity
	TAX
	LDY #loaded_bg_data::horizontal_acceleration
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	STA __BSS_START__,X
	STA @VIRTUAL04
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	CLC
	ADC @VIRTUAL04
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::vertical_position
	TAY
	STY @LOCAL04
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::vertical_velocity
	TAX
	LDY #loaded_bg_data::vertical_acceleration
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	STA __BSS_START__,X
	STA @VIRTUAL04
	LDY @LOCAL04
	LDA __BSS_START__,Y
	CLC
	ADC @VIRTUAL04
	STA __BSS_START__,Y
	LDA @LOCAL06
	CMP #BG_LAYER::LAYER_1
	BEQ @AFFECT_LAYER_1
	CMP #BG_LAYER::LAYER_2
	BEQ @AFFECT_LAYER_2
	CMP #BG_LAYER::LAYER_3
	BEQ @AFFECT_LAYER_3
	CMP #BG_LAYER::LAYER_4
	BEQ @AFFECT_LAYER_4
	JMP @TARGET_BG_LAYER_SELECTION_COMPLETE
@AFFECT_LAYER_1:
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_HORIZONTAL_OFFSET
	STA BG1_X_POS
	LDA __BSS_START__,Y
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_VERTICAL_OFFSET
	STA BG1_Y_POS
	BRA @TARGET_BG_LAYER_SELECTION_COMPLETE
@AFFECT_LAYER_2:
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_HORIZONTAL_OFFSET
	STA BG2_X_POS
	LDA __BSS_START__,Y
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_VERTICAL_OFFSET
	STA BG2_Y_POS
	BRA @TARGET_BG_LAYER_SELECTION_COMPLETE
@AFFECT_LAYER_3:
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_HORIZONTAL_OFFSET
	STA BG3_X_POS
	LDA __BSS_START__,Y
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_VERTICAL_OFFSET
	STA BG3_Y_POS
	BRA @TARGET_BG_LAYER_SELECTION_COMPLETE
@AFFECT_LAYER_4:
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_HORIZONTAL_OFFSET
	STA BG4_X_POS
	LDA __BSS_START__,Y
	XBA
	AND #$00FF
	CLC
	ADC SCREEN_EFFECT_VERTICAL_OFFSET
	STA BG4_Y_POS
@TARGET_BG_LAYER_SELECTION_COMPLETE:
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_duration_left
	TAX
	LDA __BSS_START__,X
	BEQL @DISTORTION_DMA_DONE
	DEC
	STA __BSS_START__,X
	BNEL @DISTORTION_DMA_DONE
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::current_distortion_style_index
	TAX
	STX @LOCAL00
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	AND #$0003
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	CLC
	ADC @LOCAL07
	TAX
	LDA a:loaded_bg_data::distortion_styles,X
	AND #$00FF
	STA @LOCAL01
	BNE @UNKNOWN37
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	LDX @LOCAL00
	STA __BSS_START__,X
.IF .DEFINED(JPN)
	LDX @LOCAL07
	REP #PROC_FLAGS::ACCUM8
	LDA a:loaded_bg_data::distortion_styles,X
.ELSE
	LDY #loaded_bg_data::distortion_styles
	REP #PROC_FLAGS::ACCUM8
	LDA (@LOCAL07),Y
.ENDIF
	AND #$00FF
	STA @LOCAL01
@UNKNOWN37:
	CMP #0
	BEQL @DISTORTION_DMA_DONE
	LOADPTR BG_DISTORTION_TABLE, @VIRTUAL06
	LDA @LOCAL01
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(distortion_entry)
	STA @LOCAL01
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_duration_left
	STA (@LOCAL07),Y
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_type
	TAX
	LDA @LOCAL01
	;style
	INC
	INC
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL0A]
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL01
	;ripple_frequency
	INC
	INC
	INC
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_ripple_frequency
	STA (@LOCAL07),Y
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::ripple_amplitude
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_ripple_amplitude
	STA (@LOCAL07),Y
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::speed
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_speed
	STA (@LOCAL07),Y
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::compression_rate
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_compression_rate
	STA (@LOCAL07),Y
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::ripple_frequency_acceleration
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_ripple_frequency_acceleration
	STA (@LOCAL07),Y
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::ripple_amplitude_acceleration
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_ripple_amplitude_acceleration
	STA (@LOCAL07),Y
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::speed_acceleration
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL0A]
	LDY #loaded_bg_data::distortion_speed_acceleration
	STA (@LOCAL07),Y
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL01
	CLC
	ADC #distortion_entry::compression_acceleration
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	LDY #loaded_bg_data::distortion_compression_acceleration
	STA (@LOCAL07),Y
	LDA __BSS_START__,X
	AND #$00FF
	CMP #DISTORTION_STYLE::VERTICAL_SMOOTH
	BNE @HORIZONTAL_DISTORTION
	LDY @LOCAL08
	LDX @LOCAL06
	INX
	INX
	INX
	INX
	LDA @LOCAL08
	CLC
	ADC #5
	JSL DO_BATTLEBG_DMA
	BRA @DISTORTION_DMA_DONE
@HORIZONTAL_DISTORTION:
	LDY @LOCAL08
	LDX @LOCAL06
	LDA @LOCAL08
	CLC
	ADC #5
	JSL DO_BATTLEBG_DMA
@DISTORTION_DMA_DONE:
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_type
	STA @LOCAL00
	TAX
	LDA __BSS_START__,X
	AND #$00FF
	BEQL @RETURN
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_ripple_frequency
	TAX
	LDY #loaded_bg_data::distortion_ripple_frequency_acceleration
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	STA __BSS_START__,X
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_ripple_amplitude
	TAX
	LDY #loaded_bg_data::distortion_ripple_amplitude_acceleration
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	STA __BSS_START__,X
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_speed
	TAX
	LDY #loaded_bg_data::distortion_speed_acceleration
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL07
	CLC
	ADC #loaded_bg_data::distortion_compression_rate
	STA @VIRTUAL02
	LDY #loaded_bg_data::distortion_compression_acceleration
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	CLC
	ADC (@LOCAL07),Y
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDY @LOCAL08
	LDX @LOCAL06
	STX @LOCAL03
	LDA @LOCAL00
	TAX
	LDA __BSS_START__,X
	AND #$00FF
	DEC
	LDX @LOCAL03
	JSL LOAD_BG_OFFSET_PARAMETERS
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	JSL LOAD_BG_OFFSET_PARAMETERS2
	LDA FRAME_COUNTER
	AND #$00FF
	AND #$0001
	CMP @LOCAL08
	BEQ @PREPARE_BG_OFFSETS
	LDA DISTORT_30FPS
	BNE @RETURN
@PREPARE_BG_OFFSETS:
	LDY #loaded_bg_data::distortion_speed
	LDA (@LOCAL07),Y
	AND #$00FF
	TAY
	STY @LOCAL01
	LDY #loaded_bg_data::distortion_ripple_amplitude
	LDA (@LOCAL07),Y
	XBA
	AND #$00FF
	TAX
	LDY #loaded_bg_data::distortion_ripple_frequency
	LDA (@LOCAL07),Y
	LDY @LOCAL01
	JSL PREPARE_BG_OFFSET_TABLES
@RETURN:
	END_C_FUNCTION
