
;void LoadMapAtSector(int sector_x, int sector_y)
LOAD_MAP_AT_SECTOR:
	BEGIN_C_FUNCTION
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16 ;int x
	STACK_RESERVE_PARAM_INT16 ;int y
	END_STACK_VARS
	STA @LOCAL04
	LDA CURRENT_TELEPORT_DESTINATION_X
	ORA CURRENT_TELEPORT_DESTINATION_Y
	BEQ @UNKNOWN0
	LDA CURRENT_TELEPORT_DESTINATION_X
	LSR
	LSR
	LSR
	LSR
	LSR
	STA @LOCAL04
	LDA CURRENT_TELEPORT_DESTINATION_Y
	LSR
	LSR
	LSR
	LSR
	TAX
@UNKNOWN0:
	LDA @LOCAL04
	STA @VIRTUAL02
	TXA
	ASL
	ASL
	ASL
	ASL
	ASL
	CLC
	ADC @VIRTUAL02
	TAX
	LDA f:GLOBAL_MAP_TILESETPALETTE_DATA,X
	AND #$00FF
	STA @LOCAL04
	AND #$0007
	STA @LOCAL03
	LDA @LOCAL04
	LSR
	LSR
	LSR
	STA @VIRTUAL04
	ASL
	TAX
	LDA f:TILESET_TABLE,X
	TAY
	STY @LOCAL02
	TYA
	ASL
	ASL
	STA @VIRTUAL02
	LOADPTR MAP_DATA_TILE_ARRANGEMENT_PTR_TABLE, @VIRTUAL0A
	LDA @VIRTUAL02
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LOADPTR BUFFER + $8000, @LOCAL01
	JSL DECOMP
	LDY @LOCAL02
	TYA
	JSR LOAD_TILE_COLLISION
	LDY @LOCAL02
	TYA
	JSL UNKNOWN_C006F2
	JSL UNKNOWN_C005E7
	LOADPTR SPRITE_GROUP_PALETTES, @LOCAL00
	LDX #BPP4PALETTE_SIZE * 8
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 8
	JSL MEMCPY16
	LDA @VIRTUAL04
	CMP LOADED_MAP_TILE_COMBO
	BEQ @UNKNOWN3
	LDY @LOCAL02
	STY LOADED_MAP_TILESET
	LOADPTR MAP_DATA_TILESET_PTR_TABLE, @VIRTUAL0A
	LDA @VIRTUAL02
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LOADPTR BUFFER, @LOCAL01
	JSL DECOMP
@UNKNOWN1:
	LDA FADE_PARAMETERS + fade_parameters::step
	AND #$00FF
	BNE @UNKNOWN1
	LDA PHOTOGRAPH_MAP_LOADING_MODE
	BNE @UNKNOWN2
	COPY_TO_VRAM3 BUFFER, $0000, $7000, 0
	BRA @UNKNOWN3
@UNKNOWN2:
	.A16
	COPY_TO_VRAM3 BUFFER, $0000, $4000, 0
@UNKNOWN3:
	.A16
	LDA FADE_PARAMETERS + fade_parameters::step
	AND #$00FF
	BNE @UNKNOWN3
	LDX @LOCAL03
	LDA @VIRTUAL04
	JSL LOAD_MAP_PAL
	JSL UNKNOWN_C00480
	JSL LOAD_SPECIAL_SPRITE_PALETTE
	LDA PHOTOGRAPH_MAP_LOADING_MODE
	BNE @UNKNOWN4
	JSL LOAD_OVERLAY_SPRITES
	JSR LOAD_TILESET_ANIM
	JSR LOAD_PALETTE_ANIM
@UNKNOWN4:
	LDA PHOTOGRAPH_MAP_LOADING_MODE
	BNE @UNKNOWN7
	LDA DEBUG
	BEQ @UNKNOWN5
	JSL UNKNOWN_EFD9F3
	BRA @UNKNOWN6
@UNKNOWN5:
	JSL UNKNOWN_C47F87
@UNKNOWN6:
	LDA #0
	JSL UNKNOWN_C0856B
@UNKNOWN7:
	.A16
	PROMOTENEARPTR PALETTES, @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	LDA #64
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDX #BPP4PALETTE_SIZE * 14
	LDA #.LOWORD(MAP_PALETTE_BACKUP)
	JSL MEMCPY16
	LDA WIPE_PALETTES_ON_MAP_LOAD
	BEQ @UNKNOWN8
	JSL UNKNOWN_C496F9
	SEP #PROC_FLAGS::ACCUM8
	LDA #$00FF
	STA @LOCAL00
	LDX #BPP4PALETTE_SIZE * 16
	REP #PROC_FLAGS::ACCUM8
	LDA #.LOWORD(PALETTES)
	JSL MEMSET16
	STZ WIPE_PALETTES_ON_MAP_LOAD
@UNKNOWN8:
	LDA PHOTOGRAPH_MAP_LOADING_MODE
	BEQ @UNKNOWN9
	JSL UNKNOWN_C496F9
	SEP #PROC_FLAGS::ACCUM8
	STZ_BADOPT @LOCAL00
	LDX #BPP4PALETTE_SIZE * 15
	REP #PROC_FLAGS::ACCUM8
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 1
	JSL MEMSET16
@UNKNOWN9:
	LDA #24
	JSL UNKNOWN_C0856B
	LDA @VIRTUAL04
	STA LOADED_MAP_TILE_COMBO
	LDA @LOCAL03
	STA LOADED_MAP_PALETTE
	END_C_FUNCTION
