
CLOSE_WINDOW:
.IF .DEFINED(JPN)
	BEGIN_C_FUNCTION
.ELSE
	BEGIN_C_FUNCTION_FAR
.ENDIF
	STACK_RESERVE_VARS
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16
	END_STACK_VARS
	STA @LOCAL04
	CMP #.LOWORD(-1)
	BEQL @UNKNOWN18
	LDA @LOCAL04
	ASL
	TAX
	LDA OPEN_WINDOW_TABLE,X
	STA @VIRTUAL04
	CMP #.LOWORD(-1)
	BEQL @UNKNOWN18
	LDA CURRENT_FOCUS_WINDOW
	CMP @LOCAL04
	BNE @UNKNOWN2
	LDA #.LOWORD(-1)
	STA CURRENT_FOCUS_WINDOW
@UNKNOWN2:
	LDA @LOCAL04
	JSR UNKNOWN_C3E7E3
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	LDY WINDOW_STATS + window_stats::next,X
	STY @LOCAL03
	LDA WINDOW_STATS + window_stats::prev,X
	STA @LOCAL02
	CPY #.LOWORD(-1)
	BNE @UNKNOWN3
	STA WINDOW_TAIL
	BRA @UNKNOWN4
@UNKNOWN3:
	TYA
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	LDA @LOCAL02
	STA WINDOW_STATS + window_stats::prev,X
@UNKNOWN4:
	CMP #.LOWORD(-1)
	BNE @UNKNOWN5
	LDY @LOCAL03
	STY WINDOW_HEAD
	BRA @UNKNOWN6
@UNKNOWN5:
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	LDY @LOCAL03
	TYA
	STA WINDOW_STATS + window_stats::next,X
@UNKNOWN6:
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	STX @LOCAL01
	LDA #.LOWORD(-1)
	STA WINDOW_STATS + window_stats::id,X
	LDA @LOCAL04
	ASL
	TAX
	LDA #.LOWORD(-1)
	STA OPEN_WINDOW_TABLE,X
	LDX @LOCAL01
	LDA WINDOW_STATS + window_stats::window_x,X
	ASL
	STA @VIRTUAL02
	LDA WINDOW_STATS + window_stats::window_y,X
	OPTIMIZED_MULT @VIRTUAL04, 64
	CLC
	ADC @VIRTUAL02
	CLC
	ADC #.LOWORD(BG2_BUFFER)
.IF .DEFINED(JPN)
	TAY
	STY @LOCAL00
	LDA #0
	STA @VIRTUAL02
	STA @LOCAL01
.ELSE
	STA @VIRTUAL02
	STA @LOCAL00
	LDY WINDOW_STATS + window_stats::tilemap_address,X
	STY @LOCAL03
	LDX #0
	STX @LOCAL01
	BRA @UNKNOWN10
@UNKNOWN7:
	LDY @LOCAL03
	LDA __BSS_START__,Y
	CMP #64
	BNE @UNKNOWN8
	CMP #0
	BEQ @UNKNOWN9
@UNKNOWN8:
	LDA __BSS_START__,Y
	JSL FREE_TILE
@UNKNOWN9:
	LDA #64
	LDY @LOCAL03
	STA __BSS_START__,Y
	INY
	INY
	STY @LOCAL03
	LDX @LOCAL01
	INX
	STX @LOCAL01
@UNKNOWN10:
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	LDY WINDOW_STATS + window_stats::width,X
	TAX
	LDA WINDOW_STATS + window_stats::height,X
	JSL MULT16
	STA @VIRTUAL02
	LDX @LOCAL01
	TXA
	CMP @VIRTUAL02
	BCC @UNKNOWN7
	LDY #0
	STY @LOCAL01
.ENDIF
	BRA @UNKNOWN14
@UNKNOWN11:
.IF .DEFINED(JPN)
	LDX #0
	STX @LOCAL03
.ELSE
	LDA #0
	STA @LOCAL02
.ENDIF
	BRA @UNKNOWN13
@UNKNOWN12:
.IF .DEFINED(JPN)
	LDA #0
	LDY @LOCAL00
	STA __BSS_START__,Y
	INY
	INY
	STY @LOCAL00
	INX
	STX @LOCAL03
.ELSE
	LDA #0
	LDX @LOCAL00
	STX @VIRTUAL02
	STA __BSS_START__,X
	INC @VIRTUAL02
	INC @VIRTUAL02
	LDA @VIRTUAL02
	STA @LOCAL00
	LDA @LOCAL02
	INC
	STA @LOCAL02
.ENDIF
@UNKNOWN13:
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	LDA WINDOW_STATS + window_stats::width,X
.IF .DEFINED(JPN)
	STA @LOCAL02
	STA @VIRTUAL02
.ELSE
	TAX
	STX @VIRTUAL02
.ENDIF
	INC @VIRTUAL02
	INC @VIRTUAL02
.IF .DEFINED(JPN)
	LDX @LOCAL03
	TXA
	CMP @VIRTUAL02
.ELSE
	LDA @LOCAL02
	CMP @VIRTUAL02
.ENDIF
	BNE @UNKNOWN12
.IF .DEFINED(JPN)
	LDA @LOCAL02
	STA @VIRTUAL02
.ELSE
	STX @VIRTUAL02
.ENDIF
	LDA #32
	SEC
	SBC @VIRTUAL02
	DEC
	DEC
	ASL
.IF .DEFINED(JPN)
	STA @VIRTUAL02
	LDY @LOCAL00
	TYA
.ELSE
	PHA
	LDA @LOCAL00
	STA @VIRTUAL02
	PLY
	STY @VIRTUAL02
.ENDIF
	CLC
	ADC @VIRTUAL02
.IF .DEFINED(JPN)
	TAY
	STY @LOCAL00
	LDA @LOCAL01
	STA @VIRTUAL02
	INC @VIRTUAL02
	LDA @VIRTUAL02
	STA @LOCAL01
.ELSE
	STA @VIRTUAL02
	STA @LOCAL00
	LDY @LOCAL01
	INY
	STY @LOCAL01
.ENDIF
@UNKNOWN14:
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
.IF .DEFINED(JPN)
	LDA @VIRTUAL02
	PHA
.ELSE
	STX @LOCAL02
.ENDIF
	LDA WINDOW_STATS + window_stats::height,X
	STA @VIRTUAL02
	INC @VIRTUAL02
	INC @VIRTUAL02
.IF .DEFINED(JPN)
	PLA
.ELSE
	LDY @LOCAL01
	TYA
.ENDIF
	CMP @VIRTUAL02
	BNE @UNKNOWN11
.IF .DEFINED(USA)
	JSL UNKNOWN_C45E96
	LDX @LOCAL02
.ENDIF
	LDA WINDOW_STATS + window_stats::unknown59,X
	AND #$00FF
	BEQ @UNKNOWN15
	AND #$00FF
	DEC
	ASL
	TAX
	LDA #.LOWORD(-1)
	STA TITLED_WINDOWS,X
@UNKNOWN15:
	LDA @VIRTUAL04
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	TAX
	SEP #PROC_FLAGS::ACCUM8
	STZ WINDOW_STATS + window_stats::unknown59,X
	LDA #1
	STA REDRAW_ALL_WINDOWS
	REP #PROC_FLAGS::ACCUM8
	LDA PAGINATION_WINDOW
	CMP @LOCAL04
	BNE @UNKNOWN16
	LDA #.LOWORD(-1)
	STA PAGINATION_WINDOW
@UNKNOWN16:
.IF .DEFINED(USA)
	LDA EXTRA_TICK_ON_WINDOW_CLOSE
	AND #$00FF
	BNE @UNKNOWN17
	JSL WINDOW_TICK_WITHOUT_INSTANT_PRINTING
	JSL CLEAR_INSTANT_PRINTING
@UNKNOWN17:
.IF !.DEFINED(PROTOTYPE19950327)
	SEP #PROC_FLAGS::ACCUM8
	STZ VWF_INDENT_NEW_LINE
.ENDIF
.ENDIF
@UNKNOWN18:
.IF .DEFINED(USA) && (!.DEFINED(PROTOTYPE19950327))
	REP #PROC_FLAGS::ACCUM8
.ENDIF
	END_C_FUNCTION
