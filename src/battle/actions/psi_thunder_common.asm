
PSI_THUNDER_COMMON:
	BEGIN_C_FUNCTION
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16
	STACK_RESERVE_PARAM_INT16
	END_STACK_VARS
	STX @LOCAL04
	STA @VIRTUAL04
	LDY #0
	STY @LOCAL03
	TYX
	STX @LOCAL02
	BRA @UNKNOWN2
@UNKNOWN0:
	TXA
	JSL IS_CHAR_TARGETTED
	CMP #0
	BEQ @UNKNOWN1
	LDY @LOCAL03
	INY
	STY @LOCAL03
@UNKNOWN1:
	LDX @LOCAL02
	INX
	STX @LOCAL02
@UNKNOWN2:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN0
	LDY @LOCAL03
	TYA
	OPTIMIZED_MULT @VIRTUAL04, 64
	STA @VIRTUAL02
	CMP #256
	BCC @UNKNOWN3
	LDA #255
	STA @VIRTUAL02
@UNKNOWN3:
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	LDY #0
	STY @LOCAL03
	JMP @UNKNOWN20
@UNKNOWN4:
	MOVE_INT @LOCAL01, @VIRTUAL06
	MOVE_INT @VIRTUAL06, BATTLER_TARGET_FLAGS
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
	LDA #0
	STA @VIRTUAL06
	LDA #0
	STA @VIRTUAL06+2
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL0A
	CMP @VIRTUAL06+2
	BNE @UNKNOWN5
	LDA @VIRTUAL0A
	CMP @VIRTUAL06
@UNKNOWN5:
	BEQL @UNKNOWN21
.IF .DEFINED(JPN)
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL0A
	MOVE_INT @VIRTUAL0A, @LOCAL00
.ELSE
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
.ENDIF
	JSL RANDOM_TARGETTING
	MOVE_INT @VIRTUAL06, @VIRTUAL0A
	MOVE_INT @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, BATTLER_TARGET_FLAGS
	LDX #0
	STX @LOCAL02
	BRA @UNKNOWN8
@UNKNOWN7:
	TXA
	JSL IS_CHAR_TARGETTED
	CMP #0
	BNE @UNKNOWN9
	LDX @LOCAL02
	INX
	STX @LOCAL02
@UNKNOWN8:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN7
@UNKNOWN9:
	LDX @LOCAL02
	TXA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDA @VIRTUAL02
	SEP #PROC_FLAGS::ACCUM8
	JSR SUCCESS_255
	.A16
	CMP #0
	BEQL @UNKNOWN18
	.A16
	LDA @VIRTUAL04
	CMP #120
	BNE @UNKNOWN11
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_THUNDER_SMALL
	BRA @UNKNOWN13
@UNKNOWN11:
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_THUNDER_LARGE
	BRA @UNKNOWN13
@UNKNOWN12:
	JSL WINDOW_TICK
@UNKNOWN13:
	JSL UNKNOWN_C2EACF
	CMP #0
	BNE @UNKNOWN12
	LDX CURRENT_TARGET
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::use_alt_spritemap,X
	LDX CURRENT_TARGET
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN14
	LDX #1
	STX @LOCAL02
	LDX CURRENT_TARGET
	LDA a:battler::row,X
	AND #$00FF
	INC
	LDX @LOCAL02
	JSL FIND_ITEM_IN_INVENTORY2
	CMP #0
	BEQ @UNKNOWN14
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_FRANKLIN_TURN
	LDA #1
	STA DAMAGE_IS_REFLECTED
	JSR SWAP_ATTACKER_WITH_TARGET
@UNKNOWN14:
	LDX CURRENT_TARGET
	LDA a:battler::afflictions + STATUS_GROUP::SHIELD,X
	AND #$00FF
	TAX
	CPX #1
	BEQ @UNKNOWN15
	CPX #2
	BNE @UNKNOWN16
@UNKNOWN15:
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	LDX CURRENT_TARGET
	STA a:battler::shield_hp,X
@UNKNOWN16:
	JSR PSI_SHIELD_NULLIFY
	.A16
	CMP #0
	BNE @UNKNOWN17
	LDA @VIRTUAL04
	JSR FIFTY_PERCENT_VARIANCE
	LDX #$00FF
	JSR CALC_RESIST_DAMAGE
@UNKNOWN17:
	JSR WEAKEN_SHIELD
	BRA @UNKNOWN19
@UNKNOWN18:
	.A16
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_THUNDER_MISS_SE
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_KAMINARI_HAZURE
@UNKNOWN19:
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BEQ @UNKNOWN21
	LDA #1
	JSL COUNT_CHARS
	CMP #0
	BEQ @UNKNOWN21
	LDY @LOCAL03
	INY
	STY @LOCAL03
@UNKNOWN20:
	CPY @LOCAL04
	BCCL @UNKNOWN4
@UNKNOWN21:
	MOVE_INT_CONSTANT 0, BATTLER_TARGET_FLAGS
	END_C_FUNCTION
