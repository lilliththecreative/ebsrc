
<<<<<<< HEAD
BATTLE_ROUTINE:
	BEGIN_C_FUNCTION_FAR
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT8
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_RETURN_INT16 ;bool
	END_STACK_VARS
	LDA BATTLE_MODE
=======
BATTLE_ROUTINE: ;$C24821
	REP #PROC_FLAGS::ACCUM8 | PROC_FLAGS::INDEX8 | PROC_FLAGS::CARRY
	RESERVE_STACK_SPACE_CLOBBER 55
	LDA BATTLE_DEBUG
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	BNE @UNKNOWN0
	LDA #$0001
	STA $35
	STA $33
	SEP #PROC_FLAGS::ACCUM8
	STA GAME_STATE+game_state::player_controlled_party_count
	LDY #.LOWORD(GAME_STATE) + game_state::party_members
	STY $31
	STZ $0E
	LDX #$0006
	REP #PROC_FLAGS::ACCUM8
	TYA
	JSL MEMSET16
	LDA #.LOWORD(GAME_STATE) + game_state::unknown96
	STA $02
	SEP #PROC_FLAGS::ACCUM8
	STZ $0E
	LDX #$0006
	REP #PROC_FLAGS::ACCUM8
	LDA $02
	JSL MEMSET16
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	LDY $31
	STA __BSS_START__,Y
	LDX $02
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA ENEMIES_IN_BATTLE
	STA CURRENT_BATTLE_GROUP
<<<<<<< HEAD
	MOVE_INT f:BTL_ENTRY_PTR_TABLE+.SIZEOF(battle_entry_ptr_entry)+battle_entry_ptr_entry::pointer, @VIRTUAL06
	LDY #1
	LDA [@VIRTUAL06],Y
	STA ENEMIES_IN_BATTLE_IDS
=======
	MOVE_INT f:BTL_ENTRY_PTR_TABLE+.SIZEOF(battle_entry_ptr_entry)+battle_entry_ptr_entry::pointer, $06
	LDY #$0001
	LDA [$06],Y
	STA UNKNOWN_7E9F8C
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
@UNKNOWN0:
	STZ GIYGAS_PHASE
	LDA CURRENT_BATTLE_GROUP
	CMP #$01DB
	BNE @UNKNOWN1
	LDA #GIYGAS_PHASES::BATTLE_STARTED
	STA GIYGAS_PHASE
@UNKNOWN1:
	LOADPTR BTL_ENTRY_BG_TABLE, $06
	LDA CURRENT_BATTLE_GROUP
	ASL
	ASL
	STA $2F
	MOVE_INTX $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	STA $2D
	LDA $2F
	INC
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	STA $2B
	LDA CURRENT_BATTLE_GROUP
	ASL
	ASL
	ASL
	CLC
	ADC #battle_entry_ptr_entry::letterbox_style
	TAX
	LDA f:BTL_ENTRY_PTR_TABLE,X
	AND #$00FF
	STA $29
@UNKNOWN2:
	REP #PROC_FLAGS::ACCUM8
	STZ MIRROR_ENEMY
	STZ $27
	SEP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
	STZ BATTLE_ITEM_USED ;huh... usually mother 2 optimizes this worse
	REP #PROC_FLAGS::ACCUM8
	STZ @LOCAL0B
.ELSE
	STZ @LOCAL0B
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA BATTLE_ITEM_USED
=======
	LDA #$0000
	STA UNKNOWN_7EA97C
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	REP #PROC_FLAGS::ACCUM8
	STZ $25
	STZ BATTLE_MONEY_SCRATCH
	MOVE_INT_CONSTANT 0, BATTLE_EXP_SCRATCH
	JSL UNKNOWN_C08726
	JSL UNKNOWN_C2E0E7
	JSL LOAD_ENEMY_BATTLE_SPRITES
	JSL LOAD_WINDOW_GFX
<<<<<<< HEAD
.IF .DEFINED(JPN)
	COPY_TO_VRAM1 BUFFER, $6000, $3800, $00
	LDY @LOCAL0D
	LDX @LOCAL0F
.ELSE
	LDA #1
=======
	LDA #$0001
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	JSL UNKNOWN_C44963
	LDY $29
	LDX $2B
	LDA $2D
	JSL LOAD_BATTLE_BG
	JSL UNKNOWN_C2EEE7
	LDY #$0000
	STY $31
	BRA @UNKNOWN4
@UNKNOWN3:
	SEP #PROC_FLAGS::ACCUM8
	STZ $0E
	LDX #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	TYA
	TXY
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	JSL MEMSET16
	LDY $31
	INY
	STY $31
@UNKNOWN4:
	CPY #BATTLER_COUNT
	BCC @UNKNOWN3
<<<<<<< HEAD
	STZ HIGHEST_ENEMY_LEVEL_IN_BATTLE
	LDY #0
	STY @LOCAL09
	STZ @LOCAL10
=======
	STZ UNKNOWN_7EAA0C
	LDY #$0000
	STY $23
	STZ $31
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	JMP @UNKNOWN9
@UNKNOWN5:
	LDY #.LOWORD(GAME_STATE) + game_state::party_members
	LDA ($31),Y
	AND #$00FF
	STA $04
	STA $21
	LDA $04
	BEQ @UNKNOWN7
	LDA $04
	CMP #$0004
	BGT @UNKNOWN7
	LDA $31
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	LDA $04
	JSL BATTLE_INIT_PLAYER_STATS
	BRA @UNKNOWN8
@UNKNOWN7:
	LDA $04
	CMP #$0005
	BCC @UNKNOWN8
	LDA $31
	LDY #.SIZEOF(battler)
	JSL MULT168
	STA $02
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	STX $1F
	LDA $04
	ASL
	TAX
	INX
	LDA f:NPC_AI_TABLE,X
	AND #$00FF
	LDX $1F
	JSL BATTLE_INIT_ENEMY_STATS
	LDX $02
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::ally_or_enemy,X
	REP #PROC_FLAGS::ACCUM8
	LDA $04
	SEP #PROC_FLAGS::ACCUM8
	LDX $02
	STA BATTLERS_TABLE+battler::npc_id,X
	LDY $23
	REP #PROC_FLAGS::ACCUM8
	TYA
	SEP #PROC_FLAGS::ACCUM8
	LDX $02
	STA BATTLERS_TABLE+16,X
	REP #PROC_FLAGS::ACCUM8
	TYA
	ASL
	TAX
	LDA GAME_STATE+game_state::party_npc_1_hp,X
	LDX $02
	STA BATTLERS_TABLE+battler::hp_target,X
	LDX $02
	STA BATTLERS_TABLE+battler::hp,X
	INY
	STY $23
	LDX $02
	STZ BATTLERS_TABLE+battler::pp_target,X
	LDX $02
	STZ BATTLERS_TABLE+battler::pp,X
@UNKNOWN8:
	INC $31
@UNKNOWN9:
	LDA $31
	CMP #$0006
	BCCL @UNKNOWN5
	JSL UNKNOWN_C2F0D1
	LDY #$0000
	STY $31
	BRA @UNKNOWN12
@UNKNOWN11:
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE) + (.SIZEOF(battler) * 8)
	TAX
	STX $1F
	LDY $31
	TYA
	ASL
	TAX
<<<<<<< HEAD
	LDA ENEMIES_IN_BATTLE_IDS,X
	LDX @LOCAL07
=======
	LDA UNKNOWN_7E9F8C,X
	LDX $1F
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	JSL BATTLE_INIT_ENEMY_STATS
	LDY $31
	INY
	STY $31
@UNKNOWN12:
	CPY ENEMIES_IN_BATTLE
	BCC @UNKNOWN11
	JSL UNKNOWN_C2F121
	JSL UNKNOWN_C2F8F9
	JSL UNKNOWN_C47F87
	LDA #$0018
	JSL UNKNOWN_C0856B
	LDA #$0001
	STA BATTLE_MODE_FLAG
	LDA ENEMIES_IN_BATTLE_IDS
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::music
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	JSL CHANGE_MUSIC
	JSL UNKNOWN_C08744
	LDX #$0001
	TXA
	JSL FADE_IN
	LDA BATTLE_MODE
	BNEL @UNKNOWN40
	LDA $35
	JSL UNKNOWN_C1DCCB
	LDA #$0000
	STA $02
	TAY
	STY $31
	JMP @UNKNOWN19
@UNKNOWN14:
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE + game_state::party_members,Y
	AND #$00FF
	STA $04
	STA $21
	LDA $04
	BEQ @UNKNOWN16
	LDA $04
	CMP #$0004
	BGT @UNKNOWN16
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	LDA $04
	JSL BATTLE_INIT_PLAYER_STATS
	JMP @UNKNOWN18
@UNKNOWN16:
	LDA $04
	CMP #$0005
	BCCL @UNKNOWN18
	LOADPTR NPC_AI_TABLE, $06
	LDA $04
	ASL
	STA $1D
	MOVE_INTX $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	AND #$00FF
	AND #$0001
	BEQ @UNKNOWN18
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	STA $23
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	LDA $1D
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	JSL BATTLE_INIT_ENEMY_STATS
	LDA $02
	SEP #PROC_FLAGS::ACCUM8
	LDY #.LOWORD(BATTLERS_TABLE) + battler::row
	STA ($23),Y
	REP #PROC_FLAGS::ACCUM8
	LDA $02
	ASL
	TAX
	LDA GAME_STATE+game_state::party_npc_1_hp,X
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp_target
	STA ($23),Y
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp
	STA ($23),Y
	INC $02
	LDX $23
	STZ BATTLERS_TABLE+battler::pp_target,X
	LDX $23
	STZ BATTLERS_TABLE+battler::pp,X
	LDX $23
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::ally_or_enemy,X
	REP #PROC_FLAGS::ACCUM8
	LDA $04
	SEP #PROC_FLAGS::ACCUM8
	LDY #.LOWORD(BATTLERS_TABLE) + battler::npc_id
	STA ($23),Y
@UNKNOWN18:
	LDY $31
	INY
	STY $31
@UNKNOWN19:
	CPY #$0006
	BCCL @UNKNOWN14
	JSL REDIRECT_SHOW_HPPP_WINDOWS
	JSL WINDOW_TICK
@UNKNOWN21:
	.A16
	JSL WAIT_UNTIL_NEXT_FRAME
	JSL UNKNOWN_C2DB3F
	LDA PAD_PRESS
	AND #PAD::START_BUTTON
	BNEL @UNKNOWN39
	LDA PAD_PRESS
	AND #PAD::SELECT_BUTTON
	BEQ @UNKNOWN23
	LDA CURRENT_BATTLE_GROUP
	JSL ENEMY_SELECT_MODE
	STA $31
	STA CURRENT_BATTLE_GROUP
	LOADPTR BTL_ENTRY_BG_TABLE, $06
	LDA $31
	ASL
	ASL
	TAX
	MOVE_INTY $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	STA $2D
	TXA
	INC
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	STA $2B
	LDA $31
	ASL
	ASL
	ASL
	CLC
	ADC #battle_entry_ptr_entry::letterbox_style
	TAX
	LDA f:BTL_ENTRY_PTR_TABLE,X
	AND #$00FF
	STA $29
	JMP @UNKNOWN32
@UNKNOWN23:
	LDA PAD_HELD
	AND #PAD::RIGHT
	BEQ @UNKNOWN24
	LDA $33
	CMP #$000F
	BCS @UNKNOWN25
	INC $33
	JMP @UNKNOWN32
@UNKNOWN24:
	LDA PAD_HELD
	AND #PAD::LEFT
	BEQ @UNKNOWN25
	LDA $33
	CMP #$0001
	BLTEQ @UNKNOWN25
	DEC $33
	JMP @UNKNOWN32
@UNKNOWN25:
	LDA PAD_HELD
	AND #PAD::DOWN
	BEQ @UNKNOWN26
	LDA $35
	CMP #$0001
	BLTEQ @UNKNOWN27
	DEC $35
	BRA @UNKNOWN32
@UNKNOWN26:
	LDA PAD_HELD
	AND #PAD::UP
	BEQ @UNKNOWN27
	LDA $35
	CMP #MAX_LEVEL
	BCS @UNKNOWN27
	INC $35
	BRA @UNKNOWN32
@UNKNOWN27:
	LDA PAD_PRESS
	AND #PAD::X_BUTTON
	BEQ @UNKNOWN28
<<<<<<< HEAD
	LDA HIGHEST_ENEMY_LEVEL_IN_BATTLE
	STA @LOCAL12
=======
	LDA UNKNOWN_7EAA0C
	STA $35
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	BRA @UNKNOWN32
@UNKNOWN28:
	LDA PAD_PRESS
	AND #PAD::A_BUTTON
	BEQ @UNKNOWN29
	LDA DEBUGGING_CURRENT_PSI_ANIMATION
	JSL SHOW_PSI_ANIMATION
	LDX DEBUGGING_CURRENT_PSI_ANIMATION
	INX
<<<<<<< HEAD
	STX DEBUGGING_CURRENT_PSI_ANIMATION
	CPX #34
=======
	STX UNKNOWN_7EAA70
	CPX #$0022
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	BNE @UNKNOWN29
	STZ DEBUGGING_CURRENT_PSI_ANIMATION
@UNKNOWN29:
	LDA PAD_PRESS
	AND #PAD::B_BUTTON
	BEQL @UNKNOWN21
	LDX DEBUGGING_CURRENT_SWIRL_FLAGS
	LDA DEBUGGING_CURRENT_SWIRL
	JSL UNKNOWN_C4A67E
	LDX DEBUGGING_CURRENT_SWIRL
	INX
<<<<<<< HEAD
	STX DEBUGGING_CURRENT_SWIRL
	CPX #8
=======
	STX UNKNOWN_7EAA72
	CPX #$0008
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	BNEL @UNKNOWN21
	STZ DEBUGGING_CURRENT_SWIRL
	LDA DEBUGGING_CURRENT_SWIRL_FLAGS
	INC
	AND #$0003
	STA DEBUGGING_CURRENT_SWIRL_FLAGS
	JMP @UNKNOWN21
@UNKNOWN32:
	LDX #$0000
	LDA $33
	AND #$0001
	BEQ @UNKNOWN33
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA GAME_STATE + game_state::party_members
	LDX #$0001
@UNKNOWN33:
	REP #PROC_FLAGS::ACCUM8
	LDA $33
	AND #$0002
	BEQ @UNKNOWN34
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0002
	STA GAME_STATE + game_state::party_members,X
	INX
@UNKNOWN34:
	REP #PROC_FLAGS::ACCUM8
	LDA $33
	AND #$0004
	BEQ @UNKNOWN35
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0003
	STA GAME_STATE + game_state::party_members,X
	INX
@UNKNOWN35:
	REP #PROC_FLAGS::ACCUM8
	LDA $33
	AND #$0008
	BEQ @UNKNOWN36
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0004
	STA GAME_STATE + game_state::party_members,X
	INX
@UNKNOWN36:
	REP #PROC_FLAGS::ACCUM8
	TXA
	SEP #PROC_FLAGS::ACCUM8
	STA GAME_STATE+game_state::player_controlled_party_count
	BRA @UNKNOWN38
@UNKNOWN37:
	STZ GAME_STATE + game_state::party_members,X
	INX
@UNKNOWN38:
	CPX #$0006
	BCC @UNKNOWN37
	JMP @UNKNOWN2
@UNKNOWN39:
	LDA ENEMIES_IN_BATTLE_IDS
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	.A16
	CLC
	ADC #enemy_data::music
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	JSL CHANGE_MUSIC
@UNKNOWN40:
	LDA #EVENT_FLAG::FLG_BUNBUN
	JSL GET_EVENT_FLAG
	CMP #$0000
	BEQ @UNKNOWN41
	LDX #.LOWORD(BATTLERS_TABLE)+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)
	LDA #ENEMY::BUZZ_BUZZ
	JSL BATTLE_INIT_ENEMY_STATS
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+16
	STZ BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::ally_or_enemy
	LDA #ENEMY::BUZZ_BUZZ
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::npc_id
@UNKNOWN41:
	LDX #$0000
	STX $1F
	BRA @UNKNOWN45
@UNKNOWN42:
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE + game_state::party_members,X
	AND #$00FF
	STA $04
	STA $21
	LDA $04
	BEQ @UNKNOWN44
	LDA $04
	CMP #$0004
	BGT @UNKNOWN44
	LDA $04
	DEC
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS)+char_struct::afflictions
	TAX
	LDA a:STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::POSSESSED
	BNE @UNKNOWN44
	LDX #.LOWORD(BATTLERS_TABLE)+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)
	LDA #ENEMY::TINY_LIL_GHOST
	JSL BATTLE_INIT_ENEMY_STATS
	SEP #PROC_FLAGS::ACCUM8
	LDA #ENEMY::TINY_LIL_GHOST
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::npc_id
	BRA @UNKNOWN46
@UNKNOWN44:
	LDX $1F
	INX
	STX $1F
@UNKNOWN45:
	CPX #TOTAL_PARTY_COUNT
	BCC @UNKNOWN42
@UNKNOWN46:
	JSL REDIRECT_SHOW_HPPP_WINDOWS
	LDA ENEMIES_IN_BATTLE
	JSR RAND_LIMIT
	.A16
	ASL
	TAX
<<<<<<< HEAD
	LDA ENEMIES_IN_BATTLE_IDS,X
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL06
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
=======
	LDA UNKNOWN_7E9F8C,X
	STA $2F
	LOADPTR ENEMY_CONFIGURATION_TABLE, $06
	LDA $2F
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	.A16
	STA $2F
	CLC
	ADC #enemy_data::item_dropped
	MOVE_INTX $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	AND #$00FF
	STA ITEM_DROPPED
	LDA $2F
	CLC
	ADC #enemy_data::item_drop_rate
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	BEQ @RARITY_ZERO
	CMP #$0001
	BEQ @RARITY_ONE
	CMP #$0002
	BEQ @RARITY_TWO
	CMP #$0003
	BEQ @RARITY_THREE
	CMP #$0004
	BEQ @RARITY_FOUR
	CMP #$0005
	BEQ @RARITY_FIVE
	CMP #$0006
	BEQ @RARITY_SIX
	BRA @RARITY_SEVEN
@RARITY_ZERO:
	JSL RAND
	AND #$007F ;1/2
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_ONE:
	JSL RAND
	AND #$003F ;1/4
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_TWO:
	JSL RAND
	AND #$001F ;1/8
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_THREE:
	JSL RAND
	AND #$000F ;1/16
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_FOUR:
	JSL RAND
	AND #$0007 ;1/32
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_FIVE:
	JSL RAND
	AND #$0003 ;1/64
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_SIX:
	JSL RAND
	AND #$0001 ;1/128
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
@RARITY_SEVEN: ;Item dropped or 0% chance of drop occurring
	LDA ITEM_DROPPED
	BNEL @END_ITEM_DROP
	LDX #$0000
	STX $31
	BRA @CONSOLATION_OUTER_LOOP_ENTRY
@CONSOLATION_OUTER_LOOP_BEGIN:
	LDY #$0008
	STY $2F
	BRA @CONSOLATION_INNER_LOOP_ENTRY
@CONSOLATION_INNER_LOOP_BEGIN:
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	.A16
	STA $23
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQ @ENEMY_NOT_IN_CONSOLATION_TABLE
	LOADPTR CONSOLATION_ITEM_TABLE, $06
	LDX $31
	TXA
	OPTIMIZED_MULT $04, 9
	STA $02
	LDA $23
	TAX
	LDA $02
	MOVE_INTY $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	AND #$00FF
	CMP BATTLERS_TABLE + battler::id,X
	BNE @ENEMY_NOT_IN_CONSOLATION_TABLE
	LDA #$0007
	JSR RAND_LIMIT
	PHA
	LDA $02
	PLY
	STY $02
	CLC
	ADC $02
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	STA ITEM_DROPPED
@ENEMY_NOT_IN_CONSOLATION_TABLE:
	LDY $2F
	INY
	STY $2F
@CONSOLATION_INNER_LOOP_ENTRY:
	CPY #BATTLER_COUNT
	BCC @CONSOLATION_INNER_LOOP_BEGIN
	LDX $31
	INX
	STX $31
@CONSOLATION_OUTER_LOOP_ENTRY:
	CPX #$0002
	BCCL @CONSOLATION_OUTER_LOOP_BEGIN
@END_ITEM_DROP:
	STZ $1D
	LDA BATTLE_INITIATIVE
	BEQ @UNKNOWN64
	CMP #$0001
	BEQ @UNKNOWN62
	CMP #$0002
	BEQ @UNKNOWN63
	BRA @UNKNOWN64
@UNKNOWN62:
	LDA #INITIATIVE::PARTY_FIRST
	STA $1D
	BRA @UNKNOWN64
@UNKNOWN63:
	LDA #INITIATIVE::ENEMIES_FIRST
	STA $1D
@UNKNOWN64:
	STZ BATTLE_INITIATIVE
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
	;TODO: why 8?
	LDA #.LOWORD(BATTLERS_TABLE)+8*.SIZEOF(battler)
	STA CURRENT_ATTACKER
	LDA #$0001
	JSL FIX_ATTACKER_NAME
<<<<<<< HEAD
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL0A
	LDA ENEMIES_IN_BATTLE_IDS
=======
	LOADPTR ENEMY_CONFIGURATION_TABLE, $0A
	LDA UNKNOWN_7E9F8C
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::encounter_text_ptr
	CLC
	ADC $0A
	STA $0A
	DEREFERENCE_PTR_TO $0A, $06
	MOVE_INT $06, $0E
	JSL DISPLAY_IN_BATTLE_TEXT
	LDA $1D
	CMP #INITIATIVE::PARTY_FIRST
	BNE @UNKNOWN65
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SENSEI_PC
@UNKNOWN65:
	LDA #$0000
	STA $31
	BRA @UNKNOWN70
@UNKNOWN66:
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)+8*.SIZEOF(battler)
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+2,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BNE @UNKNOWN67
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_NEMURI
@UNKNOWN67:
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+4,X
	AND #$00FF
	BEQ @UNKNOWN68
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_FUUIN
@UNKNOWN68:
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+3,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN69
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_HEN
@UNKNOWN69:
	LDA $31
	INC
	STA $31
@UNKNOWN70:
	CMP ENEMIES_IN_BATTLE
	BCC @UNKNOWN66
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
<<<<<<< HEAD
.IF .DEFINED(JPN)
	STZ @LOCAL06
	LDA @LOCAL06
.ELSE
	STZ @LOCAL09
	LDA @LOCAL09
.ENDIF
	STA SPECIAL_DEFEAT
=======
	STZ $23
	LDA $23
	STA UNKNOWN_7EAA0E
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	JMP @UNKNOWN236
@UNKNOWN71:
	INC $25
	JSL UNKNOWN_C2F917
	LDY #.LOWORD(BATTLERS_TABLE)
	STY $31
	LDX #$0000
	STX $1B
	BRA @UNKNOWN74
@UNKNOWN72:
	TYX
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::has_taken_turn,X
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN73
	TYA
	CLC
	ADC #battler::initiative
	STA $02
	LDA a:battler::speed,Y
	JSR FIFTY_PERCENT_VARIANCE
	LDX $02
	STA __BSS_START__,X
	CMP #$0000
	BNE @UNKNOWN73
	LDA #$0001
	LDX $02
	STA __BSS_START__,X
@UNKNOWN73:
	LDY $31
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
	STY $31
	LDX $1B
	INX
	STX $1B
@UNKNOWN74:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN72
	LDA #$0000
	STA $31
	BRA @UNKNOWN76
@UNKNOWN75:
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	TAX
	SEP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
	STZ PARTY_CHARACTERS + char_struct::unknown94,X
=======
	STZ CHAR_STRUCT+94,X
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	REP #PROC_FLAGS::ACCUM8
	LDA $31
	INC
	STA $31
@UNKNOWN76:
	CMP #$0004
	BCC @UNKNOWN75
	LDY #$0000
	STY $19
	TYA
	STA $02
	JMP @UNKNOWN106
@UNKNOWN77:
	JSL CHECK_DEAD_PLAYERS
	LDA #$0000
	JSL COUNT_CHARS
	CMP #$0000
	BNE @UNKNOWN78
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
	JMP @UNKNOWN225
@UNKNOWN78:
	LDX $02
	LDA GAME_STATE + game_state::party_members,X
	AND #$00FF
	STA $04
	STA $21
	LDA $04
	BEQL @UNKNOWN105
	LDA $04
	CMP #$0004
	BGTL @UNKNOWN105
	LDA $1D
	CMP #$0002
	BEQ @UNKNOWN82
	LDA $1D
	CMP #$0003
	BEQ @UNKNOWN82
	LDA $1D
	CMP #$0004
	BEQ @UNKNOWN82
	LDA $04
	CMP #$0004
	BNE @UNKNOWN81
	LDA MIRROR_ENEMY
	BNE @UNKNOWN82
@UNKNOWN81:
	LDA $04
	DEC
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS)+char_struct::afflictions
	TAX
	LDA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::UNCONSCIOUS
	BEQ @UNKNOWN82
	CMP #STATUS_0::DIAMONDIZED
	BEQ @UNKNOWN82
	LDA a:STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	TAX
	CPX #STATUS_2::ASLEEP
	BEQ @UNKNOWN82
	CPX #STATUS_2::SOLIDIFIED
	BNE @UNKNOWN83
@UNKNOWN82:
	LDA #BATTLE_ACTIONS::NO_EFFECT
	STA $1F
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLE_ITEM_USED
	JMP @UNKNOWN91
@UNKNOWN83:
	LDA $02
	JSL REDIRECT_C43573
	LDY $19
	TYX
	LDA $04
	JSL BATTLE_SELECTION_MENU
	.A16
	STA $1F
	JSL REDIRECT_C3E6F8
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
	LDA BATTLE_MODE
	BEQ @UNKNOWN84
	LDA $1F
	CMP #$FFFF
	BNE @UNKNOWN84
	STZ $17
	JMP @UNKNOWN237
@UNKNOWN84:
	LDA $1F
	CMP #BATTLE_ACTIONS::RUN_AWAY
	BNE @UNKNOWN87
	LDA #BATTLE_ACTIONS::USE_NO_EFFECT
	STA $1F
	LDA $1D
	CMP #$0001
	BNE @UNKNOWN85
	LDA #$0004
	STA $1D
	BRA @UNKNOWN86
@UNKNOWN85:
	LDA #$0003
	STA $1D
@UNKNOWN86:
	LDA #$0001
	STA $27
@UNKNOWN87:
	LDA $1F
	CMP #$FFFF
	BEQL @UNKNOWN2
	CMP #$0000
	BNE @UNKNOWN90
	LDY $19
	BEQL @UNKNOWN77
	DEY
	STY $19
	TYA
	ASL
	TAX
<<<<<<< HEAD
	LDA PARTY_MEMBERS_WITH_SELECTED_ACTIONS,X
	STA @VIRTUAL02
=======
	LDA UNKNOWN_7EAA66,X
	STA $02
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	JMP @UNKNOWN77
@UNKNOWN90:
	LDY $19
	TYA
	ASL
	TAX
<<<<<<< HEAD
	LDA @VIRTUAL02
	STA PARTY_MEMBERS_WITH_SELECTED_ACTIONS,X
=======
	LDA $02
	STA UNKNOWN_7EAA66,X
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	INY
	STY $19
	LDA $1F
	CMP #$0001
	BNE @UNKNOWN91
	LDA #$0000
	STA $1F
@UNKNOWN91:
	REP #PROC_FLAGS::ACCUM8
	STZ $1B
	JMP @UNKNOWN104
@UNKNOWN92:
	LDA $1B
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQL @UNKNOWN103
	LDA BATTLERS_TABLE+battler::ally_or_enemy,X
	AND #$00FF
	BNEL @UNKNOWN103
	LDA $04
	CMP BATTLERS_TABLE + battler::id,X
	BNEL @UNKNOWN103
	LDA $1F
	STA BATTLERS_TABLE+battler::current_action,X
	LDA BATTLE_ITEM_USED
	AND #$00FF
	BEQ @UNKNOWN96
	SEP #PROC_FLAGS::ACCUM8
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::param1
	STA BATTLERS_TABLE+7,X
	LDA BATTLE_ITEM_USED
	STA BATTLERS_TABLE+battler::current_action_argument,X
	BRA @UNKNOWN97
@UNKNOWN96:
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+7,X
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::param1
	STA BATTLERS_TABLE+battler::current_action_argument,X
@UNKNOWN97:
	REP #PROC_FLAGS::ACCUM8
	LDA $1B
	LDY #.SIZEOF(battler)
	JSL MULT168
<<<<<<< HEAD
.IF .DEFINED(JPN)
	TAX
	STX @LOCAL0A
	LDA #.LOWORD(BATTLE_MENU_SELECTION) + battle_menu_selection::targetting
	STA @LOCAL07
	TAX
.ELSE
	STA @LOCAL07
	LDX #.LOWORD(BATTLE_MENU_SELECTION) + battle_menu_selection::targetting
	STX @LOCAL0F
=======
	STA $1F
	LDX #.LOWORD(UNKNOWN_7EA97D) + unknown_A97D::unknown4
	STX $2F
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	PHA
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	PLX
	STA BATTLERS_TABLE + battler::action_targetting,X
	REP #PROC_FLAGS::ACCUM8
	LDA $1F
	TAX
	SEP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
.ENDIF
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::selected_target
=======
	LDA UNKNOWN_7EA97D + unknown_A97D::unknown5
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	STA BATTLERS_TABLE + battler::current_target,X
	LDX $2F
	REP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN101
	LDA #$0000
	STA $2F
	BRA @UNKNOWN100
@UNKNOWN98:
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN99
	LDA BATTLERS_TABLE+battler::npc_id,X
	AND #$00FF
	BNE @UNKNOWN99
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::selected_target
	AND #$00FF
	CMP BATTLERS_TABLE+battler::id,X
	BNE @UNKNOWN99
	LDA $1B
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA $2F
	SEP #PROC_FLAGS::ACCUM8
	INC
	STA BATTLERS_TABLE+battler::current_target,X
	BRA @UNKNOWN101
@UNKNOWN99:
	LDA $2F
	INC
	STA $2F
@UNKNOWN100:
	.A16
	CMP #$0006
	BCC @UNKNOWN98
@UNKNOWN101:
	REP #PROC_FLAGS::ACCUM8
	LDA $1B
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::current_action,X
	CMP #BATTLE_ACTIONS::GUARD
	BNE @UNKNOWN102
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA BATTLERS_TABLE+battler::guarding,X
	BRA @UNKNOWN105
@UNKNOWN102:
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::guarding,X
	BRA @UNKNOWN105
@UNKNOWN103:
	INC $1B
@UNKNOWN104:
	.A16
	LDA $1B
	CMP #BATTLER_COUNT
	BCCL @UNKNOWN92
@UNKNOWN105:
	REP #PROC_FLAGS::ACCUM8
	INC $02
@UNKNOWN106:
	LDA $02
	CMP #$0006
	BCCL @UNKNOWN77
	LDA #.LOWORD(BATTLERS_TABLE)
	STA $02
	STA $19
	LDY #$0000
	STY $1F
	JMP @UNKNOWN132
@UNKNOWN108:
	LDX $02
	LDA a:battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN109
	LDX $02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #$0001
	BEQ @UNKNOWN111
@UNKNOWN109:
	LDX $02
	LDA a:battler::npc_id,X
	AND #$00FF
	BNE @UNKNOWN111
	LDX $02
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNEL @UNKNOWN131
	LDA MIRROR_ENEMY
	BEQL @UNKNOWN131
@UNKNOWN111:
	LDA $1D
	CMP #$0001
	BEQ @UNKNOWN112
	LDA $1D
	CMP #$0004
	BNE @UNKNOWN113
@UNKNOWN112:
	LDX $02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN113
	LDX $02
	STZ a:battler::current_action,X
	JMP @UNKNOWN131
@UNKNOWN113:
	LDA $1D
	CMP #$0002
	BNE @UNKNOWN114
	LDX $02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN114
	LDX $02
	STZ a:battler::current_action,X
	JMP @UNKNOWN131
@UNKNOWN114:
	LDX $02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN115
	LDX $02
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN115
	LOADPTR ENEMY_CONFIGURATION_TABLE, $06
	LDA MIRROR_ENEMY
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC $06
	STA $06
	BRA @UNKNOWN116
@UNKNOWN115:
	LOADPTR ENEMY_CONFIGURATION_TABLE, $06
	LDX $02
	LDA a:battler::id,X
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC $06
	STA $06
@UNKNOWN116:
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0045
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BEQ @ACTION_PATTERN_1
	CMP #$0001
	BEQ @ACTION_PATTERN_2
	CMP #$0002
	BEQ @ACTION_PATTERN_3
	CMP #$0003
	BEQ @ACTION_PATTERN_4
	JMP @UNKNOWN125
@ACTION_PATTERN_1:
	JSL RAND
	AND #$0003
	STA $04
	STA $21
	JMP @UNKNOWN125
@ACTION_PATTERN_2:
	JSL RAND
	AND #$0007
	BEQ @ACTION_PATTERN_2_4TH
	CMP #$0001
	BEQ @ACTION_PATTERN_2_3RD
	CMP #$0002
	BEQ @ACTION_PATTERN_2_2ND
	CMP #$0003
	BEQ @ACTION_PATTERN_2_2ND
	BRA @ACTION_PATTERN_2_1ST
@ACTION_PATTERN_2_4TH:
	LDA #$0003
	STA $04
	STA $21
	BRA @UNKNOWN125
@ACTION_PATTERN_2_3RD:
	LDA #$0002
	STA $04
	STA $21
	BRA @UNKNOWN125
@ACTION_PATTERN_2_2ND:
	LDA #$0001
	STA $04
	STA $21
	BRA @UNKNOWN125
@ACTION_PATTERN_2_1ST:
	LDA #$0000
	STA $04
	STA $21
	BRA @UNKNOWN125
@ACTION_PATTERN_3:
	LDA $02
	CLC
	ADC #battler::action_order_var
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA $16
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA $04
	STA $21
	SEP #PROC_FLAGS::ACCUM8
	LDA $16
	INC
	AND #$0003
	STA __BSS_START__,X
	BRA @UNKNOWN125
@ACTION_PATTERN_4:
	.A16
	LDA $02
	CLC
	ADC #battler::action_order_var
	TAX
	STX $31
	LDA __BSS_START__,X
	AND #$00FF
	ASL
	STA $2F
	JSL RAND
	STA $04
	AND #$0001
	STA $02
	LDA $2F
	CLC
	ADC $02
	STA $04
	STA $21
	LDX $31
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	AND #$0001
	STA __BSS_START__,X
@UNKNOWN125:
	REP #PROC_FLAGS::ACCUM8
	LDA $19
	STA $02
	INC
	INC
	INC
	INC
	STA $2F
	TAX
	LDA $21
	STA $04
	ASL
	CLC
	ADC #enemy_data::actions
	MOVE_INTY $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	STA __BSS_START__,X
	LDA $02
	CLC
	ADC #$0008
	TAX
	STX $31
	LDA $04
	CLC
	ADC #enemy_data::action_args
	CLC
	ADC $06
	STA $06
	SEP #PROC_FLAGS::ACCUM8
	LDA [$06]
	STA $00
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA $2F
	TAX
	LDA __BSS_START__,X
	CMP #BATTLE_ACTIONS::ENEMY_EXTENDER
	BNE @UNKNOWN127
	LDX $02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN126
	LDX $02
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN126
	LDA $00
	AND #$00FF
	STA MIRROR_ENEMY
	JMP @UNKNOWN114
@UNKNOWN126:
	LDX $02
	LDA a:battler::current_action_argument,X
	AND #$00FF
	LDX $02
	STA a:battler::id,X
	JMP @UNKNOWN114
@UNKNOWN127:
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN128
	JSL SELECT_STEALABLE_ITEM
	SEP #PROC_FLAGS::ACCUM8
	LDX $31
	STA __BSS_START__,X
	LDX $02
	REP #PROC_FLAGS::ACCUM8
	STZ a:battler::initiative,X
@UNKNOWN128:
	LDX $02
	LDA a:battler::current_action,X
	CMP #BATTLE_ACTIONS::ON_GUARD
	BNE @NOT_DEFENDING
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	LDX $02
	STA a:battler::guarding,X
	BRA @UNKNOWN130
@NOT_DEFENDING:
	LDX $02
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::guarding,X
@UNKNOWN130:
	REP #PROC_FLAGS::ACCUM8
	LDA $02
	JSL CHOOSE_TARGET
@UNKNOWN131:
	LDA $02
	CLC
	ADC #.SIZEOF(battler)
	STA $02
	STA $19
	LDY $1F
	INY
	STY $1F
@UNKNOWN132:
	CPY #BATTLER_COUNT
	BCCL @UNKNOWN108
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
	LDA $1D
	CMP #INITIATIVE::ENEMIES_FIRST
	BNE @UNKNOWN134
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SENSEI_MON
@UNKNOWN134:
	LDA $27
	BEQL @UNKNOWN144
	LDY #.LOWORD(BATTLERS_TABLE)
	STY $2F
	STZ $1B
	LDA #$0000
	STA $04
	STA $21
	STA $02
	JMP @UNKNOWN140
@UNKNOWN136:
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN139
	LDA a:battler::npc_id,Y
	AND #$00FF
	BNE @UNKNOWN139
	LDA a:battler::ally_or_enemy,Y
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN138
	LDA a:battler::id,Y
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::boss
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	BNEL @UNKNOWN143
	LDY $2F
	LDA a:battler::afflictions,Y
	AND #$00FF
	TAX
	CPX #$0001
	BEQ @UNKNOWN139
	CPX #$0002
	BEQ @UNKNOWN139
	CPX #$0003
	BEQ @UNKNOWN139
	LDA a:battler::afflictions+2,Y
	AND #$00FF
	TAX
	CPX #$0001
	BEQ @UNKNOWN139
	CPX #$0003
	BEQ @UNKNOWN139
	CPX #$0004
	BEQ @UNKNOWN139
	LDA a:battler::speed,Y
	CMP $04
	BLTEQ @UNKNOWN139
	STA $04
	STA $21
	BRA @UNKNOWN139
@UNKNOWN138:
	LDA a:battler::speed,Y
	CMP $1B
	BLTEQ @UNKNOWN139
	STA $1B
@UNKNOWN139:
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
	STY $2F
	INC $02
@UNKNOWN140:
	LDA $02
	CMP #BATTLER_COUNT
	BCCL @UNKNOWN136
	LDA $04
	BEQ @UNKNOWN142
	LDA $1D
	CMP #$0004
	BEQ @UNKNOWN142
	LDA $25
	OPTIMIZED_MULT $04, 10
	CLC
	ADC $1B
	TAX
	STX $2F
	LDA $21
	STA $04
	TXA
	CMP $04
	BCC @UNKNOWN143
	LDA #$0064
	JSR RAND_LIMIT
	STA $27
	LDX $2F
	TXA
	SEC
	SBC $04
	STA $02
	LDA $27
	CMP $02
	BCS @UNKNOWN143
@UNKNOWN142:
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PLAYER_FLEE
	STZ $17
	JMP @UNKNOWN237
@UNKNOWN143:
	STZ $27
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PLAYER_FLEE_NG
@UNKNOWN144:
	STZ $1D
	JMP @UNKNOWN234
@UNKNOWN145:
	JSL CHECK_DEAD_PLAYERS
	LDA #$0000
	JSL COUNT_CHARS
	CMP #$0000
	BEQL @UNKNOWN225
	LDA #$0001
	JSL COUNT_CHARS
	CMP #$0000
	BEQL @UNKNOWN225
	LDA #$FFFF
	STA $04
	STA $21
	LDX #$0000
	TXA
	STA $31
	BRA @UNKNOWN150
@UNKNOWN148:
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAY
	LDA BATTLERS_TABLE+battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN149
	LDA BATTLERS_TABLE+13,Y
	AND #$00FF
	BNE @UNKNOWN149
	LDA BATTLERS_TABLE+70,Y
	TAY
	STX $02
	TYA
	CMP $02
	BCC @UNKNOWN149
	LDA $31
	STA $04
	STA $21
	TYX
@UNKNOWN149:
	LDA $31
	INC
	STA $31
@UNKNOWN150:
	CMP #BATTLER_COUNT
	BCC @UNKNOWN148
	LDA $04
	CMP #$FFFF
	BEQL @UNKNOWN235
	JSL REDIRECT_C10FA3
	LDA $04
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	STX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA a:battler::has_taken_turn,X
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	TAX
	CPX #STATUS_0::UNCONSCIOUS
	BEQL @UNKNOWN234
	CPX #STATUS_0::DIAMONDIZED
	BEQL @UNKNOWN234
	CPX #STATUS_0::PARALYZED
	BEQ @UNKNOWN154
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::IMMOBILIZED
	BNEL @UNKNOWN157
@UNKNOWN154:
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	STX $2F
	LDA __BSS_START__,X
	STA $31
	OPTIMIZED_MULT $04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	CMP #ACTION_TYPE::PSI
	BEQ @UNKNOWN157
	LDA $31
	CMP #BATTLE_ACTIONS::PRAY
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_1
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_2
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_3
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_4
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_5
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_6
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_7
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_8
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_9
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::SPY
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::MIRROR
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::NO_EFFECT
	BEQ @UNKNOWN157
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::PARALYZED
	BNE @UNKNOWN155
	LDA #BATTLE_ACTIONS::ACTION_252
	LDX $2F
	STA __BSS_START__,X ;battler::current_action
	BRA @UNKNOWN156
@UNKNOWN155:
	LDA #BATTLE_ACTIONS::ACTION_254
	LDX $2F
	STA __BSS_START__,X ;battler::current_action
@UNKNOWN156:
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN157:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BNE @UNKNOWN158
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	LDA __BSS_START__,X ;battler::current_action
	BEQ @UNKNOWN158
	LDA #BATTLE_ACTIONS::ACTION_253
	STA __BSS_START__,X ;battler::current_action
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN158:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::SOLIDIFIED
	BNE @UNKNOWN159
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	LDA __BSS_START__,X ;battler::current_action
	BEQ @UNKNOWN159
	LDA #BATTLE_ACTIONS::ACTION_255
	STA __BSS_START__,X ;battler::current_action
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	LDX CURRENT_ATTACKER
	STZ a:battler::action_item_slot,X
@UNKNOWN159:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions+STATUS_GROUP::CONCENTRATION,X
	AND #$00FF
	BEQ @UNKNOWN160
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	STX $2F
	LDA __BSS_START__,X ;battler::current_action
	STA $31
	OPTIMIZED_MULT $04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	CMP #ACTION_TYPE::PSI
	BNE @UNKNOWN160
	LDA $31
	BEQ @UNKNOWN160
	LDA #BATTLE_ACTIONS::ACTION_256
	LDX $2F
	STA __BSS_START__,X ;battler::current_action
@UNKNOWN160:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::HOMESICKNESS,X
	AND #$00FF
	CMP #STATUS_5::HOMESICK
	BNE @UNKNOWN161
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQ @UNKNOWN161
	JSL RAND
	AND #$0007
	BNE @UNKNOWN161
	LDA #BATTLE_ACTIONS::ACTION_251
	LDX CURRENT_ATTACKER
	STA a:battler::current_action,X
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN161:
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, $06
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	STA $2F
	MOVE_INTX $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN163
	LDA $2F
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	BNE @UNKNOWN163
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN162
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	LDX CURRENT_ATTACKER
	STA a:battler::action_targetting,X
	LDY #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	SEC
	SBC #.LOWORD(BATTLERS_TABLE)
	JSL DIVISION16S_DIVISOR_POSITIVE
	SEP #PROC_FLAGS::ACCUM8
	INC
	LDX CURRENT_ATTACKER
	STA a:battler::current_target,X
	BRA @UNKNOWN163
@UNKNOWN162:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0011
	LDX CURRENT_ATTACKER
	STA a:battler::action_targetting,X
	LDY #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	SEC
	SBC #.LOWORD(BATTLERS_TABLE)
	JSL DIVISION16S_DIVISOR_POSITIVE
	TAX
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C4A228
@UNKNOWN163:
	LDX #$0000
	STX $2F
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	STA CURRENT_TARGET
	TXA
	JSL FIX_ATTACKER_NAME
	JSL FIX_TARGET_NAME
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::NAUSEOUS
	BEQ @UNKNOWN164
	CMP #STATUS_0::POISONED
	BEQ @UNKNOWN165
	CMP #STATUS_0::SUNSTROKE
	BEQ @UNKNOWN166
	CMP #STATUS_0::COLD
	BEQ @UNKNOWN167
	JMP @UNKNOWN168
@UNKNOWN164:
	LDA #$0014
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
	STX $2F
	LOADPTR MSG_BTL_KIMOCHI_DAMAGE, $0E
	TXA
	STORE_INT1632 $06
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN165:
	LDA #$0014
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
	STX $2F
	LOADPTR MSG_BTL_MODOKU_DAMAGE, $0E
	TXA
	STORE_INT1632 $06
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN166:
	LDA #$0004
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
	STX $2F
	LOADPTR MSG_BTL_NISSHA_DAMAGE, $0E
	TXA
	STORE_INT1632 $06
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN167:
	LDA #$0004
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
	STX $2F
	LOADPTR MSG_BTL_KAZE_DAMAGE, $0E
	TXA
	STORE_INT1632 $06
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
@UNKNOWN168:
	LDX $2F
	LDA CURRENT_ATTACKER
	JSL LOSE_HP_STATUS
	LDX CURRENT_ATTACKER
	LDA a:battler::hp,X
	BNE @UNKNOWN171
	LDA CURRENT_ATTACKER
	JSL KO_TARGET
	LDA #$0000
	JSL COUNT_CHARS
	CMP #$0000
	BEQL @UNKNOWN225
	LDA #$0001
	JSL COUNT_CHARS
	CMP #$0000
	BNEL @UNKNOWN234
	JMP @UNKNOWN225
@UNKNOWN171:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN172
	LDA CURRENT_ATTACKER
	JSL CHOOSE_TARGET
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN172
	JSL SELECT_STEALABLE_ITEM
	SEP #PROC_FLAGS::ACCUM8
	LDX CURRENT_ATTACKER
	STA a:battler::current_action_argument,X
@UNKNOWN172:
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C24703
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN174
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	TAX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BNE @UNKNOWN174
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
	MOVE_INT_CONSTANT NULL, $0A
	MOVE_INT BATTLER_TARGET_FLAGS, $06
	CMP $0C
	BNE @UNKNOWN173
	LDA $06
	CMP $0A
@UNKNOWN173:
	BNE @UNKNOWN174
	LDA CURRENT_ATTACKER
	JSL CHOOSE_TARGET
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C24703
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
@UNKNOWN174:
	LDY #$0000
	STY $31
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::MUSHROOMIZED
	BNE @UNKNOWN175
	LDA #100
	JSR RAND_LIMIT
	CMP #MUSHROOMIZED_TARGET_CHANGE_CHANCE
	BCC @UNKNOWN176
@UNKNOWN175:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::STRANGENESS,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN179
@UNKNOWN176:
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	TAX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BEQ @UNKNOWN179
	LDY #$0001
	STY $31
@UNKNOWN177:
	JSR FEELING_STRANGE_RETARGETTING
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
	MOVE_INT_CONSTANT NULL, $0A
	MOVE_INT BATTLER_TARGET_FLAGS, $06
	CMP $0C
	BNE @UNKNOWN178
	LDA $06
	CMP $0A
@UNKNOWN178:
	BEQ @UNKNOWN177
@UNKNOWN179:
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN180
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action_argument,X
	AND #$00FF
	JSL UNKNOWN_C24348
	CMP #$0000
	BNE @UNKNOWN180
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::current_action_argument,X
@UNKNOWN180:
	REP #PROC_FLAGS::ACCUM8
	LDA #$0000
	JSL FIX_ATTACKER_NAME
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	LDA a:battler::current_action_argument,X
	JSL REDIRECT_C1ACF8
	JSL UNKNOWN_C23E32
	.A16
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN185
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	CMP #PLAYER_CHAR_COUNT
	BGT @UNKNOWN185
	LDX #$0000
	STX $2F
	BRA @UNKNOWN184
@UNKNOWN182:
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	STA $02
	LDX $2F
	LDA GAME_STATE + game_state::party_members,X
	AND #$00FF
	CMP $02
	BNE @UNKNOWN183
	TXA
	JSL REDIRECT_C43573
	BRA @UNKNOWN185
@UNKNOWN183:
	INX
	STX $2F
@UNKNOWN184:
	CPX #$0006
	BCC @UNKNOWN182
@UNKNOWN185:
	.A16
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	TAX
	INX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BEQ @UNKNOWN187
	AND #$00FF
	LDX CURRENT_ATTACKER
	CMP a:battler::pp_target,X
	BLTEQ @UNKNOWN186
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PSI_CANNOT
	JMP @UNKNOWN215
@UNKNOWN186:
	TAX
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C2BCB9
@UNKNOWN187:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #$0001
	BNE @UNKNOWN194
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQ @UNKNOWN194
	OPTIMIZED_MULT $04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X ;battle_action::type
	AND #$00FF
	CMP #ACTION_TYPE::PHYSICAL
	BEQ @UNKNOWN188
	CMP #ACTION_TYPE::PIERCING_PHYSICAL
	BEQ @UNKNOWN188
	CMP #ACTION_TYPE::PSI
	BEQ @UNKNOWN189
	CMP #ACTION_TYPE::OTHER
	BEQ @UNKNOWN190
	BRA @UNKNOWN191
@UNKNOWN188:
	LDA #$0001
	JSL UNKNOWN_C2FEF9
	BRA @UNKNOWN191
@UNKNOWN189:
	LDA #$0002
	JSL UNKNOWN_C2FEF9
	BRA @UNKNOWN191
@UNKNOWN190:
	LDA #$0003
	JSL UNKNOWN_C2FEF9
@UNKNOWN191:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$000C
	LDX CURRENT_ATTACKER
	STA a:battler::unknown73,X
	LDX #$0000
	STX $1F
	BRA @UNKNOWN193
@UNKNOWN192:
	JSL WINDOW_TICK
	LDX $1F
	INX
	STX $1F
@UNKNOWN193:
	CPX #$000C
	BCC @UNKNOWN192
@UNKNOWN194:
	LDY $31
	BEQ @UNKNOWN196
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions+STATUS_GROUP::STRANGENESS,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN195
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_RND_ACT_HEN
@UNKNOWN195:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::MUSHROOMIZED
	BNE @UNKNOWN196
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_RND_ACT_KINOKO
@UNKNOWN196:
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, $0A
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	INC
	INC
	INC
	INC
	CLC
	ADC $0A
	STA $0A
	DEREFERENCE_PTR_TO $0A, $06
	MOVE_INT $06, $0E
	JSL UNKNOWN_C1DD9F
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQL @UNKNOWN215
	BRA @UNKNOWN199
@UNKNOWN198:
	JSL WINDOW_TICK
@UNKNOWN199:
	JSL UNKNOWN_C2EACF
	CMP #$0000
	BNE @UNKNOWN198
	LDY #$0000
	STY $1B
	JMP @UNKNOWN214
@UNKNOWN200:
	TYA
	JSL IS_CHAR_TARGETTED
	CMP #$0000
	BEQL @UNKNOWN213
	LDY $1B
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::UNCONSCIOUS
	BNE @UNKNOWN204
	LDA #$0000
	STA $2F
	BRA @UNKNOWN203
@UNKNOWN202:
	TXA
	LDX CURRENT_ATTACKER
	CMP a:battler::current_action,X
	BEQ @UNKNOWN204
	LDA $2F
	INC
	STA $2F
@UNKNOWN203:
	ASL
	TAX
	LDA f:DEAD_TARGETTABLE_ACTIONS,X
	TAX
	BNE @UNKNOWN202
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NOT_EXIST
	JMP @UNKNOWN213
@UNKNOWN204:
	LOADPTR BATTLE_ACTION_TABLE, $0A
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT $04, 12
	CLC
	ADC #$0008
	CLC
	ADC $0A
	STA $0A
	DEREFERENCE_PTR_TO $0A, $06
	MOVE_INT_CONSTANT NULL, $0A
	CMP32 $06, $0A
	BEQ @UNKNOWN213
	PHA
<<<<<<< HEAD
	MOVE_INT @VIRTUAL06, TEMP_FUNCTION_POINTER
=======
	MOVE_INT $06, UNKNOWN_7E00BC
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	PLA
	JSL UNKNOWN_C09279
	JSL CHECK_DEAD_PLAYERS
	SEP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
	LDA #1
	STA REDRAW_ALL_WINDOWS
=======
	LDA #$0001
	STA UNKNOWN_7E9623
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	REP #PROC_FLAGS::ACCUM8
	LDA #$0000
	JSL COUNT_CHARS
	CMP #$0000
	BEQ @UNKNOWN206
	LDA #$0001
	JSL COUNT_CHARS
	CMP #$0000
	BNE @UNKNOWN207
@UNKNOWN206:
	JSL UNKNOWN_C2437E
	JMP @UNKNOWN225
@UNKNOWN207:
<<<<<<< HEAD
	LDA SPECIAL_DEFEAT
	CMP #3
=======
	LDA UNKNOWN_7EAA0E
	CMP #$0003
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	BEQ @UNKNOWN208
	CMP #$0002
	BEQ @UNKNOWN209
	CMP #$0001
	BEQ @UNKNOWN210
	BRA @UNKNOWN212
@UNKNOWN208:
	STZ $17
	JMP @UNKNOWN237
@UNKNOWN209:
	JSL UNKNOWN_C2437E
	JMP @ENEMIES_ARE_DEAD
@UNKNOWN210:
	LDA #$0002
	STA $17
	JMP @UNKNOWN237
@UNKNOWN211:
	JSL WINDOW_TICK
@UNKNOWN212:
	LDA SCREEN_EFFECT_MINIMUM_WAIT_FRAMES
	BNE @UNKNOWN211
@UNKNOWN213:
	LDY $1B
	INY
	STY $1B
@UNKNOWN214:
	CPY #BATTLER_COUNT
	BCCL @UNKNOWN200
@UNKNOWN215:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN217
	JSL UNKNOWN_C2437E
	LDA MIRROR_ENEMY
	BEQ @UNKNOWN216
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN216
	LDX MIRROR_TURN_TIMER
	DEX
	STX MIRROR_TURN_TIMER
	BNE @UNKNOWN216
	STZ MIRROR_ENEMY
	LDA CURRENT_ATTACKER
	PROMOTENEARPTRA $06
	REP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
	MOVE_INT @VIRTUAL06, @LOCAL00
	PROMOTENEARPTR MIRROR_BATTLER_BACKUP, @VIRTUAL06
=======
	MOVE_INT $06, $0E
	PROMOTENEARPTR UNKNOWN_7EAA14, $06
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT $06, $12
	JSL COPY_MIRROR_DATA
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NEUTRALIZE_METAMORPH
@UNKNOWN216:
	JSL REDIRECT_C3E6F8
@UNKNOWN217:
	JSL CHECK_DEAD_PLAYERS
	LDA CURRENT_ATTACKER
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BEQ @UNKNOWN218
	CMP #STATUS_2::IMMOBILIZED
	BEQ @UNKNOWN219
	CMP #STATUS_2::SOLIDIFIED
	BEQ @UNKNOWN220
	BRA @UNKNOWN221
@UNKNOWN218:
	JSL RAND
	AND #$0003
	BNE @UNKNOWN221
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NEMURI_OFF
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	BRA @UNKNOWN221
@UNKNOWN219:
	.A16
	LDA #100
	JSR RAND_LIMIT
	CMP #100-CHANCE_OF_BODY_MOVING_AGAIN
	BCS @UNKNOWN221
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SHIBARA_OFF
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	BRA @UNKNOWN221
@UNKNOWN220:
	.A16
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_KOORI_STAT
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
@UNKNOWN221:
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	CLC
	ADC #battler::afflictions+STATUS_GROUP::CONCENTRATION
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA $16
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BEQ @UNKNOWN222
	SEP #PROC_FLAGS::ACCUM8
	LDA $16
	DEC
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BNE @UNKNOWN222
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_FUUIN_OFF
@UNKNOWN222:
	LDA #.LOWORD(BATTLERS_TABLE)
	LDX #$0000
	STX $31
	BRA @UNKNOWN224
@UNKNOWN223:
	TAX
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::use_alt_spritemap,X
	CLC
	REP #PROC_FLAGS::ACCUM8
	ADC #.SIZEOF(battler)
	LDX $31
	INX
	STX $31
@UNKNOWN224:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN223
	JSL CHECK_DEAD_PLAYERS
	JSL REDIRECT_SHOW_HPPP_WINDOWS
@UNKNOWN225:
	LDA #$0000
	JSL COUNT_CHARS
	CMP #$0000
	BNE @ALLIES_ARE_ALIVE
	LDA #$0001
	STA $17
	JSL RESET_HPPP_ROLLING
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_MONSTER_WIN
	LDA #$0001
	STA $23
@ALLIES_ARE_ALIVE:
	LDA #$0001
	JSL COUNT_CHARS
	CMP #$0000
	BNEL @UNKNOWN234
@ENEMIES_ARE_DEAD:
	STZ $17
	JSL RESET_HPPP_ROLLING
<<<<<<< HEAD
	LDA #1
	STA LETTERBOX_EFFECT_ENDING
	STA ENABLE_BACKGROUND_DARKENING
=======
	LDA #$0001
	STA UNKNOWN_7EADB6
	STA UNKNOWN_7EADD0
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.LOWORD(GAME_STATE) + game_state::unknownC4
	STY $2F
	LDA BATTLE_MONEY_SCRATCH
	STORE_INT1632 $06
	MOVE_INT $06, $0E
	JSL DEPOSIT_INTO_ATM
	MOVE_INT $06, $0A
	LDY $2F
	MOVE_INT_YPTRSRC __BSS_START__, $06
	CLC
	ADD_INT_ASSIGN $06, $0A
	MOVE_INT_YPTRDEST $06, __BSS_START__
	LDA #$0000
	JSL COUNT_CHARS
	DEC
	STORE_INT1632 $0A
	MOVE_INT BATTLE_EXP_SCRATCH, $06
	CLC
	ADD_INT_ASSIGN $06, $0A
	MOVE_INT $06, BATTLE_EXP_SCRATCH
	LDA #$0000
	JSL COUNT_CHARS
	STORE_INT1632 $0A
	JSL DIVISION32
	MOVE_INT $06, BATTLE_EXP_SCRATCH
	LDA CURRENT_BATTLE_GROUP
	CMP #$01C0
	BCC @NOT_BOSS_BATTLE
	LOADPTR MSG_BTL_PLAYER_WIN_BOSS, $0E
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
	BRA @SKIP_NOT_BOSS_BATTLE
@NOT_BOSS_BATTLE:
	LOADPTR MSG_BTL_PLAYER_WIN, $0E
	MOVE_INT $06, $12
	JSL DISPLAY_TEXT_WAIT
@SKIP_NOT_BOSS_BATTLE:
	LDA ITEM_DROPPED
	BEQ @UNKNOWN230
	SEP #PROC_FLAGS::ACCUM8
	LDA ITEM_DROPPED
	JSL REDIRECT_C1ACF8
	.A16
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PRESENT
@UNKNOWN230:
	LDY #.LOWORD(BATTLERS_TABLE)
	STY $31
	LDA #$0000
	STA $02
	BRA @UNKNOWN233
@UNKNOWN231:
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN232
	LDA a:battler::ally_or_enemy,Y
	AND #$00FF
	BNE @UNKNOWN232
	LDA a:battler::npc_id,Y
	AND #$00FF
	BNE @UNKNOWN232
	LDA a:battler::afflictions,Y
	AND #$00FF
	TAX
	CPX #STATUS_0::UNCONSCIOUS
	BEQ @UNKNOWN232
	CPX #STATUS_0::DIAMONDIZED
	BEQ @UNKNOWN232
	MOVE_INT BATTLE_EXP_SCRATCH, $06
	MOVE_INT $06, $0E
	LDX #$0001
	LDA a:battler::id,Y
	JSL GAIN_EXP
@UNKNOWN232:
	LDY $31
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
	STY $31
	INC $02
@UNKNOWN233:
	LDA $02
	CMP #BATTLER_COUNT
	BCC @UNKNOWN231
	LDA #$0001
	STA $23
@UNKNOWN234:
	LDA $23
	BEQL @UNKNOWN145
@UNKNOWN235:
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
@UNKNOWN236:
	LDA $23
	BEQL @UNKNOWN71
@UNKNOWN237:
	JSL RESET_HPPP_ROLLING
@UNKNOWN238:
	JSL WINDOW_TICK
	JSL UNKNOWN_C2108C
	CMP #$0000
	BEQ @UNKNOWN238
	LDA MIRROR_ENEMY
	BEQL @UNKNOWN243
	LDA #.LOWORD(BATTLERS_TABLE)
	STA $2F
	LDX #$0000
	STX $25
	JMP @UNKNOWN242
@UNKNOWN240:
	TAX
	LDA a:battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN241
	LDA $2F
	TAX
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN241
	LDA $2F
	TAX
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN241
	STZ MIRROR_ENEMY
	LDA $2F
	CLC
	ADC #battler::afflictions
	TAX
	STX $25
	LDA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	STA $04
	STA $21
	LDA $2F
	PROMOTENEARPTRA $06
	REP #PROC_FLAGS::ACCUM8
<<<<<<< HEAD
	MOVE_INT @VIRTUAL06, @LOCAL00
	PROMOTENEARPTR MIRROR_BATTLER_BACKUP, @VIRTUAL06
=======
	MOVE_INT $06, $0E
	PROMOTENEARPTR UNKNOWN_7EAA14, $06
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT $06, $12
	JSL COPY_MIRROR_DATA
	LDA $04
	SEP #PROC_FLAGS::ACCUM8
	LDX $25
	STA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	JSL CHECK_DEAD_PLAYERS
	BRA @UNKNOWN243
@UNKNOWN241:
	.A16
	LDA $2F
	CLC
	ADC #.SIZEOF(battler)
	STA $2F
	LDX $25
	INX
	STX $25
@UNKNOWN242:
	CPX #BATTLER_COUNT
	BCCL @UNKNOWN240
@UNKNOWN243:
	JSL RESET_POST_BATTLE_STATS
	SEP #PROC_FLAGS::ACCUM8
	STZ GAME_STATE+game_state::auto_fight_enable
	REP #PROC_FLAGS::ACCUM8
	STZ BATTLE_MODE_FLAG
	LDA BATTLE_MODE
	BEQL @UNKNOWN2
	LDX #$0001
	TXA
	JSL FADE_OUT
	BRA @UNKNOWN246
@UNKNOWN245:
	JSL WAIT_UNTIL_NEXT_FRAME
	JSL UNKNOWN_C2DB3F
@UNKNOWN246:
	LDA FADE_PARAMETERS + fade_parameters::step
	AND #$00FF
	BNE @UNKNOWN245
	JSL UNKNOWN_C20293
	JSL UNKNOWN_C08726
	JSL UNKNOWN_C1DD5F
	JSL UNKNOWN_C2E0E7
	LDA $17
	PLD
	RTL
