
BATTLE_ROUTINE:
	BEGIN_C_FUNCTION_FAR
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT8
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_RETURN_INT16 ;bool
	END_STACK_VARS
	LDA BATTLE_MODE
	BNE @UNKNOWN0
	LDA #1
	STA @LOCAL12
	STA @LOCAL11
	SEP #PROC_FLAGS::ACCUM8
	STA GAME_STATE+game_state::player_controlled_party_count
.IF .DEFINED(JPN)
	REP #PROC_FLAGS::ACCUM8
	LDA #.LOWORD(GAME_STATE) + game_state::party_members
	STA @VIRTUAL02
	SEP #PROC_FLAGS::ACCUM8
.ELSE
	LDY #.LOWORD(GAME_STATE) + game_state::party_members
	STY @LOCAL10
.ENDIF
	STZ_BADOPT @LOCAL00
	LDX #6
	REP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	LDA @VIRTUAL02
.ELSE
	TYA
.ENDIF
	JSL MEMSET16
.IF .DEFINED(JPN)
	LDY #.LOWORD(GAME_STATE) + game_state::unknown96
	STY @LOCAL10
.ELSE
	LDA #.LOWORD(GAME_STATE) + game_state::unknown96
	STA @VIRTUAL02
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	STZ_BADOPT @LOCAL00
	LDX #6
	REP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	TYA
.ELSE
	LDA @VIRTUAL02
.ENDIF
	JSL MEMSET16
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
.IF .DEFINED(JPN) ;reversed order?
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDY @LOCAL10
	STA __BSS_START__,Y
.ELSE
	LDY @LOCAL10
	STA __BSS_START__,Y
	LDX @VIRTUAL02
	STA __BSS_START__,X
.ENDIF
	REP #PROC_FLAGS::ACCUM8
	LDA #1
	STA ENEMIES_IN_BATTLE
	STA CURRENT_BATTLE_GROUP
	MOVE_INT f:BTL_ENTRY_PTR_TABLE+.SIZEOF(battle_entry_ptr_entry)+battle_entry_ptr_entry::pointer, @VIRTUAL06
	LDY #1
	LDA [@VIRTUAL06],Y
	STA ENEMIES_IN_BATTLE_IDS
@UNKNOWN0:
	STZ GIYGAS_PHASE
	LDA CURRENT_BATTLE_GROUP
	CMP #ENEMY_GROUP::UNKNOWN_475
	BNE @UNKNOWN1
	LDA #GIYGAS_PHASES::BATTLE_STARTED
	STA GIYGAS_PHASE
@UNKNOWN1:
	LOADPTR BTL_ENTRY_BG_TABLE, @VIRTUAL06
	LDA CURRENT_BATTLE_GROUP
	ASL
	ASL
	STA @LOCAL0F
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	STA @LOCAL0E
	LDA @LOCAL0F
	INC
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
.IF .DEFINED(JPN)
	STA @LOCAL0F
.ELSE
	STA @LOCAL0D
.ENDIF
	LDA CURRENT_BATTLE_GROUP
	ASL
	ASL
	ASL
	CLC
	ADC #battle_entry_ptr_entry::letterbox_style
	TAX
	LDA f:BTL_ENTRY_PTR_TABLE,X
	AND #$00FF
.IF .DEFINED(JPN)
	STA @LOCAL0D
.ELSE
	STA @LOCAL0C
.ENDIF
@UNKNOWN2:
.IF .DEFINED(USA)
	REP #PROC_FLAGS::ACCUM8
.ENDIF
	STZ MIRROR_ENEMY
.IF .DEFINED(JPN)
	STZ @LOCAL0C
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLE_ITEM_USED ;huh... usually mother 2 optimizes this worse
	REP #PROC_FLAGS::ACCUM8
	STZ @LOCAL0B
.ELSE
	STZ @LOCAL0B
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA BATTLE_ITEM_USED
	REP #PROC_FLAGS::ACCUM8
	STZ @LOCAL0A
.ENDIF
	STZ BATTLE_MONEY_SCRATCH
	MOVE_INT_CONSTANT 0, BATTLE_EXP_SCRATCH
	JSL UNKNOWN_C08726
	JSL UNKNOWN_C2E0E7
	JSL LOAD_ENEMY_BATTLE_SPRITES
	JSL LOAD_WINDOW_GFX
.IF .DEFINED(JPN)
	COPY_TO_VRAM1 BUFFER, $6000, $3800, $00
	LDY @LOCAL0D
	LDX @LOCAL0F
.ELSE
	LDA #1
	JSL UNKNOWN_C44963
	LDY @LOCAL0C
	LDX @LOCAL0D
.ENDIF
	LDA @LOCAL0E
	JSL LOAD_BATTLE_BG
	JSL UNKNOWN_C2EEE7
	LDY #0
.IF .DEFINED(JPN)
	STY @LOCAL0A
.ELSE
	STY @LOCAL10
.ENDIF
	BRA @UNKNOWN4
@UNKNOWN3:
	SEP #PROC_FLAGS::ACCUM8
	STZ_BADOPT @LOCAL00
	LDX #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	TYA
	TXY
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	JSL MEMSET16
.IF .DEFINED(JPN)
	LDY @LOCAL0A
	INY
	STY @LOCAL0A
.ELSE
	LDY @LOCAL10
	INY
	STY @LOCAL10
.ENDIF
@UNKNOWN4:
	CPY #BATTLER_COUNT
	BCC @UNKNOWN3
	STZ HIGHEST_ENEMY_LEVEL_IN_BATTLE
	LDY #0
	STY @LOCAL09
	STZ @LOCAL10
	JMP @UNKNOWN9
@UNKNOWN5:
.IF .DEFINED(JPN)
	LDA @LOCAL10
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_members,X
.ELSE
	LDY #.LOWORD(GAME_STATE) + game_state::party_members
	LDA (@LOCAL10),Y
.ENDIF
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
	LDA @VIRTUAL04
	BEQ @UNKNOWN7
	LDA @VIRTUAL04
	CMP #4
	BGT @UNKNOWN7
	LDA @LOCAL10
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	LDA @VIRTUAL04
	JSL BATTLE_INIT_PLAYER_STATS
	BRA @UNKNOWN8
@UNKNOWN7:
	LDA @VIRTUAL04
	CMP #5
	BCC @UNKNOWN8
	LDA @LOCAL10
	LDY #.SIZEOF(battler)
	JSL MULT168
	STA @VIRTUAL02
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	STX @LOCAL07
	LDA @VIRTUAL04
	ASL
	TAX
	INX
	LDA f:NPC_AI_TABLE,X
	AND #$00FF
	LDX @LOCAL07
	JSL BATTLE_INIT_ENEMY_STATS
	LDX @VIRTUAL02
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::ally_or_enemy,X
	REP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL04
	SEP #PROC_FLAGS::ACCUM8
	LDX @VIRTUAL02
	STA BATTLERS_TABLE+battler::npc_id,X
	LDY @LOCAL09
	REP #PROC_FLAGS::ACCUM8
	TYA
	SEP #PROC_FLAGS::ACCUM8
	LDX @VIRTUAL02
	STA BATTLERS_TABLE+16,X
	REP #PROC_FLAGS::ACCUM8
	TYA
	ASL
.IF .DEFINED(JPN)
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_npc_1_hp,X
.ELSE
	TAX
	LDA GAME_STATE+game_state::party_npc_1_hp,X
.ENDIF
	LDX @VIRTUAL02
	STA BATTLERS_TABLE+battler::hp_target,X
	LDX @VIRTUAL02
	STA BATTLERS_TABLE+battler::hp,X
	INY
	STY @LOCAL09
	LDX @VIRTUAL02
	STZ BATTLERS_TABLE+battler::pp_target,X
	LDX @VIRTUAL02
	STZ BATTLERS_TABLE+battler::pp,X
@UNKNOWN8:
	INC @LOCAL10
@UNKNOWN9:
	LDA @LOCAL10
	CMP #6
	BCCL @UNKNOWN5
	JSL UNKNOWN_C2F0D1
	LDY #0
	STY @LOCAL10
	BRA @UNKNOWN12
@UNKNOWN11:
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE) + (.SIZEOF(battler) * 8)
	TAX
	STX @LOCAL07
	LDY @LOCAL10
	TYA
	ASL
	TAX
	LDA ENEMIES_IN_BATTLE_IDS,X
	LDX @LOCAL07
	JSL BATTLE_INIT_ENEMY_STATS
	LDY @LOCAL10
	INY
	STY @LOCAL10
@UNKNOWN12:
	CPY ENEMIES_IN_BATTLE
	BCC @UNKNOWN11
	JSL UNKNOWN_C2F121
	JSL UNKNOWN_C2F8F9
	JSL UNKNOWN_C47F87
	LDA #24
	JSL UNKNOWN_C0856B
	LDA #1
	STA BATTLE_MODE_FLAG
	LDA ENEMIES_IN_BATTLE_IDS
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::music
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	JSL CHANGE_MUSIC
	JSL UNKNOWN_C08744
	LDX #1
	TXA
	JSL FADE_IN
	LDA BATTLE_MODE
	BNEL @UNKNOWN40
	LDA @LOCAL12
	JSL UNKNOWN_C1DCCB
	LDA #0
	STA @VIRTUAL02
	TAY
	STY @LOCAL10
	JMP @UNKNOWN19
@UNKNOWN14:
	REP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	TYA
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_members,X
.ELSE
	LDA GAME_STATE + game_state::party_members,Y
.ENDIF
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
	LDA @VIRTUAL04
	BEQ @UNKNOWN16
	LDA @VIRTUAL04
	CMP #4
	BGT @UNKNOWN16
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	LDA @VIRTUAL04
	JSL BATTLE_INIT_PLAYER_STATS
	JMP @UNKNOWN18
@UNKNOWN16:
	LDA @VIRTUAL04
	CMP #5
	BCCL @UNKNOWN18
	LOADPTR NPC_AI_TABLE, @VIRTUAL06
	LDA @VIRTUAL04
	ASL
.IF .DEFINED(JPN)
	STA @LOCAL09
.ELSE
	STA @LOCAL06
.ENDIF
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	AND #$00FF
	AND #$0001
	BEQ @UNKNOWN18
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
.IF .DEFINED(JPN)
	STA @LOCAL06
.ELSE
	STA @LOCAL09
.ENDIF
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	JSL BATTLE_INIT_ENEMY_STATS
	LDA @VIRTUAL02
	SEP #PROC_FLAGS::ACCUM8
	LDY #.LOWORD(BATTLERS_TABLE) + battler::row
.IF .DEFINED(JPN)
	STA (@LOCAL06),Y
.ELSE
	STA (@LOCAL09),Y
.ENDIF
	REP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL02
	ASL
.IF .DEFINED(JPN)
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_npc_1_hp,X
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp_target
	STA (@LOCAL06),Y
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp
	STA (@LOCAL06),Y
	INC @VIRTUAL02
	LDX @LOCAL06
	STZ BATTLERS_TABLE+battler::pp_target,X
	LDX @LOCAL06
	STZ BATTLERS_TABLE+battler::pp,X
	LDX @LOCAL06
.ELSE
	TAX
	LDA GAME_STATE+game_state::party_npc_1_hp,X
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp_target
	STA (@LOCAL09),Y
	LDY #.LOWORD(BATTLERS_TABLE) + battler::hp
	STA (@LOCAL09),Y
	INC @VIRTUAL02
	LDX @LOCAL09
	STZ BATTLERS_TABLE+battler::pp_target,X
	LDX @LOCAL09
	STZ BATTLERS_TABLE+battler::pp,X
	LDX @LOCAL09
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::ally_or_enemy,X
	REP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL04
	SEP #PROC_FLAGS::ACCUM8
	LDY #.LOWORD(BATTLERS_TABLE) + battler::npc_id
.IF .DEFINED(JPN)
	STA (@LOCAL06),Y
.ELSE
	STA (@LOCAL09),Y
.ENDIF
@UNKNOWN18:
	LDY @LOCAL10
	INY
	STY @LOCAL10
@UNKNOWN19:
	CPY #6
	BCCL @UNKNOWN14
	JSL REDIRECT_SHOW_HPPP_WINDOWS
	JSL WINDOW_TICK
@UNKNOWN21:
	.A16
	JSL WAIT_UNTIL_NEXT_FRAME
	JSL UNKNOWN_C2DB3F
	LDA PAD_PRESS
	AND #PAD::START_BUTTON
	BNEL @UNKNOWN39
	LDA PAD_PRESS
	AND #PAD::SELECT_BUTTON
	BEQ @UNKNOWN23
	LDA CURRENT_BATTLE_GROUP
	JSL ENEMY_SELECT_MODE
	STA @LOCAL10
	STA CURRENT_BATTLE_GROUP
	LOADPTR BTL_ENTRY_BG_TABLE, @VIRTUAL06
	LDA @LOCAL10
	ASL
	ASL
	TAX
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	STA @LOCAL0E
	TXA
	INC
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
.IF .DEFINED(JPN)
	STA @LOCAL0F
.ELSE
	STA @LOCAL0D
.ENDIF
	LDA @LOCAL10
	ASL
	ASL
	ASL
	CLC
	ADC #battle_entry_ptr_entry::letterbox_style
	TAX
	LDA f:BTL_ENTRY_PTR_TABLE,X
	AND #$00FF
.IF .DEFINED(JPN)
	STA @LOCAL0D
.ELSE
	STA @LOCAL0C
.ENDIF
	JMP @UNKNOWN32
@UNKNOWN23:
	LDA PAD_HELD
	AND #PAD::RIGHT
	BEQ @UNKNOWN24
	LDA @LOCAL11
	CMP #15
	BCS @UNKNOWN25
	INC @LOCAL11
	JMP @UNKNOWN32
@UNKNOWN24:
	LDA PAD_HELD
	AND #PAD::LEFT
	BEQ @UNKNOWN25
	LDA @LOCAL11
	CMP #1
	BLTEQ @UNKNOWN25
	DEC @LOCAL11
	JMP @UNKNOWN32
@UNKNOWN25:
	LDA PAD_HELD
	AND #PAD::DOWN
	BEQ @UNKNOWN26
	LDA @LOCAL12
	CMP #1
	BLTEQ @UNKNOWN27
	DEC @LOCAL12
	BRA @UNKNOWN32
@UNKNOWN26:
	LDA PAD_HELD
	AND #PAD::UP
	BEQ @UNKNOWN27
	LDA @LOCAL12
	CMP #MAX_LEVEL
	BCS @UNKNOWN27
	INC @LOCAL12
	BRA @UNKNOWN32
@UNKNOWN27:
	LDA PAD_PRESS
	AND #PAD::X_BUTTON
	BEQ @UNKNOWN28
	LDA HIGHEST_ENEMY_LEVEL_IN_BATTLE
	STA @LOCAL12
	BRA @UNKNOWN32
@UNKNOWN28:
	LDA PAD_PRESS
	AND #PAD::A_BUTTON
	BEQ @UNKNOWN29
	LDA DEBUGGING_CURRENT_PSI_ANIMATION
	JSL SHOW_PSI_ANIMATION
	LDX DEBUGGING_CURRENT_PSI_ANIMATION
	INX
	STX DEBUGGING_CURRENT_PSI_ANIMATION
	CPX #34
	BNE @UNKNOWN29
	STZ DEBUGGING_CURRENT_PSI_ANIMATION
@UNKNOWN29:
	LDA PAD_PRESS
	AND #PAD::B_BUTTON
	BEQL @UNKNOWN21
	LDX DEBUGGING_CURRENT_SWIRL_FLAGS
	LDA DEBUGGING_CURRENT_SWIRL
	JSL UNKNOWN_C4A67E
	LDX DEBUGGING_CURRENT_SWIRL
	INX
	STX DEBUGGING_CURRENT_SWIRL
	CPX #8
	BNEL @UNKNOWN21
	STZ DEBUGGING_CURRENT_SWIRL
	LDA DEBUGGING_CURRENT_SWIRL_FLAGS
	INC
	AND #$0003
	STA DEBUGGING_CURRENT_SWIRL_FLAGS
	JMP @UNKNOWN21
@UNKNOWN32:
.IF .DEFINED(JPN)
	LDA #0
	STA @LOCAL0B
.ELSE
	LDX #0
.ENDIF
	LDA @LOCAL11
	AND #$0001
	BEQ @UNKNOWN33
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA GAME_STATE + game_state::party_members
.IF .DEFINED(JPN)
	REP #PROC_FLAGS::ACCUM8
	LDA #1
	STA @LOCAL0B
.ELSE
	LDX #1
.ENDIF
@UNKNOWN33:
.IF .DEFINED(JPN)
	LDA @LOCAL11
	AND #$0002
	BEQ @UNKNOWN34
	LDA @LOCAL0B
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA #2
	STA a:game_state::party_members,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0B
	INC
	STA @LOCAL0B
.ELSE
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL11
	AND #$0002
	BEQ @UNKNOWN34
	SEP #PROC_FLAGS::ACCUM8
	LDA #2
	STA GAME_STATE + game_state::party_members,X
	INX
.ENDIF
@UNKNOWN34:
.IF .DEFINED(JPN)
	LDA @LOCAL11
	AND #$0004
	BEQ @UNKNOWN35
	LDA @LOCAL0B
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA #3
	STA a:game_state::party_members,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0B
	INC
	STA @LOCAL0B
.ELSE
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL11
	AND #$0004
	BEQ @UNKNOWN35
	SEP #PROC_FLAGS::ACCUM8
	LDA #3
	STA GAME_STATE + game_state::party_members,X
	INX
.ENDIF
@UNKNOWN35:
.IF .DEFINED(JPN)
	LDA @LOCAL11
	AND #$0008
	BEQ @UNKNOWN36
	LDA @LOCAL0B
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA #4
	STA a:game_state::party_members,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0B
	INC
	STA @LOCAL0B
.ELSE
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL11
	AND #$0008
	BEQ @UNKNOWN36
	SEP #PROC_FLAGS::ACCUM8
	LDA #4
	STA GAME_STATE + game_state::party_members,X
	INX
.ENDIF
@UNKNOWN36:
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	REP #PROC_FLAGS::ACCUM8
	TXA
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	STA GAME_STATE+game_state::player_controlled_party_count
	BRA @UNKNOWN38
@UNKNOWN37:
	.A16
.IF .DEFINED(JPN) ;wow
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	SEP #PROC_FLAGS::ACCUM8
	STZ a:game_state::party_members,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0B
	INC
	STA @LOCAL0B
.ELSE
	STZ GAME_STATE + game_state::party_members,X
	INX
.ENDIF
@UNKNOWN38:
.IF .DEFINED(JPN)
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0B
	CMP #$0006
.ELSE
	CPX #6
.ENDIF
	BCC @UNKNOWN37
	JMP @UNKNOWN2
@UNKNOWN39:
	LDA ENEMIES_IN_BATTLE_IDS
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	.A16
	CLC
	ADC #enemy_data::music
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	JSL CHANGE_MUSIC
@UNKNOWN40:
	LDA #EVENT_FLAG::FLG_BUNBUN
	JSL GET_EVENT_FLAG
	CMP #0
	BEQ @UNKNOWN41
	LDX #.LOWORD(BATTLERS_TABLE)+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)
	LDA #ENEMY::BUZZ_BUZZ
	JSL BATTLE_INIT_ENEMY_STATS
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+16
	STZ BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::ally_or_enemy
	LDA #ENEMY::BUZZ_BUZZ
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::npc_id
@UNKNOWN41:
.IF .DEFINED(JPN)
	REP #PROC_FLAGS::ACCUM8
	LDA #0
	STA @LOCAL07
.ELSE
	LDX #0
	STX @LOCAL07
.ENDIF
	BRA @UNKNOWN45
@UNKNOWN42:
.IF .DEFINED(JPN)
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_members,X
.ELSE
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE + game_state::party_members,X
.ENDIF
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
	LDA @VIRTUAL04
	BEQ @UNKNOWN44
	LDA @VIRTUAL04
	CMP #4
	BGT @UNKNOWN44
	LDA @VIRTUAL04
	DEC
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS)+char_struct::afflictions
	TAX
	LDA a:STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::POSSESSED
	BNE @UNKNOWN44
	LDX #.LOWORD(BATTLERS_TABLE)+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)
	LDA #ENEMY::TINY_LIL_GHOST
	JSL BATTLE_INIT_ENEMY_STATS
	SEP #PROC_FLAGS::ACCUM8
	LDA #ENEMY::TINY_LIL_GHOST
	STA BATTLERS_TABLE+(TOTAL_PARTY_COUNT)*.SIZEOF(battler)+battler::npc_id
	BRA @UNKNOWN46
@UNKNOWN44:
.IF .DEFINED(JPN)
	LDA @LOCAL07
	INC
	STA @LOCAL07
.ELSE
	LDX @LOCAL07
	INX
	STX @LOCAL07
.ENDIF
@UNKNOWN45:
	.A16
.IF .DEFINED(JPN)
	CMP #TOTAL_PARTY_COUNT
.ELSE
	CPX #TOTAL_PARTY_COUNT
.ENDIF
	BCC @UNKNOWN42
@UNKNOWN46:
	JSL REDIRECT_SHOW_HPPP_WINDOWS
	LDA ENEMIES_IN_BATTLE
	JSR RAND_LIMIT
	.A16
	ASL
	TAX
	LDA ENEMIES_IN_BATTLE_IDS,X
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL06
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	.A16
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	CLC
	ADC #enemy_data::item_dropped
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	AND #$00FF
	STA ITEM_DROPPED
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	CLC
	ADC #enemy_data::item_drop_rate
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	BEQ @RARITY_ZERO
	CMP #1
	BEQ @RARITY_ONE
	CMP #2
	BEQ @RARITY_TWO
	CMP #3
	BEQ @RARITY_THREE
	CMP #4
	BEQ @RARITY_FOUR
	CMP #5
	BEQ @RARITY_FIVE
	CMP #6
	BEQ @RARITY_SIX
	BRA @RARITY_SEVEN
@RARITY_ZERO:
	JSL RAND
	AND #$007F ;1/2
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_ONE:
	JSL RAND
	AND #$003F ;1/4
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_TWO:
	JSL RAND
	AND #$001F ;1/8
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_THREE:
	JSL RAND
	AND #$000F ;1/16
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_FOUR:
	JSL RAND
	AND #$0007 ;1/32
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_FIVE:
	JSL RAND
	AND #$0003 ;1/64
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
	BRA @RARITY_SEVEN
@RARITY_SIX:
	JSL RAND
	AND #$0001 ;1/128
	BEQ @RARITY_SEVEN
	STZ ITEM_DROPPED
@RARITY_SEVEN: ;Item dropped or 0% chance of drop occurring
	LDA ITEM_DROPPED
	BNEL @END_ITEM_DROP
	LDX #0
	STX @LOCAL10
	BRA @CONSOLATION_OUTER_LOOP_ENTRY
@CONSOLATION_OUTER_LOOP_BEGIN:
	LDY #8
.IF .DEFINED(JPN)
	STY @LOCAL0A
.ELSE
	STY @LOCAL0F
.ENDIF
	BRA @CONSOLATION_INNER_LOOP_ENTRY
@CONSOLATION_INNER_LOOP_BEGIN:
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	.A16
	STA @LOCAL09
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQ @ENEMY_NOT_IN_CONSOLATION_TABLE
	LOADPTR CONSOLATION_ITEM_TABLE, @VIRTUAL06
	LDX @LOCAL10
	TXA
	OPTIMIZED_MULT @VIRTUAL04, 9
	STA @VIRTUAL02
	LDA @LOCAL09
	TAX
	LDA @VIRTUAL02
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	AND #$00FF
	CMP BATTLERS_TABLE + battler::id,X
	BNE @ENEMY_NOT_IN_CONSOLATION_TABLE
	LDA #7
	JSR RAND_LIMIT
	PHA
	LDA @VIRTUAL02
	PLY
	STY @VIRTUAL02
	CLC
	ADC @VIRTUAL02
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	STA ITEM_DROPPED
@ENEMY_NOT_IN_CONSOLATION_TABLE:
.IF .DEFINED(JPN)
	LDY @LOCAL0A
	INY
	STY @LOCAL0A
.ELSE
	LDY @LOCAL0F
	INY
	STY @LOCAL0F
.ENDIF
@CONSOLATION_INNER_LOOP_ENTRY:
	CPY #BATTLER_COUNT
	BCC @CONSOLATION_INNER_LOOP_BEGIN
	LDX @LOCAL10
	INX
	STX @LOCAL10
@CONSOLATION_OUTER_LOOP_ENTRY:
	CPX #2
	BCCL @CONSOLATION_OUTER_LOOP_BEGIN
@END_ITEM_DROP:
.IF .DEFINED(JPN)
	STZ @LOCAL09
.ELSE
	STZ @LOCAL06
.ENDIF
	LDA BATTLE_INITIATIVE
	BEQ @UNKNOWN64
	CMP #1
	BEQ @UNKNOWN62
	CMP #2
	BEQ @UNKNOWN63
	BRA @UNKNOWN64
@UNKNOWN62:
	LDA #INITIATIVE::PARTY_FIRST
.IF .DEFINED(JPN)
	STA @LOCAL09
.ELSE
	STA @LOCAL06
.ENDIF
	BRA @UNKNOWN64
@UNKNOWN63:
	LDA #INITIATIVE::ENEMIES_FIRST
.IF .DEFINED(JPN)
	STA @LOCAL09
.ELSE
	STA @LOCAL06
.ENDIF
@UNKNOWN64:
	STZ BATTLE_INITIATIVE
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
	;TODO: why 8?
	LDA #.LOWORD(BATTLERS_TABLE)+8*.SIZEOF(battler)
	STA CURRENT_ATTACKER
	LDA #1
	JSL FIX_ATTACKER_NAME
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL0A
	LDA ENEMIES_IN_BATTLE_IDS
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::encounter_text_ptr
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	JSL DISPLAY_IN_BATTLE_TEXT
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #INITIATIVE::PARTY_FIRST
	BNE @UNKNOWN65
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SENSEI_PC
@UNKNOWN65:
	LDA #0
	STA @LOCAL10
	BRA @UNKNOWN70
@UNKNOWN66:
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)+8*.SIZEOF(battler)
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+2,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BNE @UNKNOWN67
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_NEMURI
@UNKNOWN67:
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+4,X
	AND #$00FF
	BEQ @UNKNOWN68
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_FUUIN
@UNKNOWN68:
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+3,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN69
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_AT_START_HEN
@UNKNOWN69:
	LDA @LOCAL10
	INC
	STA @LOCAL10
@UNKNOWN70:
	CMP ENEMIES_IN_BATTLE
	BCC @UNKNOWN66
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
.IF .DEFINED(JPN)
	STZ @LOCAL06
	LDA @LOCAL06
.ELSE
	STZ @LOCAL09
	LDA @LOCAL09
.ENDIF
	STA SPECIAL_DEFEAT
	JMP @UNKNOWN236
@UNKNOWN71:
.IF .DEFINED(JPN)
	INC @LOCAL0B
.ELSE
	INC @LOCAL0A
.ENDIF
	JSL UNKNOWN_C2F917
	LDY #.LOWORD(BATTLERS_TABLE)
	STY @LOCAL10
	LDX #0
	STX @LOCAL05
	BRA @UNKNOWN74
@UNKNOWN72:
	TYX
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::has_taken_turn,X
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN73
	TYA
	CLC
	ADC #battler::initiative
	STA @VIRTUAL02
	LDA a:battler::speed,Y
	JSR FIFTY_PERCENT_VARIANCE
	LDX @VIRTUAL02
	STA __BSS_START__,X
	CMP #0
	BNE @UNKNOWN73
	LDA #1
	LDX @VIRTUAL02
	STA __BSS_START__,X
@UNKNOWN73:
	LDY @LOCAL10
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
	STY @LOCAL10
	LDX @LOCAL05
	INX
	STX @LOCAL05
@UNKNOWN74:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN72
	LDA #0
	STA @LOCAL10
	BRA @UNKNOWN76
@UNKNOWN75:
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	TAX
	SEP #PROC_FLAGS::ACCUM8
	STZ PARTY_CHARACTERS + char_struct::unknown94,X
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL10
	INC
	STA @LOCAL10
@UNKNOWN76:
	CMP #4
	BCC @UNKNOWN75
	LDY #0
	STY @LOCAL04
	TYA
	STA @VIRTUAL02
	JMP @UNKNOWN106
@UNKNOWN77:
	JSL CHECK_DEAD_PLAYERS
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BNE @UNKNOWN78
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
	JMP @UNKNOWN225
@UNKNOWN78:
.IF .DEFINED(JPN)
	LDA @VIRTUAL02
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_members,X
.ELSE
	LDX @VIRTUAL02
	LDA GAME_STATE + game_state::party_members,X
.ENDIF
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
	LDA @VIRTUAL04
	BEQL @UNKNOWN105
	LDA @VIRTUAL04
	CMP #4
	BGTL @UNKNOWN105
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #2
	BEQ @UNKNOWN82
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #3
	BEQ @UNKNOWN82
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #4
	BEQ @UNKNOWN82
	LDA @VIRTUAL04
	CMP #4
	BNE @UNKNOWN81
	LDA MIRROR_ENEMY
	BNE @UNKNOWN82
@UNKNOWN81:
	LDA @VIRTUAL04
	DEC
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS)+char_struct::afflictions
	TAX
	LDA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::UNCONSCIOUS
	BEQ @UNKNOWN82
	CMP #STATUS_0::DIAMONDIZED
	BEQ @UNKNOWN82
	LDA a:STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	TAX
	CPX #STATUS_2::ASLEEP
	BEQ @UNKNOWN82
	CPX #STATUS_2::SOLIDIFIED
	BNE @UNKNOWN83
@UNKNOWN82:
	LDA #BATTLE_ACTIONS::NO_EFFECT
	STA @LOCAL07
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLE_ITEM_USED
	JMP @UNKNOWN91
@UNKNOWN83:
	LDA @VIRTUAL02
	JSL REDIRECT_C43573
	LDY @LOCAL04
	TYX
	LDA @VIRTUAL04
	JSL BATTLE_SELECTION_MENU
	.A16
	STA @LOCAL07
	JSL REDIRECT_C3E6F8
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
	LDA BATTLE_MODE
	BEQ @UNKNOWN84
	LDA @LOCAL07
	CMP #$FFFF
	BNE @UNKNOWN84
	STZ @LOCAL03
	JMP @UNKNOWN237
@UNKNOWN84:
	LDA @LOCAL07
	CMP #BATTLE_ACTIONS::RUN_AWAY
	BNE @UNKNOWN87
	LDA #BATTLE_ACTIONS::USE_NO_EFFECT
	STA @LOCAL07
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #1
	BNE @UNKNOWN85
	LDA #4
.IF .DEFINED(JPN)
	STA @LOCAL09
.ELSE
	STA @LOCAL06
.ENDIF
	BRA @UNKNOWN86
@UNKNOWN85:
	LDA #3
.IF .DEFINED(JPN)
	STA @LOCAL09
.ELSE
	STA @LOCAL06
.ENDIF
@UNKNOWN86:
	LDA #1
.IF .DEFINED(JPN)
	STA @LOCAL0C
.ELSE
	STA @LOCAL0B
.ENDIF
@UNKNOWN87:
	LDA @LOCAL07
	CMP #$FFFF
	BEQL @UNKNOWN2
	CMP #0
	BNE @UNKNOWN90
	LDY @LOCAL04
	BEQL @UNKNOWN77
	DEY
	STY @LOCAL04
	TYA
	ASL
	TAX
	LDA PARTY_MEMBERS_WITH_SELECTED_ACTIONS,X
	STA @VIRTUAL02
	JMP @UNKNOWN77
@UNKNOWN90:
	LDY @LOCAL04
	TYA
	ASL
	TAX
	LDA @VIRTUAL02
	STA PARTY_MEMBERS_WITH_SELECTED_ACTIONS,X
	INY
	STY @LOCAL04
	LDA @LOCAL07
	CMP #1
	BNE @UNKNOWN91
	LDA #0
	STA @LOCAL07
@UNKNOWN91:
	REP #PROC_FLAGS::ACCUM8
	STZ @LOCAL05
	JMP @UNKNOWN104
@UNKNOWN92:
	LDA @LOCAL05
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQL @UNKNOWN103
	LDA BATTLERS_TABLE+battler::ally_or_enemy,X
	AND #$00FF
	BNEL @UNKNOWN103
	LDA @VIRTUAL04
	CMP BATTLERS_TABLE + battler::id,X
	BNEL @UNKNOWN103
	LDA @LOCAL07
	STA BATTLERS_TABLE+battler::current_action,X
	LDA BATTLE_ITEM_USED
	AND #$00FF
	BEQ @UNKNOWN96
	SEP #PROC_FLAGS::ACCUM8
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::param1
	STA BATTLERS_TABLE+7,X
	LDA BATTLE_ITEM_USED
	STA BATTLERS_TABLE+battler::current_action_argument,X
	BRA @UNKNOWN97
@UNKNOWN96:
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+7,X
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::param1
	STA BATTLERS_TABLE+battler::current_action_argument,X
@UNKNOWN97:
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL05
	LDY #.SIZEOF(battler)
	JSL MULT168
.IF .DEFINED(JPN)
	TAX
	STX @LOCAL0A
	LDA #.LOWORD(BATTLE_MENU_SELECTION) + battle_menu_selection::targetting
	STA @LOCAL07
	TAX
.ELSE
	STA @LOCAL07
	LDX #.LOWORD(BATTLE_MENU_SELECTION) + battle_menu_selection::targetting
	STX @LOCAL0F
	PHA
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
.IF .DEFINED(JPN)
	LDX @LOCAL0A
.ELSE
	PLX
.ENDIF
	STA BATTLERS_TABLE + battler::action_targetting,X
.IF .DEFINED(USA)
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL07
	TAX
	SEP #PROC_FLAGS::ACCUM8
.ENDIF
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::selected_target
	STA BATTLERS_TABLE + battler::current_target,X
.IF .DEFINED(JPN)
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL07
	TAX
.ELSE
	LDX @LOCAL0F
	REP #PROC_FLAGS::ACCUM8
.ENDIF
	LDA __BSS_START__,X
	AND #$00FF
	CMP #1
	BNE @UNKNOWN101
	LDA #0
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	BRA @UNKNOWN100
@UNKNOWN98:
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN99
	LDA BATTLERS_TABLE+battler::npc_id,X
	AND #$00FF
	BNE @UNKNOWN99
	LDA BATTLE_MENU_SELECTION + battle_menu_selection::selected_target
	AND #$00FF
	CMP BATTLERS_TABLE+battler::id,X
	BNE @UNKNOWN99
	LDA @LOCAL05
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	INC
	STA BATTLERS_TABLE+battler::current_target,X
	BRA @UNKNOWN101
@UNKNOWN99:
.IF .DEFINED(JPN)
	LDA @LOCAL0A
	INC
	STA @LOCAL0A
.ELSE
	LDA @LOCAL0F
	INC
	STA @LOCAL0F
.ENDIF
@UNKNOWN100:
	.A16
	CMP #6
	BCC @UNKNOWN98
@UNKNOWN101:
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL05
	LDY #.SIZEOF(battler)
	JSL MULT168
	TAX
	LDA BATTLERS_TABLE+battler::current_action,X
	CMP #BATTLE_ACTIONS::GUARD
	BNE @UNKNOWN102
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA BATTLERS_TABLE+battler::guarding,X
	BRA @UNKNOWN105
@UNKNOWN102:
	SEP #PROC_FLAGS::ACCUM8
	STZ BATTLERS_TABLE+battler::guarding,X
	BRA @UNKNOWN105
@UNKNOWN103:
	INC @LOCAL05
@UNKNOWN104:
	.A16
	LDA @LOCAL05
	CMP #BATTLER_COUNT
	BCCL @UNKNOWN92
@UNKNOWN105:
	REP #PROC_FLAGS::ACCUM8
	INC @VIRTUAL02
@UNKNOWN106:
	LDA @VIRTUAL02
	CMP #6
	BCCL @UNKNOWN77
	LDA #.LOWORD(BATTLERS_TABLE)
.IF .DEFINED(USA)
	STA @VIRTUAL02
.ENDIF
	STA @LOCAL04
	LDY #0
.IF .DEFINED(JPN)
	STY @LOCAL05
.ELSE
	STY @LOCAL07
.ENDIF
	JMP @UNKNOWN132
@UNKNOWN108:
.IF .DEFINED(JPN)
	LDY #battler::consciousness
	LDA (@LOCAL04),Y
	AND #$00FF
	BEQ @UNKNOWN109
	LDY #battler::ally_or_enemy
	LDA (@LOCAL04),Y
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN109
	LDX @VIRTUAL02
	LDA a:battler::ally_or_enemy,X
.ENDIF
	AND #$00FF
	CMP #1
	BEQ @UNKNOWN111
@UNKNOWN109:
.IF .DEFINED(JPN)
	LDY #battler::npc_id
	LDA (@LOCAL04),Y
	AND #$00FF
	BNE @UNKNOWN111
	LDA (@LOCAL04)
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::npc_id,X
	AND #$00FF
	BNE @UNKNOWN111
	LDX @VIRTUAL02
	LDA a:battler::id,X
.ENDIF
	CMP #PARTY_MEMBER::POO
	BNEL @UNKNOWN131
	LDA MIRROR_ENEMY
	BEQL @UNKNOWN131
@UNKNOWN111:
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #1
	BEQ @UNKNOWN112
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #4
	BNE @UNKNOWN113
@UNKNOWN112:
.IF .DEFINED(JPN)
	LDY #battler::ally_or_enemy
	LDA (@LOCAL04),Y
	AND #$00FF
	CMP #1
	BNE @UNKNOWN113
	LDX @LOCAL04
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #1
	BNE @UNKNOWN113
	LDX @VIRTUAL02
.ENDIF
	STZ a:battler::current_action,X
	JMP @UNKNOWN131
@UNKNOWN113:
.IF .DEFINED(JPN)
	LDA @LOCAL09
	CMP #$0002
	BNE @UNKNOWN114
	LDY #battler::ally_or_enemy
	LDA (@LOCAL04),Y
	AND #$00FF
	BNE @UNKNOWN114
	LDX @LOCAL04
.ELSE
	LDA @LOCAL06
	CMP #2
	BNE @UNKNOWN114
	LDX @VIRTUAL02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN114
	LDX @VIRTUAL02
.ENDIF
	STZ a:battler::current_action,X
	JMP @UNKNOWN131
@UNKNOWN114:
.IF .DEFINED(JPN)
	LDY #battler::ally_or_enemy
	LDA (@LOCAL04),Y
	AND #$00FF
	BNE @UNKNOWN115
	LDA (@LOCAL04)
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN115
	LDX @VIRTUAL02
	LDA a:battler::id,X
.ENDIF
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN115
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL06
	LDA MIRROR_ENEMY
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	BRA @UNKNOWN116
@UNKNOWN115:
	LOADPTR ENEMY_CONFIGURATION_TABLE, @VIRTUAL06
.IF .DEFINED(JPN)
	LDA (@LOCAL04)
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::id,X
.ENDIF
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
@UNKNOWN116:
	SEP #PROC_FLAGS::ACCUM8
	LDY #enemy_data::action_order
	LDA [@VIRTUAL06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BEQ @ACTION_PATTERN_1
	CMP #1
	BEQ @ACTION_PATTERN_2
	CMP #2
	BEQ @ACTION_PATTERN_3
	CMP #3
	BEQ @ACTION_PATTERN_4
	JMP @UNKNOWN125
@ACTION_PATTERN_1:
	JSL RAND
	AND #$0003
	STA @VIRTUAL04
	STA @LOCAL08
	JMP @UNKNOWN125
@ACTION_PATTERN_2:
	JSL RAND
	AND #$0007
	BEQ @ACTION_PATTERN_2_4TH
	CMP #1
	BEQ @ACTION_PATTERN_2_3RD
	CMP #2
	BEQ @ACTION_PATTERN_2_2ND
	CMP #3
	BEQ @ACTION_PATTERN_2_2ND
	BRA @ACTION_PATTERN_2_1ST
@ACTION_PATTERN_2_4TH:
	LDA #3
	STA @VIRTUAL04
	STA @LOCAL08
	BRA @UNKNOWN125
@ACTION_PATTERN_2_3RD:
	LDA #2
	STA @VIRTUAL04
	STA @LOCAL08
	BRA @UNKNOWN125
@ACTION_PATTERN_2_2ND:
	LDA #1
	STA @VIRTUAL04
	STA @LOCAL08
	BRA @UNKNOWN125
@ACTION_PATTERN_2_1ST:
	LDA #0
	STA @VIRTUAL04
	STA @LOCAL08
	BRA @UNKNOWN125
@ACTION_PATTERN_3:
.IF .DEFINED(JPN)
	LDA @LOCAL04
.ELSE
	LDA @VIRTUAL02
.ENDIF
	CLC
	ADC #battler::action_order_var
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA @LOCAL02
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
	SEP #PROC_FLAGS::ACCUM8
	LDA @LOCAL02
	INC
	AND #$0003
	STA __BSS_START__,X
	BRA @UNKNOWN125
@ACTION_PATTERN_4:
	.A16
.IF .DEFINED(JPN)
	LDA @LOCAL04
.ELSE
	LDA @VIRTUAL02
.ENDIF
	CLC
	ADC #battler::action_order_var
	TAX
	STX @LOCAL10
	LDA __BSS_START__,X
	AND #$00FF
	ASL
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	JSL RAND
.IF .DEFINED(JPN)
	STA @VIRTUAL02
.ELSE
	STA @VIRTUAL04
.ENDIF
	AND #$0001
	STA @VIRTUAL02
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	CLC
	ADC @VIRTUAL02
	STA @VIRTUAL04
	STA @LOCAL08
	LDX @LOCAL10
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	INC
	AND #$0001
	STA __BSS_START__,X
@UNKNOWN125:
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL04
.IF .DEFINED(USA)
	STA @VIRTUAL02
.ENDIF
	INC
	INC
	INC
	INC
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	TAX
	LDA @LOCAL08
	STA @VIRTUAL04
	ASL
	CLC
	ADC #enemy_data::actions
	MOVE_INTY @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	STA __BSS_START__,X
.IF .DEFINED(JPN)
	LDA @LOCAL04
.ELSE
	LDA @VIRTUAL02
.ENDIF
	CLC
	ADC #8
	TAX
	STX @LOCAL10
	LDA @VIRTUAL04
	CLC
	ADC #enemy_data::action_args
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL06]
	STA @VIRTUAL00
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	TAX
	LDA __BSS_START__,X
	CMP #BATTLE_ACTIONS::ENEMY_EXTENDER
	BNE @UNKNOWN127
.IF .DEFINED(JPN)
	LDY #battler::ally_or_enemy
	LDA (@LOCAL04),Y
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::ally_or_enemy,X
.ENDIF
	AND #$00FF
	BNE @UNKNOWN126
.IF .DEFINED(JPN)
	LDA (@LOCAL04)
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::id,X
.ENDIF
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN126
	LDA @VIRTUAL00
	AND #$00FF
	STA MIRROR_ENEMY
	JMP @UNKNOWN114
@UNKNOWN126:
.IF .DEFINED(JPN)
	LDY #battler::current_action_argument
	LDA (@LOCAL04),Y
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::current_action_argument,X
.ENDIF
	AND #$00FF
.IF .DEFINED(JPN)
	STA (@LOCAL04)
.ELSE
	LDX @VIRTUAL02
	STA a:battler::id,X
.ENDIF
	JMP @UNKNOWN114
@UNKNOWN127:
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN128
	JSL SELECT_STEALABLE_ITEM
	SEP #PROC_FLAGS::ACCUM8
	LDX @LOCAL10
	STA __BSS_START__,X
.IF .DEFINED(JPN)
	LDX @LOCAL04
.ELSE
	LDX @VIRTUAL02
.ENDIF
	REP #PROC_FLAGS::ACCUM8
	STZ a:battler::initiative,X
@UNKNOWN128:
.IF .DEFINED(JPN)
	LDY #battler::current_action
	LDA (@LOCAL04),Y
.ELSE
	LDX @VIRTUAL02
	LDA a:battler::current_action,X
.ENDIF
	CMP #BATTLE_ACTIONS::ON_GUARD
	BNE @NOT_DEFENDING
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
.IF .DEFINED(JPN)
	LDY #battler::guarding
	STA (@LOCAL04),Y
.ELSE
	LDX @VIRTUAL02
	STA a:battler::guarding,X
.ENDIF
	BRA @UNKNOWN130
@NOT_DEFENDING:
.IF .DEFINED(JPN)
	LDX @LOCAL04
.ELSE
	LDX @VIRTUAL02
.ENDIF
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::guarding,X
@UNKNOWN130:
	REP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	LDA @LOCAL04
.ELSE
	LDA @VIRTUAL02
.ENDIF
	JSL CHOOSE_TARGET
@UNKNOWN131:
.IF .DEFINED(JPN)
	LDA @LOCAL04
.ELSE
	LDA @VIRTUAL02
.ENDIF
	CLC
	ADC #.SIZEOF(battler)
.IF .DEFINED(USA)
	STA @VIRTUAL02
.ENDIF
	STA @LOCAL04
.IF .DEFINED(JPN)
	LDY @LOCAL05
	INY
	STY @LOCAL05
.ELSE
	LDY @LOCAL07
	INY
	STY @LOCAL07
.ENDIF
@UNKNOWN132:
	CPY #BATTLER_COUNT
	BCCL @UNKNOWN108
	CREATE_WINDOW_FAR #WINDOW::TEXT_BATTLE
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #INITIATIVE::ENEMIES_FIRST
	BNE @UNKNOWN134
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SENSEI_MON
@UNKNOWN134:
.IF .DEFINED(JPN)
	LDA @LOCAL0C
.ELSE
	LDA @LOCAL0B
.ENDIF
	BEQL @UNKNOWN144
	LDY #.LOWORD(BATTLERS_TABLE)
.IF .DEFINED(JPN)
	STY @LOCAL0C
.ELSE
	STY @LOCAL0F
.ENDIF
	STZ @LOCAL05
	LDA #0
	STA @VIRTUAL04
	STA @LOCAL08
	STA @VIRTUAL02
	JMP @UNKNOWN140
@UNKNOWN136:
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN139
	LDA a:battler::npc_id,Y
	AND #$00FF
	BNE @UNKNOWN139
	LDA a:battler::ally_or_enemy,Y
	AND #$00FF
	CMP #1
	BNE @UNKNOWN138
	LDA a:battler::id,Y
	LDY #.SIZEOF(enemy_data)
	JSL MULT168
	CLC
	ADC #enemy_data::boss
	TAX
	LDA f:ENEMY_CONFIGURATION_TABLE,X
	AND #$00FF
	BNEL @UNKNOWN143
.IF .DEFINED(JPN)
	LDY @LOCAL0C
.ELSE
	LDY @LOCAL0F
.ENDIF
	LDA a:battler::afflictions,Y
	AND #$00FF
	TAX
	CPX #1
	BEQ @UNKNOWN139
	CPX #2
	BEQ @UNKNOWN139
	CPX #3
	BEQ @UNKNOWN139
	LDA a:battler::afflictions+2,Y
	AND #$00FF
	TAX
	CPX #1
	BEQ @UNKNOWN139
	CPX #3
	BEQ @UNKNOWN139
	CPX #4
	BEQ @UNKNOWN139
	LDA a:battler::speed,Y
	CMP @VIRTUAL04
	BLTEQ @UNKNOWN139
	STA @VIRTUAL04
	STA @LOCAL08
	BRA @UNKNOWN139
@UNKNOWN138:
	LDA a:battler::speed,Y
	CMP @LOCAL05
	BLTEQ @UNKNOWN139
	STA @LOCAL05
@UNKNOWN139:
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
.IF .DEFINED(JPN)
	STY @LOCAL0C
.ELSE
	STY @LOCAL0F
.ENDIF
	INC @VIRTUAL02
@UNKNOWN140:
	LDA @VIRTUAL02
	CMP #BATTLER_COUNT
	BCCL @UNKNOWN136
	LDA @VIRTUAL04
	BEQ @UNKNOWN142
.IF .DEFINED(JPN)
	LDA @LOCAL09
.ELSE
	LDA @LOCAL06
.ENDIF
	CMP #4
	BEQ @UNKNOWN142
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0A
.ENDIF
	OPTIMIZED_MULT @VIRTUAL04, 10
	CLC
	ADC @LOCAL05
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL0C
.ELSE
	STX @LOCAL0F
.ENDIF
	LDA @LOCAL08
	STA @VIRTUAL04
	TXA
	CMP @VIRTUAL04
	BCC @UNKNOWN143
	LDA #100
	JSR RAND_LIMIT
.IF .DEFINED(JPN)
	STA @LOCAL0A
	LDX @LOCAL0C
.ELSE
	STA @LOCAL0B
	LDX @LOCAL0F
.ENDIF
	TXA
	SEC
	SBC @VIRTUAL04
	STA @VIRTUAL02
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0B
.ENDIF
	CMP @VIRTUAL02
	BCS @UNKNOWN143
@UNKNOWN142:
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PLAYER_FLEE
	STZ @LOCAL03
	JMP @UNKNOWN237
@UNKNOWN143:
.IF .DEFINED(JPN)
	STZ @LOCAL0C
.ELSE
	STZ @LOCAL0B
.ENDIF
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PLAYER_FLEE_NG
@UNKNOWN144:
.IF .DEFINED(JPN)
	STZ @LOCAL09
.ELSE
	STZ @LOCAL06
.ENDIF
	JMP @UNKNOWN234
@UNKNOWN145:
	JSL CHECK_DEAD_PLAYERS
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BEQL @UNKNOWN225
	LDA #1
	JSL COUNT_CHARS
	CMP #0
	BEQL @UNKNOWN225
	LDA #$FFFF
	STA @VIRTUAL04
	STA @LOCAL08
.IF .DEFINED(JPN)
	LDY #$0000
	STY @LOCAL05
	TYA
.ELSE
	LDX #0
	TXA
.ENDIF
	STA @LOCAL10
	BRA @UNKNOWN150
@UNKNOWN148:
	LDY #.SIZEOF(battler)
	JSL MULT168
.IF .DEFINED(JPN)
	TAX
	LDA BATTLERS_TABLE+battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN149
	LDA BATTLERS_TABLE+13,X
	AND #$00FF
	BNE @UNKNOWN149
	LDA BATTLERS_TABLE+70,X
	TAX
	LDY @LOCAL05
	STY @VIRTUAL02
	TXA
.ELSE
	TAY
	LDA BATTLERS_TABLE+battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN149
	LDA BATTLERS_TABLE+13,Y
	AND #$00FF
	BNE @UNKNOWN149
	LDA BATTLERS_TABLE+70,Y
	TAY
	STX @VIRTUAL02
	TYA
.ENDIF
	CMP @VIRTUAL02
	BCC @UNKNOWN149
	LDA @LOCAL10
	STA @VIRTUAL04
	STA @LOCAL08
.IF .DEFINED(JPN)
	TXY
	STY @LOCAL05
.ELSE
	TYX
.ENDIF
@UNKNOWN149:
	LDA @LOCAL10
	INC
	STA @LOCAL10
@UNKNOWN150:
	CMP #BATTLER_COUNT
	BCC @UNKNOWN148
	LDA @VIRTUAL04
	CMP #$FFFF
	BEQL @UNKNOWN235
	JSL REDIRECT_C10FA3
	LDA @VIRTUAL04
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	TAX
	STX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA a:battler::has_taken_turn,X
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	TAX
	CPX #STATUS_0::UNCONSCIOUS
	BEQL @UNKNOWN234
	CPX #STATUS_0::DIAMONDIZED
	BEQL @UNKNOWN234
	CPX #STATUS_0::PARALYZED
	BEQ @UNKNOWN154
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::IMMOBILIZED
	BNEL @UNKNOWN157
@UNKNOWN154:
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
.IF .DEFINED(JPN)
	STX @LOCAL0A
.ELSE
	STX @LOCAL0F
.ENDIF
	LDA __BSS_START__,X
	STA @LOCAL10
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	CMP #ACTION_TYPE::PSI
	BEQ @UNKNOWN157
	LDA @LOCAL10
	CMP #BATTLE_ACTIONS::PRAY
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_1
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_2
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_3
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_4
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_5
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_6
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_7
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_8
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::FINAL_PRAYER_9
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::SPY
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::MIRROR
	BEQ @UNKNOWN157
	CMP #BATTLE_ACTIONS::NO_EFFECT
	BEQ @UNKNOWN157
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::PARALYZED
	BNE @UNKNOWN155
	LDA #BATTLE_ACTIONS::ACTION_252
.IF .DEFINED(JPN)
	LDX @LOCAL0A
.ELSE
	LDX @LOCAL0F
.ENDIF
	STA __BSS_START__,X ;battler::current_action
	BRA @UNKNOWN156
@UNKNOWN155:
	LDA #BATTLE_ACTIONS::ACTION_254
.IF .DEFINED(JPN)
	LDX @LOCAL0A
.ELSE
	LDX @LOCAL0F
.ENDIF
	STA __BSS_START__,X ;battler::current_action
@UNKNOWN156:
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN157:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BNE @UNKNOWN158
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	LDA __BSS_START__,X ;battler::current_action
	BEQ @UNKNOWN158
	LDA #BATTLE_ACTIONS::ACTION_253
	STA __BSS_START__,X ;battler::current_action
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN158:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions + STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::SOLIDIFIED
	BNE @UNKNOWN159
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
	LDA __BSS_START__,X ;battler::current_action
	BEQ @UNKNOWN159
	LDA #BATTLE_ACTIONS::ACTION_255
	STA __BSS_START__,X ;battler::current_action
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	LDX CURRENT_ATTACKER
	STZ a:battler::action_item_slot,X
@UNKNOWN159:
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions+STATUS_GROUP::CONCENTRATION,X
	AND #$00FF
	BEQ @UNKNOWN160
	LDX CURRENT_ATTACKER
	INX
	INX
	INX
	INX
.IF .DEFINED(JPN)
	STX @LOCAL0A
.ELSE
	STX @LOCAL0F
.ENDIF
	LDA __BSS_START__,X ;battler::current_action
	STA @LOCAL10
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	CMP #ACTION_TYPE::PSI
	BNE @UNKNOWN160
	LDA @LOCAL10
	BEQ @UNKNOWN160
	LDA #BATTLE_ACTIONS::ACTION_256
.IF .DEFINED(JPN)
	LDX @LOCAL0A
.ELSE
	LDX @LOCAL0F
.ENDIF
	STA __BSS_START__,X ;battler::current_action
@UNKNOWN160:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::HOMESICKNESS,X
	AND #$00FF
	CMP #STATUS_5::HOMESICK
	BNE @UNKNOWN161
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQ @UNKNOWN161
	JSL RAND
	AND #$0007
	BNE @UNKNOWN161
	LDA #BATTLE_ACTIONS::ACTION_251
	LDX CURRENT_ATTACKER
	STA a:battler::current_action,X
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::action_item_slot,X
@UNKNOWN161:
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, @VIRTUAL06
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
.IF .DEFINED(JPN)
	STA @LOCAL0A
.ELSE
	STA @LOCAL0F
.ENDIF
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	AND #$00FF
	CMP #1
	BNE @UNKNOWN163
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	LDA @LOCAL0F
.ENDIF
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	BNE @UNKNOWN163
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN162
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	LDX CURRENT_ATTACKER
	STA a:battler::action_targetting,X
	LDY #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	SEC
	SBC #.LOWORD(BATTLERS_TABLE)
	JSL DIVISION16S_DIVISOR_POSITIVE
	SEP #PROC_FLAGS::ACCUM8
	INC
	LDX CURRENT_ATTACKER
	STA a:battler::current_target,X
	BRA @UNKNOWN163
@UNKNOWN162:
	SEP #PROC_FLAGS::ACCUM8
	LDA #17
	LDX CURRENT_ATTACKER
	STA a:battler::action_targetting,X
	LDY #.SIZEOF(battler)
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	SEC
	SBC #.LOWORD(BATTLERS_TABLE)
	JSL DIVISION16S_DIVISOR_POSITIVE
	TAX
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C4A228
@UNKNOWN163:
	LDX #0
.IF .DEFINED(JPN)
	STX @LOCAL10
.ELSE
	STX @LOCAL0F
.ENDIF
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	STA CURRENT_TARGET
	TXA
	JSL FIX_ATTACKER_NAME
	JSL FIX_TARGET_NAME
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::NAUSEOUS
	BEQ @UNKNOWN164
	CMP #STATUS_0::POISONED
	BEQ @UNKNOWN165
	CMP #STATUS_0::SUNSTROKE
	BEQ @UNKNOWN166
	CMP #STATUS_0::COLD
	BEQ @UNKNOWN167
	JMP @UNKNOWN168
@UNKNOWN164:
	LDA #20
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL10
.ELSE
	STX @LOCAL0F
.ENDIF
	LOADPTR MSG_BTL_KIMOCHI_DAMAGE, @LOCAL00
	TXA
	STORE_INT1632 @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN165:
	LDA #20
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL10
.ELSE
	STX @LOCAL0F
.ENDIF
	LOADPTR MSG_BTL_MODOKU_DAMAGE, @LOCAL00
	TXA
	STORE_INT1632 @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN166:
	LDA #4
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL10
.ELSE
	STX @LOCAL0F
.ENDIF
	LOADPTR MSG_BTL_NISSHA_DAMAGE, @LOCAL00
	TXA
	STORE_INT1632 @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
	BRA @UNKNOWN168
@UNKNOWN167:
	LDA #4
	JSR TWENTY_FIVE_PERCENT_VARIANCE
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL10
.ELSE
	STX @LOCAL0F
.ENDIF
	LOADPTR MSG_BTL_KAZE_DAMAGE, @LOCAL00
	TXA
	STORE_INT1632 @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
@UNKNOWN168:
.IF .DEFINED(JPN)
	LDX @LOCAL10
.ELSE
	LDX @LOCAL0F
.ENDIF
	LDA CURRENT_ATTACKER
	JSL LOSE_HP_STATUS
	LDX CURRENT_ATTACKER
	LDA a:battler::hp,X
	BNE @UNKNOWN171
	LDA CURRENT_ATTACKER
	JSL KO_TARGET
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BEQL @UNKNOWN225
	LDA #1
	JSL COUNT_CHARS
	CMP #0
	BNEL @UNKNOWN234
	JMP @UNKNOWN225
@UNKNOWN171:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #1
	BNE @UNKNOWN172
	LDA CURRENT_ATTACKER
	JSL CHOOSE_TARGET
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN172
	JSL SELECT_STEALABLE_ITEM
	SEP #PROC_FLAGS::ACCUM8
	LDX CURRENT_ATTACKER
	STA a:battler::current_action_argument,X
@UNKNOWN172:
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C24703
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN174
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BNE @UNKNOWN174
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
	MOVE_INT_CONSTANT NULL, @VIRTUAL0A
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL06
	CMP @VIRTUAL0A+2
	BNE @UNKNOWN173
	LDA @VIRTUAL06
	CMP @VIRTUAL0A
@UNKNOWN173:
	BNE @UNKNOWN174
	LDA CURRENT_ATTACKER
	JSL CHOOSE_TARGET
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C24703
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
@UNKNOWN174:
	LDY #0
	STY @LOCAL10
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::MUSHROOMIZED
	BNE @UNKNOWN175
	LDA #100
	JSR RAND_LIMIT
	CMP #MUSHROOMIZED_TARGET_CHANGE_CHANCE
	BCC @UNKNOWN176
@UNKNOWN175:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::STRANGENESS,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN179
@UNKNOWN176:
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BEQ @UNKNOWN179
	LDY #1
	STY @LOCAL10
@UNKNOWN177:
	JSR FEELING_STRANGE_RETARGETTING
	JSL REMOVE_STATUS_UNTARGETTABLE_TARGETS
	MOVE_INT_CONSTANT NULL, @VIRTUAL0A
	MOVE_INT BATTLER_TARGET_FLAGS, @VIRTUAL06
	CMP @VIRTUAL0A+2
	BNE @UNKNOWN178
	LDA @VIRTUAL06
	CMP @VIRTUAL0A
@UNKNOWN178:
	BEQ @UNKNOWN177
@UNKNOWN179:
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	CMP #BATTLE_ACTIONS::STEAL
	BNE @UNKNOWN180
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action_argument,X
	AND #$00FF
	JSL UNKNOWN_C24348
	CMP #0
	BNE @UNKNOWN180
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::current_action_argument,X
@UNKNOWN180:
	REP #PROC_FLAGS::ACCUM8
	LDA #0
	JSL FIX_ATTACKER_NAME
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	LDA a:battler::current_action_argument,X
	JSL REDIRECT_C1ACF8
	JSL UNKNOWN_C23E32
	.A16
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN185
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	CMP #PLAYER_CHAR_COUNT
	BGT @UNKNOWN185
.IF .DEFINED(JPN)
	LDA #$0000
	STA @LOCAL0A
.ELSE
	LDX #0
	STX @LOCAL0F
.ENDIF
	BRA @UNKNOWN184
@UNKNOWN182:
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	STA @VIRTUAL02
.IF .DEFINED(JPN)
	LDA @LOCAL0A
	CLC
	ADC #.LOWORD(GAME_STATE)
	TAX
	LDA a:game_state::party_members,X
.ELSE
	LDX @LOCAL0F
	LDA GAME_STATE + game_state::party_members,X
.ENDIF
	AND #$00FF
	CMP @VIRTUAL02
	BNE @UNKNOWN183
.IF .DEFINED(JPN)
	LDA @LOCAL0A
.ELSE
	TXA
.ENDIF
	JSL REDIRECT_C43573
	BRA @UNKNOWN185
@UNKNOWN183:
.IF .DEFINED(JPN)
	LDA @LOCAL0A
	INC
	STA @LOCAL0A
.ELSE
	INX
	STX @LOCAL0F
.ENDIF
@UNKNOWN184:
.IF .DEFINED(JPN)
	CMP #$0006
.ELSE
	CPX #6
.ENDIF
	BCC @UNKNOWN182
@UNKNOWN185:
	.A16
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	INX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X
	AND #$00FF
	BEQ @UNKNOWN187
	AND #$00FF
	LDX CURRENT_ATTACKER
	CMP a:battler::pp_target,X
	BLTEQ @UNKNOWN186
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PSI_CANNOT
	JMP @UNKNOWN215
@UNKNOWN186:
	TAX
	LDA CURRENT_ATTACKER
	JSL UNKNOWN_C2BCB9
@UNKNOWN187:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	CMP #1
	BNE @UNKNOWN194
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQ @UNKNOWN194
	OPTIMIZED_MULT @VIRTUAL04, 12
	TAX
	INX
	INX
	LDA f:BATTLE_ACTION_TABLE,X ;battle_action::type
	AND #$00FF
	CMP #ACTION_TYPE::PHYSICAL
	BEQ @UNKNOWN188
	CMP #ACTION_TYPE::PIERCING_PHYSICAL
	BEQ @UNKNOWN188
	CMP #ACTION_TYPE::PSI
	BEQ @UNKNOWN189
	CMP #ACTION_TYPE::OTHER
	BEQ @UNKNOWN190
	BRA @UNKNOWN191
@UNKNOWN188:
	LDA #1
	JSL UNKNOWN_C2FEF9
	BRA @UNKNOWN191
@UNKNOWN189:
	LDA #2
	JSL UNKNOWN_C2FEF9
	BRA @UNKNOWN191
@UNKNOWN190:
	LDA #3
	JSL UNKNOWN_C2FEF9
@UNKNOWN191:
	SEP #PROC_FLAGS::ACCUM8
	LDA #12
	LDX CURRENT_ATTACKER
	STA a:battler::unknown73,X
	LDX #0
	STX @LOCAL07
	BRA @UNKNOWN193
@UNKNOWN192:
	JSL WINDOW_TICK
	LDX @LOCAL07
	INX
	STX @LOCAL07
@UNKNOWN193:
	CPX #12
	BCC @UNKNOWN192
@UNKNOWN194:
	LDY @LOCAL10
	BEQ @UNKNOWN196
	LDX CURRENT_ATTACKER
	REP #PROC_FLAGS::ACCUM8
	LDA a:battler::afflictions+STATUS_GROUP::STRANGENESS,X
	AND #$00FF
	CMP #STATUS_3::STRANGE
	BNE @UNKNOWN195
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_RND_ACT_HEN
@UNKNOWN195:
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_HARDHEAL,X
	AND #$00FF
	CMP #STATUS_1::MUSHROOMIZED
	BNE @UNKNOWN196
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_RND_ACT_KINOKO
@UNKNOWN196:
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, @VIRTUAL0A
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
	INC
	INC
	INC
	INC
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	JSL UNKNOWN_C1DD9F
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	BEQL @UNKNOWN215
	BRA @UNKNOWN199
@UNKNOWN198:
	JSL WINDOW_TICK
@UNKNOWN199:
	JSL UNKNOWN_C2EACF
	CMP #0
	BNE @UNKNOWN198
	LDY #0
	STY @LOCAL05
	JMP @UNKNOWN214
@UNKNOWN200:
	TYA
	JSL IS_CHAR_TARGETTED
	CMP #0
	BEQL @UNKNOWN213
	LDY @LOCAL05
	TYA
	LDY #.SIZEOF(battler)
	JSL MULT168
	CLC
	ADC #.LOWORD(BATTLERS_TABLE)
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_TARGET
	LDA a:battler::afflictions+STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	CMP #STATUS_0::UNCONSCIOUS
	BNE @UNKNOWN204
.IF .DEFINED(JPN)
	LDX #$0000
	STX @LOCAL10
.ELSE
	LDA #0
	STA @LOCAL0F
.ENDIF
	BRA @UNKNOWN203
@UNKNOWN202:
.IF .DEFINED(USA)
	TXA
.ENDIF
	LDX CURRENT_ATTACKER
	CMP a:battler::current_action,X
	BEQ @UNKNOWN204
.IF .DEFINED(JPN)
	LDX @LOCAL10
	INX
	STX @LOCAL10
.ELSE
	LDA @LOCAL0F
	INC
	STA @LOCAL0F
.ENDIF
@UNKNOWN203:
.IF .DEFINED(JPN)
	TXA
	ASL
	TAX
	LDA f:DEAD_TARGETTABLE_ACTIONS,X
.ELSE
	ASL
	TAX
	LDA f:DEAD_TARGETTABLE_ACTIONS,X
	TAX
.ENDIF
	BNE @UNKNOWN202
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NOT_EXIST
	JMP @UNKNOWN213
@UNKNOWN204:
	LOADPTR BATTLE_ACTION_TABLE, @VIRTUAL0A
	LDX CURRENT_ATTACKER
	LDA a:battler::current_action,X
	OPTIMIZED_MULT @VIRTUAL04, 12
	CLC
	ADC #8
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT_CONSTANT NULL, @VIRTUAL0A
	CMP32 @VIRTUAL06, @VIRTUAL0A
	BEQ @UNKNOWN213
	PHA
	MOVE_INT @VIRTUAL06, TEMP_FUNCTION_POINTER
	PLA
	JSL UNKNOWN_C09279
	JSL CHECK_DEAD_PLAYERS
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA REDRAW_ALL_WINDOWS
	REP #PROC_FLAGS::ACCUM8
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BEQ @UNKNOWN206
	LDA #1
	JSL COUNT_CHARS
	CMP #0
	BNE @UNKNOWN207
@UNKNOWN206:
	JSL UNKNOWN_C2437E
	JMP @UNKNOWN225
@UNKNOWN207:
	LDA SPECIAL_DEFEAT
	CMP #3
	BEQ @UNKNOWN208
	CMP #2
	BEQ @UNKNOWN209
	CMP #1
	BEQ @UNKNOWN210
	BRA @UNKNOWN212
@UNKNOWN208:
	STZ @LOCAL03
	JMP @UNKNOWN237
@UNKNOWN209:
	JSL UNKNOWN_C2437E
	JMP @ENEMIES_ARE_DEAD
@UNKNOWN210:
	LDA #2
	STA @LOCAL03
	JMP @UNKNOWN237
@UNKNOWN211:
	JSL WINDOW_TICK
@UNKNOWN212:
	LDA SCREEN_EFFECT_MINIMUM_WAIT_FRAMES
	BNE @UNKNOWN211
@UNKNOWN213:
	LDY @LOCAL05
	INY
	STY @LOCAL05
@UNKNOWN214:
	CPY #BATTLER_COUNT
	BCCL @UNKNOWN200
@UNKNOWN215:
	LDX CURRENT_ATTACKER
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN217
	JSL UNKNOWN_C2437E
	LDA MIRROR_ENEMY
	BEQ @UNKNOWN216
	LDX CURRENT_ATTACKER
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN216
	LDX MIRROR_TURN_TIMER
	DEX
	STX MIRROR_TURN_TIMER
	BNE @UNKNOWN216
	STZ MIRROR_ENEMY
	LDA CURRENT_ATTACKER
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	PROMOTENEARPTR MIRROR_BATTLER_BACKUP, @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL COPY_MIRROR_DATA
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NEUTRALIZE_METAMORPH
@UNKNOWN216:
	JSL REDIRECT_C3E6F8
@UNKNOWN217:
	JSL CHECK_DEAD_PLAYERS
	LDA CURRENT_ATTACKER
	STA CURRENT_TARGET
	JSL FIX_TARGET_NAME
	LDX CURRENT_ATTACKER
	LDA a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	AND #$00FF
	CMP #STATUS_2::ASLEEP
	BEQ @UNKNOWN218
	CMP #STATUS_2::IMMOBILIZED
	BEQ @UNKNOWN219
	CMP #STATUS_2::SOLIDIFIED
	BEQ @UNKNOWN220
	BRA @UNKNOWN221
@UNKNOWN218:
	JSL RAND
	AND #$0003
	BNE @UNKNOWN221
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_NEMURI_OFF
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	BRA @UNKNOWN221
@UNKNOWN219:
	.A16
	LDA #100
	JSR RAND_LIMIT
	CMP #100-CHANCE_OF_BODY_MOVING_AGAIN
	BCS @UNKNOWN221
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_SHIBARA_OFF
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
	BRA @UNKNOWN221
@UNKNOWN220:
	.A16
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_KOORI_STAT
	LDX CURRENT_ATTACKER
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::afflictions+STATUS_GROUP::TEMPORARY,X
@UNKNOWN221:
	REP #PROC_FLAGS::ACCUM8
	LDA CURRENT_ATTACKER
	CLC
	ADC #battler::afflictions+STATUS_GROUP::CONCENTRATION
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA __BSS_START__,X
	STA @LOCAL02
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BEQ @UNKNOWN222
	SEP #PROC_FLAGS::ACCUM8
	LDA @LOCAL02
	DEC
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	BNE @UNKNOWN222
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_FUUIN_OFF
@UNKNOWN222:
	LDA #.LOWORD(BATTLERS_TABLE)
	LDX #0
	STX @LOCAL10
	BRA @UNKNOWN224
@UNKNOWN223:
	TAX
	SEP #PROC_FLAGS::ACCUM8
	STZ a:battler::use_alt_spritemap,X
	CLC
	REP #PROC_FLAGS::ACCUM8
	ADC #.SIZEOF(battler)
	LDX @LOCAL10
	INX
	STX @LOCAL10
@UNKNOWN224:
	CPX #BATTLER_COUNT
	BCC @UNKNOWN223
	JSL CHECK_DEAD_PLAYERS
	JSL REDIRECT_SHOW_HPPP_WINDOWS
@UNKNOWN225:
	LDA #0
	JSL COUNT_CHARS
	CMP #0
	BNE @ALLIES_ARE_ALIVE
	LDA #1
	STA @LOCAL03
	JSL RESET_HPPP_ROLLING
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_MONSTER_WIN
	LDA #1
.IF .DEFINED(JPN)
	STA @LOCAL06
.ELSE
	STA @LOCAL09
.ENDIF
@ALLIES_ARE_ALIVE:
	LDA #1
	JSL COUNT_CHARS
	CMP #0
	BNEL @UNKNOWN234
@ENEMIES_ARE_DEAD:
	STZ @LOCAL03
	JSL RESET_HPPP_ROLLING
	LDA #1
	STA LETTERBOX_EFFECT_ENDING
	STA ENABLE_BACKGROUND_DARKENING
	LDY #.LOWORD(GAME_STATE) + game_state::unknownC4
.IF .DEFINED(JPN)
	STY @LOCAL0A
.ELSE
	STY @LOCAL0F
.ENDIF
	LDA BATTLE_MONEY_SCRATCH
	STORE_INT1632 @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	JSL DEPOSIT_INTO_ATM
	MOVE_INT @VIRTUAL06, @VIRTUAL0A
.IF .DEFINED(JPN)
	LDY @LOCAL0A
.ELSE
	LDY @LOCAL0F
.ENDIF
	MOVE_INT_YPTRSRC __BSS_START__, @VIRTUAL06
	CLC
	ADD_INT_ASSIGN @VIRTUAL06, @VIRTUAL0A
	MOVE_INT_YPTRDEST @VIRTUAL06, __BSS_START__
	LDA #0
	JSL COUNT_CHARS
	DEC
	STORE_INT1632 @VIRTUAL0A
	MOVE_INT BATTLE_EXP_SCRATCH, @VIRTUAL06
	CLC
	ADD_INT_ASSIGN @VIRTUAL06, @VIRTUAL0A
	MOVE_INT @VIRTUAL06, BATTLE_EXP_SCRATCH
	LDA #0
	JSL COUNT_CHARS
	STORE_INT1632 @VIRTUAL0A
	JSL DIVISION32
	MOVE_INT @VIRTUAL06, BATTLE_EXP_SCRATCH
	LDA CURRENT_BATTLE_GROUP
	CMP #$01C0
	BCC @NOT_BOSS_BATTLE
	LOADPTR MSG_BTL_PLAYER_WIN_BOSS, @LOCAL00
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
	BRA @SKIP_NOT_BOSS_BATTLE
@NOT_BOSS_BATTLE:
	LOADPTR MSG_BTL_PLAYER_WIN, @LOCAL00
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DISPLAY_TEXT_WAIT
@SKIP_NOT_BOSS_BATTLE:
	LDA ITEM_DROPPED
	BEQ @UNKNOWN230
	SEP #PROC_FLAGS::ACCUM8
	LDA ITEM_DROPPED
	JSL REDIRECT_C1ACF8
	.A16
	DISPLAY_BATTLE_TEXT_PTR MSG_BTL_PRESENT
@UNKNOWN230:
	LDY #.LOWORD(BATTLERS_TABLE)
	STY @LOCAL10
	LDA #0
	STA @VIRTUAL02
	BRA @UNKNOWN233
@UNKNOWN231:
	LDA a:battler::consciousness,Y
	AND #$00FF
	BEQ @UNKNOWN232
	LDA a:battler::ally_or_enemy,Y
	AND #$00FF
	BNE @UNKNOWN232
	LDA a:battler::npc_id,Y
	AND #$00FF
	BNE @UNKNOWN232
	LDA a:battler::afflictions,Y
	AND #$00FF
	TAX
	CPX #STATUS_0::UNCONSCIOUS
	BEQ @UNKNOWN232
	CPX #STATUS_0::DIAMONDIZED
	BEQ @UNKNOWN232
	MOVE_INT BATTLE_EXP_SCRATCH, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #1
	LDA a:battler::id,Y
	JSL GAIN_EXP
@UNKNOWN232:
	LDY @LOCAL10
	TYA
	CLC
	ADC #.SIZEOF(battler)
	TAY
	STY @LOCAL10
	INC @VIRTUAL02
@UNKNOWN233:
	LDA @VIRTUAL02
	CMP #BATTLER_COUNT
	BCC @UNKNOWN231
	LDA #1
.IF .DEFINED(JPN)
	STA @LOCAL06
.ELSE
	STA @LOCAL09
.ENDIF
@UNKNOWN234:
.IF .DEFINED(JPN)
	LDA @LOCAL06
.ELSE
	LDA @LOCAL09
.ENDIF
	BEQL @UNKNOWN145
@UNKNOWN235:
	JSL REDIRECT_CLOSE_FOCUS_WINDOW
@UNKNOWN236:
.IF .DEFINED(JPN)
	LDA @LOCAL06
.ELSE
	LDA @LOCAL09
.ENDIF
	BEQL @UNKNOWN71
@UNKNOWN237:
	JSL RESET_HPPP_ROLLING
@UNKNOWN238:
	JSL WINDOW_TICK
	JSL UNKNOWN_C2108C
	CMP #0
	BEQ @UNKNOWN238
	LDA MIRROR_ENEMY
	BEQL @UNKNOWN243
	LDA #.LOWORD(BATTLERS_TABLE)
.IF .DEFINED(JPN)
	STA @LOCAL0B
	LDX #0
	STX @LOCAL0C
.ELSE
	STA @LOCAL0F
	LDX #0
	STX @LOCAL0A
.ENDIF
	JMP @UNKNOWN242
@UNKNOWN240:
	TAX
	LDA a:battler::consciousness,X
	AND #$00FF
	BEQ @UNKNOWN241
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0F
.ENDIF
	TAX
	LDA a:battler::ally_or_enemy,X
	AND #$00FF
	BNE @UNKNOWN241
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0F
.ENDIF
	TAX
	LDA a:battler::id,X
	CMP #PARTY_MEMBER::POO
	BNE @UNKNOWN241
	STZ MIRROR_ENEMY
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0F
.ENDIF
	CLC
	ADC #battler::afflictions
	TAX
.IF .DEFINED(JPN)
	STX @LOCAL0C
.ELSE
	STX @LOCAL0A
.ENDIF
	LDA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	AND #$00FF
	STA @VIRTUAL04
	STA @LOCAL08
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0F
.ENDIF
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	PROMOTENEARPTR MIRROR_BATTLER_BACKUP, @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL COPY_MIRROR_DATA
	LDA @VIRTUAL04
	SEP #PROC_FLAGS::ACCUM8
.IF .DEFINED(JPN)
	LDX @LOCAL0C
.ELSE
	LDX @LOCAL0A
.ENDIF
	STA a:STATUS_GROUP::PERSISTENT_EASYHEAL,X
	JSL CHECK_DEAD_PLAYERS
	BRA @UNKNOWN243
@UNKNOWN241:
	.A16
.IF .DEFINED(JPN)
	LDA @LOCAL0B
.ELSE
	LDA @LOCAL0F
.ENDIF
	CLC
	ADC #.SIZEOF(battler)
.IF .DEFINED(JPN)
	STA @LOCAL0B
	LDX @LOCAL0C
	INX
	STX @LOCAL0C
.ELSE
	STA @LOCAL0F
	LDX @LOCAL0A
	INX
	STX @LOCAL0A
.ENDIF
@UNKNOWN242:
	CPX #BATTLER_COUNT
	BCCL @UNKNOWN240
@UNKNOWN243:
	JSL RESET_POST_BATTLE_STATS
	SEP #PROC_FLAGS::ACCUM8
	STZ GAME_STATE+game_state::auto_fight_enable
	REP #PROC_FLAGS::ACCUM8
	STZ BATTLE_MODE_FLAG
	LDA BATTLE_MODE
	BEQL @UNKNOWN2
	LDX #1
	TXA
	JSL FADE_OUT
	BRA @UNKNOWN246
@UNKNOWN245:
	JSL WAIT_UNTIL_NEXT_FRAME
	JSL UNKNOWN_C2DB3F
@UNKNOWN246:
	LDA FADE_PARAMETERS + fade_parameters::step
	AND #$00FF
	BNE @UNKNOWN245
	JSL UNKNOWN_C20293
	JSL UNKNOWN_C08726
	JSL UNKNOWN_C1DD5F
	JSL UNKNOWN_C2E0E7
	LDA @LOCAL03
	END_C_FUNCTION
