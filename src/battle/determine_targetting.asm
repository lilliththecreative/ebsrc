
DETERMINE_TARGETTING: ;$C1ADB4
	REP #PROC_FLAGS::ACCUM8 | PROC_FLAGS::INDEX8 | PROC_FLAGS::CARRY
	RESERVE_STACK_SPACE 25
	TXY
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA #$00FF
	STA $01
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, $06
	TXA
	OPTIMIZED_MULT $04, 12
	STA $17
	PHA
	MOVE_INT $06, $0A
	PLA
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	AND #$00FF
	BEQ @ENEMY_TARGETTING_PSI
	CMP #$0001
	BEQL @ALLY_TARGETTING_PSI
	JMP @RETURN
@ENEMY_TARGETTING_PSI:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0010
	STA $00
	REP #PROC_FLAGS::ACCUM8
	LDA $17
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	BEQ @ENEMY_NONE
	CMP #$0001
	BEQ @ENEMY_SINGLE
	CMP #$0002
	BEQ @ENEMY_SINGLE_RANDOM
	CMP #$0003
	BEQ @ENEMY_ROW
	CMP #$0004
	BEQ @ENEMY_ALL
	BRA @ENEMY_ALL
@ENEMY_NONE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0011
	STA $00
	STA $16
	SEP #PROC_FLAGS::INDEX8
	STY $01
	JMP @RETURN
@ENEMY_SINGLE:
	.I16
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0011
	STA $00
	STA $16
	TXY
	LDX #$0001
	REP #PROC_FLAGS::ACCUM8
	LDA #$0000
	JSR UNKNOWN_C1242E
	SEP #PROC_FLAGS::ACCUM8
	STA $01
	JMP @RETURN
@ENEMY_SINGLE_RANDOM:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0011
	STA $00
	STA $16
	REP #PROC_FLAGS::ACCUM8
	LDA #$0001
	JSL COUNT_CHARS
	DEC
	JSL RAND_MOD
	SEP #PROC_FLAGS::ACCUM8
	STA $01
	INC $01
	JMP @RETURN
@ENEMY_ROW:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0012
	STA $00
	STA $16
	TXY
	LDX #$0001
	REP #PROC_FLAGS::ACCUM8
	TXA
	JSR UNKNOWN_C1242E
	SEP #PROC_FLAGS::ACCUM8
	STA $01
	JMP @RETURN
@ENEMY_ALL:
	SEP #PROC_FLAGS::ACCUM8
	LDA $00
	ORA #$0004
	STA $00
	STA $16
	JMP @RETURN
@ALLY_TARGETTING_PSI:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0000
	STA $00
	REP #PROC_FLAGS::ACCUM8
	LDA $17
	INC
	CLC
	ADC $06
	STA $06
	LDA [$06]
	AND #$00FF
	BEQ @ALLY_NONE
	CMP #$0001
	BEQ @ALLY_SINGLE
	CMP #$0002
	BEQ @ALLY_SINGLE_RANDOM
	CMP #$0003
	BEQL @ALLY_ALL
	CMP #$0004
	BEQL @ALLY_ALL
	JMP @ALLY_ALL
@ALLY_NONE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA $00
	STA $16
	SEP #PROC_FLAGS::INDEX8
	STY $01
	BRA @RETURN
@ALLY_SINGLE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA $00
	STA $16
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE+game_state::player_controlled_party_count
	AND #$00FF
	CMP #$0001
	BEQ @ONLY_ONE_ALLY
	LDA #$0003
	JSR UNKNOWN_C193E7
	MOVE_INT_CONSTANT NULL, $06
	MOVE_INT $06, $0E
	MOVE_INT $06, $12
	LDX #$0001
	BRK
	TXA
	JSR CHAR_SELECT_PROMPT
	SEP #PROC_FLAGS::ACCUM8
	STA $01
	JSR UNKNOWN_C19437
	BRA @RETURN
@ONLY_ONE_ALLY:
	SEP #PROC_FLAGS::INDEX8
	STY $01
	BRA @RETURN
@ALLY_SINGLE_RANDOM:
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0001
	STA $00
	STA $16
	REP #PROC_FLAGS::ACCUM8
	LDA #$0000
	JSL COUNT_CHARS
	DEC
	JSL RAND_MOD
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE + game_state::unknown96,X
	STA $01
	BRA @RETURN
@ALLY_ALL:
	SEP #PROC_FLAGS::ACCUM8
	LDA $00
	ORA #$0004
	STA $00
	STA $16
@RETURN:
	REP #PROC_FLAGS::ACCUM8
	LDA $01
	AND #$00FF
	STA $02
	SEP #PROC_FLAGS::INDEX8
	LDY #$0008
	SEP #PROC_FLAGS::ACCUM8
	LDA $16
	STA $00
	REP #PROC_FLAGS::ACCUM8
	LDA $00
	AND #$00FF
	JSL ASL16_ENTRY2
	ORA $02
	REP #PROC_FLAGS::INDEX8
	PLD
	RTS
