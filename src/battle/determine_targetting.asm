
DETERMINE_TARGETTING:
	BEGIN_C_FUNCTION
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT8
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16 ;NEAR battler*
	STACK_RESERVE_PARAM_INT16 ;NEAR battler*
	END_STACK_VARS
	TXY
	TAX
	SEP #PROC_FLAGS::ACCUM8
	LDA #$00FF
	STA @VIRTUAL01
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLE_ACTION_TABLE, @VIRTUAL06
	TXA
	OPTIMIZED_MULT @VIRTUAL04, 12
	STA @LOCAL03
	PHA
	MOVE_INT @VIRTUAL06, @VIRTUAL0A
	PLA
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LDA [@VIRTUAL0A]
	AND #$00FF
	BEQ @ENEMY_TARGETTING_PSI
	CMP #ACTION_DIRECTION::ENEMY
	BEQL @ALLY_TARGETTING_PSI
	JMP @RETURN
@ENEMY_TARGETTING_PSI:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ENEMIES
	STA @VIRTUAL00
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL03
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	BEQ @ENEMY_NONE
	CMP #ACTION_TARGET::ONE
	BEQ @ENEMY_SINGLE
	CMP #ACTION_TARGET::RANDOM
	BEQ @ENEMY_SINGLE_RANDOM
	CMP #ACTION_TARGET::ROW
	BEQ @ENEMY_ROW
	CMP #ACTION_TARGET::ALL
	BEQ @ENEMY_ALL
	BRA @ENEMY_ALL
@ENEMY_NONE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ENEMIES | TARGETTED::SINGLE
	STA @VIRTUAL00
	STA @LOCAL02
	SEP #PROC_FLAGS::INDEX8
	STY @VIRTUAL01
	JMP @RETURN
@ENEMY_SINGLE:
	.I16
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ENEMIES | TARGETTED::SINGLE
	STA @VIRTUAL00
	STA @LOCAL02
	TXY
	LDX #1
	REP #PROC_FLAGS::ACCUM8
	LDA #0
	JSR UNKNOWN_C1242E
	SEP #PROC_FLAGS::ACCUM8
	STA @VIRTUAL01
	JMP @RETURN
@ENEMY_SINGLE_RANDOM:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ENEMIES | TARGETTED::SINGLE
	STA @VIRTUAL00
	STA @LOCAL02
	REP #PROC_FLAGS::ACCUM8
	LDA #1
	JSL COUNT_CHARS
	DEC
	JSL RAND_MOD
	SEP #PROC_FLAGS::ACCUM8
	STA @VIRTUAL01
	INC @VIRTUAL01
	JMP @RETURN
@ENEMY_ROW:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ENEMIES | TARGETTED::ROW
	STA @VIRTUAL00
	STA @LOCAL02
	TXY
	LDX #1
	REP #PROC_FLAGS::ACCUM8
	TXA
	JSR UNKNOWN_C1242E
	SEP #PROC_FLAGS::ACCUM8
	STA @VIRTUAL01
	JMP @RETURN
@ENEMY_ALL:
	SEP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL00
	ORA #TARGETTED::ALL
	STA @VIRTUAL00
	STA @LOCAL02
	JMP @RETURN
@ALLY_TARGETTING_PSI:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ALLIES
	STA @VIRTUAL00
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL03
	INC
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	BEQ @ALLY_NONE
	CMP #ACTION_TARGET::ONE
	BEQ @ALLY_SINGLE
	CMP #ACTION_TARGET::RANDOM
	BEQ @ALLY_SINGLE_RANDOM
	CMP #ACTION_TARGET::ROW
	BEQL @ALLY_ALL
	CMP #ACTION_TARGET::ALL
	BEQL @ALLY_ALL
	JMP @ALLY_ALL
@ALLY_NONE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::SINGLE | TARGETTED::ALLIES
	STA @VIRTUAL00
	STA @LOCAL02
	SEP #PROC_FLAGS::INDEX8
	STY @VIRTUAL01
.IF .DEFINED(JPN)
	JMP @RETURN
.ELSE
	BRA @RETURN
.ENDIF
@ALLY_SINGLE:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::SINGLE | TARGETTED::ALLIES
	STA @VIRTUAL00
	STA @LOCAL02
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE+game_state::player_controlled_party_count
	AND #$00FF
	CMP #1
	BEQ @ONLY_ONE_ALLY
	LDA #3
	JSR UNKNOWN_C193E7
	MOVE_INT_CONSTANT NULL, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @VIRTUAL06, @LOCAL01
	.I16
	LDX #1
	TXA
	JSR CHAR_SELECT_PROMPT
	SEP #PROC_FLAGS::ACCUM8
	STA @VIRTUAL01
	JSR UNKNOWN_C19437
	BRA @RETURN
@ONLY_ONE_ALLY:
	SEP #PROC_FLAGS::INDEX8
	STY @VIRTUAL01
	BRA @RETURN
@ALLY_SINGLE_RANDOM:
	SEP #PROC_FLAGS::ACCUM8
	LDA #TARGETTED::ALLIES | TARGETTED::SINGLE
	STA @VIRTUAL00
	STA @LOCAL02
	REP #PROC_FLAGS::ACCUM8
	LDA #0
	JSL COUNT_CHARS
	DEC
	JSL RAND_MOD
	LDA8_STRUCT_MEMBER GAME_STATE, game_state::unknown96
	STA @VIRTUAL01
	BRA @RETURN
@ALLY_ALL:
	SEP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL00
	ORA #TARGETTED::ALL
	STA @VIRTUAL00
	STA @LOCAL02
@RETURN:
	REP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL01
	AND #$00FF
	STA @VIRTUAL02
	SEP #PROC_FLAGS::INDEX8
	LDY #8
	SEP #PROC_FLAGS::ACCUM8
	LDA @LOCAL02
	STA @VIRTUAL00
	REP #PROC_FLAGS::ACCUM8
	LDA @VIRTUAL00
	AND #$00FF
	JSL ASL16_ENTRY2
	ORA @VIRTUAL02
	REP #PROC_FLAGS::INDEX8
	END_C_FUNCTION
