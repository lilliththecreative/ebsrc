;A: Layer 1 ID, X: Layer 2 ID, Y: Letterbox style
LOAD_BATTLE_BG:
	BEGIN_C_FUNCTION_FAR
	STACK_RESERVE_VARS
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_INT32
	STACK_RESERVE_INT32
	STACK_RESERVE_INT16
	STACK_RESERVE_INT16
	STACK_RESERVE_PARAM_INT16 ;int layer1
	STACK_RESERVE_PARAM_INT16 ;int layer2
	STACK_RESERVE_PARAM_INT16 ;int letterboxing
	END_STACK_VARS
	STY @LOCAL0A
	STX @VIRTUAL04
	STX @LOCAL09
	STA @VIRTUAL02
	STZ RED_FLASH_DURATION
	STZ GREEN_FLASH_DURATION
	STZ SHAKE_DURATION
	STZ WOBBLE_DURATION
	STZ SCREEN_EFFECT_MINIMUM_WAIT_FRAMES
	STZ VERTICAL_SHAKE_HOLD_DURATION
	STZ VERTICAL_SHAKE_DURATION
	LDA @LOCAL0A
	AND #$0003
	BEQ @NO_LETTERBOX
	CMP #LETTERBOX_STYLE::LARGE
	BEQ @LARGE_LETTERBOX
	CMP #LETTERBOX_STYLE::MEDIUM
	BEQ @MEDIUM_LETTERBOX
	CMP #LETTERBOX_STYLE::SMALL
	BEQ @SMALL_LETTERBOX
	BRA @LETTERBOX_SETUP_DONE
@NO_LETTERBOX:
	STZ LETTERBOX_TOP_END
	LDA #SCREEN_Y_RESOLUTION
	STA LETTERBOX_BOTTOM_START
	BRA @LETTERBOX_SETUP_DONE
@LARGE_LETTERBOX:
	LDA #LETTERBOX_SIZE_LARGE - 1
	STA LETTERBOX_TOP_END
	LDA #SCREEN_Y_RESOLUTION - LETTERBOX_SIZE_LARGE
	STA LETTERBOX_BOTTOM_START
	BRA @LETTERBOX_SETUP_DONE
@MEDIUM_LETTERBOX:
	LDA #LETTERBOX_SIZE_MEDIUM - 1
	STA LETTERBOX_TOP_END
	LDA #SCREEN_Y_RESOLUTION - LETTERBOX_SIZE_MEDIUM
	STA LETTERBOX_BOTTOM_START
	BRA @LETTERBOX_SETUP_DONE
@SMALL_LETTERBOX:
	LDA #LETTERBOX_SIZE_SMALL - 1
	STA LETTERBOX_TOP_END
	LDA #SCREEN_Y_RESOLUTION - LETTERBOX_SIZE_SMALL
	STA LETTERBOX_BOTTOM_START
@LETTERBOX_SETUP_DONE:
	STZ LETTERBOX_EFFECT_ENDING
	LDX #$7000
	STX LETTERBOX_EFFECT_ENDING_BOTTOM
	STX LETTERBOX_EFFECT_ENDING_TOP
	STZ ENABLE_BACKGROUND_DARKENING
	LDA #$FFFF
	STA BACKGROUND_BRIGHTNESS
	LOADPTR BUFFER, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL08
	LOADPTR BATTLEBG_GFX_POINTERS, @VIRTUAL0A
	LDA @VIRTUAL02
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(bg_layer_config_entry)
	TAX
	LDA f:BG_DATA_TABLE,X
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @LOCAL08, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	LDA CURRENT_BATTLE_GROUP
	CMP #ENEMY_GROUP::BOSS_GIYGAS_PHASE_DURING_PRAYER_1
	BNE @UNKNOWN5
	LDY #$3000
	LDX #$5C00
	LDA #BG_TILEMAP_SIZE::NORMAL
	JSL SET_BG2_VRAM_LOCATION
	COPY_TO_VRAM1P @VIRTUAL06, $3000, $5000, 0
	BRA @UNKNOWN6
@UNKNOWN5:
	COPY_TO_VRAM1P @VIRTUAL06, $1000, $2000, 0
@UNKNOWN6:
	.A16
	LOADPTR BUFFER, @VIRTUAL0A
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA [@VIRTUAL0A]
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL0A, @VIRTUAL06
	COPY_TO_VRAM1P @VIRTUAL06, $5800, $800, 3
	MOVE_INT @VIRTUAL0A, @VIRTUAL06
	COPY_TO_VRAM1P @VIRTUAL06, $0000, $800, 3
	.A16
	LOADPTR BG_DATA_TABLE, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL07
	LDA @VIRTUAL02
	OPTIMIZED_MULT @VIRTUAL04, 17
	STA @LOCAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	OPTIMIZED_MULT @VIRTUAL04, 4
	PHA
	LOADPTR BATTLEBG_ARR_POINTERS, @VIRTUAL06
	PLA
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	LDA @LOCAL06
	INC
	INC
	MOVE_INTX @LOCAL07, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	CMP #4
	BNEL @UNKNOWN15
	LDA #9
	JSL UNKNOWN_C08D79
	LDA #0
	STA @LOCAL06
	BRA @UNKNOWN9
@UNKNOWN8:
	STORE_INT1632 @VIRTUAL06
	CLC
	VAR_ADD_CONST_INT_ASSIGN BUFFER + 1, @VIRTUAL06
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL06]
	AND #$00DF
	ORA #$0008
	STA [@VIRTUAL06]
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL06
	INC
	INC
	STA @LOCAL06
@UNKNOWN9:
	CMP #$0800
	BCC @UNKNOWN8
	LOADPTR BUFFER, @LOCAL08
	MOVE_INT @LOCAL08, @VIRTUAL06
	COPY_TO_VRAM1P @VIRTUAL06, $5C00, $800, 0
	.A16
	LOADPTR BG_DATA_TABLE, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL07
	LDA @VIRTUAL02
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(bg_layer_config_entry)
	TAX
	STX @LOCAL05
	TXA
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1)
	JSL UNKNOWN_C2CFE5
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette_pointer
	STA @VIRTUAL02
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 2
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDY #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette
	STY @LOCAL04
	LOADPTR BATTLEBG_PALETTE_POINTERS, @LOCAL03
	LDX @LOCAL05
	TXA
	INC
	MOVE_INTX @LOCAL07, @VIRTUAL06
	MOVE_INTX @VIRTUAL06, @VIRTUAL0A
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	MOVE_INT @LOCAL03, @VIRTUAL06
	LDA [@VIRTUAL0A]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette)
	LDY @LOCAL04
	TYA
	JSL MEMCPY16
	LDA [@VIRTUAL0A]
	AND #$00FF
	ASL
	ASL
	PHA
	MOVE_INT @LOCAL03, @VIRTUAL0A
	PLA
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette2)
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette2
	JSL MEMCPY16
	LDY @LOCAL04
	TYA
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #32
	STX @LOCAL05
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	LDX @LOCAL05
	JSL MEMCPY16
	SEP #PROC_FLAGS::ACCUM8
	LDA #2
	STA LOADED_BG_DATA_LAYER1 + loaded_bg_data::target_layer
	LDX #0
	REP #PROC_FLAGS::ACCUM8
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1)
	JSL GENERATE_BATTLEBG_FRAME
	LDX #.LOWORD(LOADED_BG_DATA_LAYER2)
	STX @LOCAL04
	SEP #PROC_FLAGS::ACCUM8
	LDA #0
	STA __BSS_START__,X
	REP #PROC_FLAGS::ACCUM8
	LDA #1
	STA CURRENT_LAYER_CONFIG
	JSL UNKNOWN_C0AFCD
	LDA #$0017
	STA LETTERBOX_VISIBLE_SCREEN_VALUE
	LDA #$0015
	STA LETTERBOX_NONVISIBLE_SCREEN_VALUE
	LDA @LOCAL09
	STA @VIRTUAL04
	BEQL @UNKNOWN23
	LDA @LOCAL0A
	AND #$0004
	BEQL @UNKNOWN14
	LDA #7
	STA CURRENT_LAYER_CONFIG
	JSL UNKNOWN_C0AFCD
	LDA @VIRTUAL04
	OPTIMIZED_MULT @VIRTUAL04, 17
	MOVE_INTX @LOCAL07, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL02
	LDA @VIRTUAL06+2
	STA @LOCAL02+2
	LOADPTR BATTLEBG_GFX_POINTERS, @VIRTUAL0A
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @LOCAL08, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	MOVE_INT @LOCAL08, @VIRTUAL06
	COPY_TO_VRAM1P @VIRTUAL06, $0000, $2000, 0
	.A16
	LOADPTR BATTLEBG_ARR_POINTERS, @VIRTUAL0A
	MOVE_INT @LOCAL02, @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @LOCAL08, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	LDA #0
	STA @LOCAL0A
	BRA @UNKNOWN13
@UNKNOWN12:
	STORE_INT1632 @VIRTUAL06
	CLC
	VAR_ADD_CONST_INT_ASSIGN BUFFER + 1, @VIRTUAL06
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL06]
	AND #$00DF
	ORA #$0010
	STA [@VIRTUAL06]
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0A
	INC
	INC
	STA @LOCAL0A
@UNKNOWN13:
	CMP #$0800
	BCC @UNKNOWN12
	COPY_TO_VRAM1 BUFFER, $5800, $800, 0
	.A16
	LOADPTR BG_DATA_TABLE, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL08
	LDA @LOCAL09
	STA @VIRTUAL04
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(bg_layer_config_entry)
	TAX
	STX @LOCAL05
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2)
	STA @VIRTUAL04
	TXA
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDA @VIRTUAL04
	JSL UNKNOWN_C2CFE5
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette_pointer
	STA @VIRTUAL02
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 4
	LDX @VIRTUAL02
	STA __BSS_START__,X
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	LDX @VIRTUAL04
	STA __BSS_START__,X
	LDY #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette
	STY @LOCAL09
	REP #PROC_FLAGS::ACCUM8
	LOADPTR BATTLEBG_PALETTE_POINTERS, @VIRTUAL0A
	LDX @LOCAL05
	TXA
	INC
	MOVE_INTX @LOCAL08, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL02
	LDA @VIRTUAL06+2
	STA @LOCAL02+2
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	MOVE_INTX @VIRTUAL0A, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette)
	LDY @LOCAL09
	TYA
	JSL MEMCPY16
	MOVE_INT @LOCAL02, @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette2)
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette2
	JSL MEMCPY16
	LDY @LOCAL09
	TYA
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #32
	STX @LOCAL06
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	LDX @LOCAL06
	JSL MEMCPY16
	LDX #1
	LDA @VIRTUAL04
	JSL GENERATE_BATTLEBG_FRAME
	LDA #$0215
	STA LETTERBOX_VISIBLE_SCREEN_VALUE
	LDA #$0014
	STA LETTERBOX_NONVISIBLE_SCREEN_VALUE
	JMP @UNKNOWN23
@UNKNOWN14:
	LDA @VIRTUAL04
	OPTIMIZED_MULT @VIRTUAL04, 17
	MOVE_INTX @LOCAL07, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDX @LOCAL04
	TXA
	JSL UNKNOWN_C2CFE5
	SEP #PROC_FLAGS::ACCUM8
	LDA #1
	STA LOADED_BG_DATA_LAYER2 + loaded_bg_data::freeze_palette_scrolling
	LDA #2
	LDX @LOCAL04
	STA __BSS_START__,X
	JMP @UNKNOWN23
@UNKNOWN15:
	.A16
	LDA #8
	JSL UNKNOWN_C08D79
	LDY #$6000
	LDX #$7C00
	LDA #BG_TILEMAP_SIZE::NORMAL
	JSL SET_BG1_VRAM_LOCATION
	LDY #$0000
	LDX #$5800
	TYA
	JSL SET_BG2_VRAM_LOCATION
	LDY #$1000
	LDX #$5C00
	LDA #BG_TILEMAP_SIZE::NORMAL
	JSL SET_BG3_VRAM_LOCATION
	LDY #$3000
	LDX #$0C00
	LDA #BG_TILEMAP_SIZE::NORMAL
	JSL SET_BG4_VRAM_LOCATION
	LDA #0
	STA @LOCAL0A
	BRA @UNKNOWN17
@UNKNOWN16:
	STORE_INT1632 @VIRTUAL06
	CLC
	VAR_ADD_CONST_INT_ASSIGN BUFFER + 1, @VIRTUAL06
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL06]
	AND #$00DF
	STA [@VIRTUAL06]
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0A
	INC
	INC
	STA @LOCAL0A
@UNKNOWN17:
	CMP #$0800
	BCC @UNKNOWN16
	LOADPTR BUFFER, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL07
	COPY_TO_VRAM1P @VIRTUAL06, $5C00, $800, 0
	.A16
	LOADPTR BG_DATA_TABLE, @LOCAL08
	LDA @VIRTUAL02
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(bg_layer_config_entry)
	TAX
	STX @LOCAL05
	MOVE_INT @LOCAL08, @VIRTUAL06
	TXA
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1)
	JSL UNKNOWN_C2CFE5
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette_pointer
	STA @VIRTUAL02
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 4
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDY #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette
	STY @LOCAL04
	LOADPTR BATTLEBG_PALETTE_POINTERS, @LOCAL03
	MOVE_INT @LOCAL08, @VIRTUAL0A
	LDX @LOCAL05
	TXA
	INC
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	MOVE_INT @LOCAL03, @VIRTUAL06
	LDA [@VIRTUAL0A]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette)
	LDY @LOCAL04
	TYA
	JSL MEMCPY16
	LDA [@VIRTUAL0A]
	AND #$00FF
	ASL
	ASL
	PHA
	MOVE_INT @LOCAL03, @VIRTUAL0A
	PLA
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette2)
	LDA #.LOWORD(LOADED_BG_DATA_LAYER1) + loaded_bg_data::palette2
	JSL MEMCPY16
	LDY @LOCAL04
	TYA
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #32
	STX @LOCAL05
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	LDX @LOCAL05
	JSL MEMCPY16
	SEP #PROC_FLAGS::ACCUM8
	LDA #3
	STA LOADED_BG_DATA_LAYER1 + loaded_bg_data::target_layer
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL09
	STA @VIRTUAL04
	BEQL @UNKNOWN21
	LDA #3
	STA CURRENT_LAYER_CONFIG
	JSL UNKNOWN_C0AFCD
	MOVE_INT @LOCAL08, @VIRTUAL0A
	LDA @VIRTUAL04
	OPTIMIZED_MULT @VIRTUAL04, 17
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	LOADPTR BATTLEBG_GFX_POINTERS, @VIRTUAL06
	LDA [@VIRTUAL0A]
	AND #$00FF
	OPTIMIZED_MULT @VIRTUAL04, 4
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @LOCAL07, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	COPY_TO_VRAM1P @VIRTUAL06, $3000, $1800, 0
	.A16
	LDA [@VIRTUAL0A]
	AND #$00FF
	ASL
	ASL
	PHA
	LOADPTR BATTLEBG_ARR_POINTERS, @VIRTUAL0A
	PLA
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	MOVE_INT @LOCAL07, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL01
	JSL DECOMP
	LDA #0
	STA @LOCAL0A
	BRA @UNKNOWN20
@UNKNOWN19:
	STORE_INT1632 @VIRTUAL06
	CLC
	VAR_ADD_CONST_INT_ASSIGN BUFFER + 1, @VIRTUAL06
	SEP #PROC_FLAGS::ACCUM8
	LDA [@VIRTUAL06]
	AND #$00DF
	STA [@VIRTUAL06]
	REP #PROC_FLAGS::ACCUM8
	LDA @LOCAL0A
	INC
	INC
	STA @LOCAL0A
@UNKNOWN20:
	CMP #$0800
	BCC @UNKNOWN19
	COPY_TO_VRAM1 BUFFER, $C00, $800, 0
	.A16
	LOADPTR BG_DATA_TABLE, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL08
	LDA @LOCAL09
	STA @VIRTUAL04
	OPTIMIZED_MULT @VIRTUAL04, .SIZEOF(bg_layer_config_entry)
	TAX
	STX @LOCAL05
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2)
	STA @VIRTUAL04
	TXA
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL00
	LDA @VIRTUAL06+2
	STA @LOCAL00+2
	LDA @VIRTUAL04
	JSL UNKNOWN_C2CFE5
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette_pointer
	STA @VIRTUAL02
	LDA #.LOWORD(PALETTES) + BPP4PALETTE_SIZE * 6
	LDX @VIRTUAL02
	STA __BSS_START__,X
	LDY #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette
	STY @LOCAL09
	LOADPTR BATTLEBG_PALETTE_POINTERS, @VIRTUAL0A
	LDX @LOCAL05
	TXA
	INC
	MOVE_INTX @LOCAL08, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	STA @LOCAL02
	LDA @VIRTUAL06+2
	STA @LOCAL02+2
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	MOVE_INTX @VIRTUAL0A, @VIRTUAL06
	CLC
	ADC @VIRTUAL06
	STA @VIRTUAL06
	DEREFERENCE_PTR_TO @VIRTUAL06, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette)
	LDY @LOCAL09
	TYA
	JSL MEMCPY16
	MOVE_INT @LOCAL02, @VIRTUAL06
	LDA [@VIRTUAL06]
	AND #$00FF
	ASL
	ASL
	CLC
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #.SIZEOF(loaded_bg_data::palette2)
	LDA #.LOWORD(LOADED_BG_DATA_LAYER2) + loaded_bg_data::palette2
	JSL MEMCPY16
	LDY @LOCAL09
	TYA
	PROMOTENEARPTRA @VIRTUAL06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT @VIRTUAL06, @LOCAL00
	LDX #32
	STX @LOCAL05
	LDX @VIRTUAL02
	LDA __BSS_START__,X
	LDX @LOCAL05
	JSL MEMCPY16
	SEP #PROC_FLAGS::ACCUM8
	LDA #4
	LDX @VIRTUAL04
	STA __BSS_START__,X
	BRA @UNKNOWN22
@UNKNOWN21:
	SEP #PROC_FLAGS::ACCUM8
	STZ LOADED_BG_DATA_LAYER2 + loaded_bg_data::target_layer
@UNKNOWN22:
	REP #PROC_FLAGS::ACCUM8
	LDA #$0817
	STA LETTERBOX_VISIBLE_SCREEN_VALUE
	LDA #$0013
	STA LETTERBOX_NONVISIBLE_SCREEN_VALUE
@UNKNOWN23:
	REP #PROC_FLAGS::ACCUM8
	STZ DISTORT_30FPS
	LDA LOADED_BG_DATA_LAYER2
	AND #$00FF
	BEQ @UNKNOWN24
	LDA LOADED_BG_DATA_LAYER2 + loaded_bg_data::distortion_styles
	AND #$00FF
	BEQ @UNKNOWN24
	LDA #1
	STA DISTORT_30FPS
@UNKNOWN24:
	JSL UNKNOWN_C2D0AC
	LDA LETTERBOX_TOP_END
	BEQ @UNKNOWN25
	LDA #2
	JSL UNKNOWN_C429E8
@UNKNOWN25:
	JSL UNKNOWN_C2E9ED
	END_C_FUNCTION
