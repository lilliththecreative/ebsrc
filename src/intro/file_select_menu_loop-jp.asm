
FILE_MENU_LOOP: ;$C1F805
	REP #PROC_FLAGS::ACCUM8 | PROC_FLAGS::INDEX8 | PROC_FLAGS::CARRY
	RESERVE_STACK_SPACE_CLOBBER 40
@UNKNOWN0:
	JSR SET_INSTANT_PRINTING
	LDA #$0000
	JSR FILE_SELECT_MENU
	TAX
	DEX
	LDA SAVE_FILES_PRESENT,X
	AND #$00FF
	BEQL @EMPTY_FILE_SELECTED
@VALID_FILE_SELECTED:
	JSR UNKNOWN_C1F07E
	CMP #$0000
	BEQ @MENU_B_PRESSED
	CMP #$0001
	BEQ @MENU_STARTGAME_SELECTED
	CMP #$0002
	BEQ @MENU_COPY_SELECTED
	CMP #$0003
	BEQ @MENU_DELETE_SELECTED
	CMP #$0004
	BEQ @MENU_SETUP_SELECTED
	BRA @MENU_OTHER_SELECTED
@MENU_B_PRESSED:
	JSR UNKNOWN_C1008E
	BRA @UNKNOWN0
@MENU_STARTGAME_SELECTED:
	JSL UNKNOWN_C064D4
	JSL RELOAD_HOTSPOTS
	LDA GAME_STATE+game_state::leader_x_coord
	STA RESPAWN_X
	LDA GAME_STATE+game_state::leader_y_coord
	STA RESPAWN_Y
	JMP @UNKNOWN59
@MENU_COPY_SELECTED:
	JSR UNKNOWN_C1F14F
	CMP #$0000
	BEQ @VALID_FILE_SELECTED
	BRA @MENU_OTHER_SELECTED
@MENU_DELETE_SELECTED:
	JSR UNKNOWN_C1F2A8
	CMP #$0000
	BEQ @VALID_FILE_SELECTED
	BRA @MENU_OTHER_SELECTED
@MENU_SETUP_SELECTED:
	LDA #$0000
	JSR OPEN_TEXT_SPEED_MENU
	CMP #$0000
	BNE @MENU_SETUP_SELECTED2
	LDA #$0018
	JSR CLOSE_WINDOW
	BRA @VALID_FILE_SELECTED
@MENU_SETUP_SELECTED2:
	LDA #$0000
	JSR OPEN_SOUND_MENU
	CMP #$0000
	BNE @MENU_SETUP_SELECTED3
	LDA #$0019
	JSR CLOSE_WINDOW
	BRA @MENU_SETUP_SELECTED
@MENU_SETUP_SELECTED3:
	JSR OPEN_FLAVOUR_MENU
	CMP #$0000
	BEQ @MENU_SETUP_SELECTED2
@MENU_OTHER_SELECTED:
	JSR UNKNOWN_C1008E
	JMP @UNKNOWN0
@EMPTY_FILE_SELECTED:
	LDA #$0000
	JSR OPEN_TEXT_SPEED_MENU
	CMP #$0000
	BNE @UNKNOWN14
	LDA #$0018
	JSR CLOSE_WINDOW
	JMP @UNKNOWN0
@UNKNOWN14:
	LDA #$0000
	JSR OPEN_SOUND_MENU
	CMP #$0000
	BNE @UNKNOWN16
	LDA #$0019
	JSR CLOSE_WINDOW
	BRA @EMPTY_FILE_SELECTED
@UNKNOWN16:
	JSR OPEN_FLAVOUR_MENU
	CMP #$0000
	BEQ @UNKNOWN14
@CHANGE_TO_NAMING_SCREEN_MUSIC:
	LDA #MUSIC::NAMING_SCREEN
	JSL CHANGE_MUSIC
@UNKNOWN18:
	JSR UNKNOWN_C1008E
	LDA #$0000
	STA $02
	JMP @UNKNOWN31
@UNKNOWN19:
	LDA $02
	CMP #$FFFF
	BNE @UNKNOWN20
	JSR UNKNOWN_C1008E
	LDA #$0001
	JSR FILE_SELECT_MENU
	LDA #$0001
	JSR OPEN_TEXT_SPEED_MENU
	LDA #$0001
	JSR OPEN_SOUND_MENU
	LDA #MUSIC::SETUP_SCREEN
	JSL CHANGE_MUSIC
	BRA @UNKNOWN16
@UNKNOWN20:
	LDA $02
	JSL DISPLAY_ANIMATED_NAMING_SPRITE
	LDA #FILE_MENU_NEW_GAME_NAME::DOG
	CLC
	SBC $02
	BRANCHLTEQS @UNKNOWN24
	LOADPTR FILE_SELECT_TEXT_PLEASE_NAME_THEM_STRINGS, $06
	LDA $02
	OPTIMIZED_MULT $04, 15
	CLC
	ADC $06
	STA $06
	STA $0E
	LDA $08
	STA $10
	LDA #NAME_THEM_STRING_LENGTH
	STA $12
	LDY $02
	STY $26
	LDA $02
	LDY #.SIZEOF(char_struct)
	JSL MULT168
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS)
	TAX
	LDA #.SIZEOF(char_struct::name)
	LDY $26
	JSR NAME_A_CHARACTER
	CMP #$0000
	BEQ @UNKNOWN23
	LDA #$FFFF
	STA $04
	STA $24
	JMP @UNKNOWN30
@UNKNOWN23:
	LDA #$0001
	STA $04
	STA $24
	JMP @UNKNOWN30
@UNKNOWN24:
	LDA $02
	CMP #FILE_MENU_NEW_GAME_NAME::DOG
	BNE @UNKNOWN26
	LOADPTR FILE_SELECT_TEXT_PLEASE_NAME_THEM_STRINGS, $06
	LDA $02
	OPTIMIZED_MULT $04, 15
	CLC
	ADC $06
	STA $06
	STA $0E
	LDA $08
	STA $10
	LDA #NAME_THEM_STRING_LENGTH
	STA $12
	LDY $02
	LDX #.LOWORD(GAME_STATE) + game_state::pet_name
	LDA #$0006
	JSR NAME_A_CHARACTER
	CMP #$0000
	BEQ @UNKNOWN25
	LDA #$FFFF
	STA $04
	STA $24
	JMP @UNKNOWN30
@UNKNOWN25:
	LDA #$0001
	STA $04
	STA $24
	JMP @UNKNOWN30
@UNKNOWN26:
	LDA $02
	CMP #FILE_MENU_NEW_GAME_NAME::FAVORITE_FOOD
	BNE @UNKNOWN28
	LOADPTR FILE_SELECT_TEXT_PLEASE_NAME_THEM_STRINGS, $06
	LDA $02
	OPTIMIZED_MULT $04, 15
	CLC
	ADC $06
	STA $06
	STA $0E
	LDA $08
	STA $10
	LDA #NAME_THEM_STRING_LENGTH
	STA $12
	LDY $02
	LDX #.LOWORD(GAME_STATE) + game_state::favourite_food
	LDA #$0006
	JSR NAME_A_CHARACTER
	CMP #$0000
	BEQ @UNKNOWN27
	LDA #$FFFF
	STA $04
	STA $24
	BRA @UNKNOWN30
@UNKNOWN27:
	LDA #$0001
	STA $04
	STA $24
	BRA @UNKNOWN30
@UNKNOWN28:
	LDA $02
	CMP #FILE_MENU_NEW_GAME_NAME::FAVORITE_THING
	BNE @UNKNOWN30
	LOADPTR FILE_SELECT_TEXT_PLEASE_NAME_THEM_STRINGS, $06
	LDA $02
	OPTIMIZED_MULT $04, 15
	CLC
	ADC $06
	STA $06
	STA $0E
	LDA $08
	STA $10
	LDA #NAME_THEM_STRING_LENGTH
	STA $12
	LDY $02
	LDX #.LOWORD(GAME_STATE) + game_state::favourite_thing + 2 ; part after 'PSI ' prefix
	LDA #$0006
	JSR NAME_A_CHARACTER
	CMP #$0000
	BEQ @UNKNOWN29
	LDA #$FFFF
	STA $04
	STA $24
	BRA @UNKNOWN30
@UNKNOWN29:
	LDA #$0001
	STA $04
	STA $24
@UNKNOWN30:
	LDA $02
	JSL UNKNOWN_C4D830
	LDA $24
	STA $04
	LDA $02
	CLC
	ADC $04
	STA $02
@UNKNOWN31:
	LDA #THINGS_NAMED_COUNT
	CLC
	SBC $02
	JUMPGTS @UNKNOWN19
	JSR UNKNOWN_C1008E
	JSR SET_INSTANT_PRINTING
	LDX #$0000
	STX $22
	BRA @UNKNOWN35
@UNKNOWN34:
	TXA
	CLC
	ADC #WINDOW::FILE_SELECT_NAMING_CONFIRMATION_NESS
	JSR CREATE_WINDOW
	LDX $22
	INX
	STX $20
	TXA
	JSR UNKNOWN_C1931B
	LDX $20
	STX $22
@UNKNOWN35:
	STX $02
	LDA #PLAYER_CHAR_COUNT
	CLC
	SBC $02
	BRANCHGTS @UNKNOWN34
	CREATE_WINDOW_NEAR #WINDOW::FILE_SELECT_NAMING_CONFIRMATION_KING
	LDA #$0007
	JSR UNKNOWN_C1931B
	LDA #WINDOW::FILE_SELECT_NAMING_CONFIRMATION_FOOD
	JSR CREATE_WINDOW
	LOADPTR FILE_SELECT_TEXT_FAVORITE_FOOD, $0E
	LDA #$0009
	JSR PRINT_STRING
<<<<<<< HEAD
	LDA #.LOWORD(WINDOW_STATS) + window_stats::width
	STA @VIRTUAL02
	STA @LOCAL07
=======
	LDA #$89CC
	STA $02
	STA $22
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.LOWORD(GAME_STATE) + game_state::favourite_food
	STY $20
	LDX #$0006
	TYA
	JSR UNKNOWN_C117E2
	LDX #$0001
	STX $1E
	PHA
<<<<<<< HEAD
	LDA OPEN_WINDOW_TABLE + WINDOW::FILE_SELECT_NAMING_CONFIRMATION_FOOD * 2
=======
	LDA WINDOW_EXISTENCE_TABLE+68
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	CLC
	ADC $02
	TAX
	LDA __BSS_START__,X
	PLY
	STY $02
	SEC
	SBC $02
	LDX $1E
	JSR UNKNOWN_C438A5
	LDY $20
	TYA
	PROMOTENEARPTRA $06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT $06, $0E
	LDA #$0006
	JSR PRINT_STRING
	LDA #WINDOW::FILE_SELECT_NAMING_CONFIRMATION_THING
	JSR CREATE_WINDOW
	LOADPTR FILE_SELECT_TEXT_COOLEST_THING, $0E
	LDA #$000B
	JSR PRINT_STRING
	LDY #.LOWORD(GAME_STATE) + game_state::favourite_thing + 2 ; part after 'PSI ' prefix
	STY $1C
	LDX #$0006
	TYA
	JSR $1DBF
	LDX #$0001
	STX $1E
	PHA
<<<<<<< HEAD
	LDA @LOCAL07
	STA @VIRTUAL02
	LDA OPEN_WINDOW_TABLE + WINDOW::FILE_SELECT_NAMING_CONFIRMATION_THING * 2
=======
	LDA $22
	STA $02
	LDA WINDOW_EXISTENCE_TABLE+70
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	LDY #.SIZEOF(window_stats)
	JSL MULT168
	CLC
	ADC $02
	TAX
	LDA __BSS_START__,X
	PLY
	STY $02
	SEC
	SBC $02
	LDX $1E
	JSR UNKNOWN_C438A5
	LDY $1C
	TYA
	PROMOTENEARPTRA $06
	REP #PROC_FLAGS::ACCUM8
	MOVE_INT $06, $0E
	LDA #$0007
	JSR PRINT_STRING
	CREATE_WINDOW_NEAR #WINDOW::FILE_SELECT_NAMING_CONFIRMATION_MESSAGE
	LOADPTR FILE_SELECT_TEXT_ARE_YOU_SURE, $0E
	LDA #$000C
	JSR PRINT_STRING
	MOVE_INT_CONSTANT NULL, $06
	LOADPTR FILE_SELECT_TEXT_ARE_YOU_SURE_YEP, $0E
	MOVE_INT $06, $12
	LDY #$0000
	LDX #$000D
	LDA #$0001
	JSR UNKNOWN_C1153B
	LOADPTR FILE_SELECT_TEXT_ARE_YOU_SURE_NOPE, $0E
	MOVE_INT $06, $12
	LDY #$0000
	LDX #$0011
	TYA
	JSR UNKNOWN_C1153B
	JSR PRINT_MENU_ITEMS
	JSL UNKNOWN_C4D8FA
	LDA #$0001
	JSR SELECTION_MENU
	TAX
	BNE @EVERYTHING_OKAY
	JSL UNKNOWN_C021E6
	JMP @UNKNOWN18
@EVERYTHING_OKAY:
	LDA #MUSIC::NAME_CONFIRMATION
	JSL CHANGE_MUSIC
	JSL WINDOW_TICK
	LDX #$0000
	STX $1A
	BRA @UNKNOWN46
@UNKNOWN45:
	JSL UNKNOWN_C1004E
	LDX $1A
	INX
	STX $1A
@UNKNOWN46:
	STX $02
	LDA #$00B4
	CLC
	SBC $02
	BRANCHGTS @UNKNOWN45
	JSL UNKNOWN_C021E6
	STZ $1A
	JMP @UNKNOWN51
@UNKNOWN49:
	LDA $1A
	STA $04
	INC $04
	LDA $04
	STA $22
	LOADPTR INITIAL_STATS, $06
	LDA $1A
	OPTIMIZED_MULT $04, 20
	STA $02
	LDY #$0000
	LDA $02
	CLC
	ADC #$0006
	MOVE_INTX $06, $0A
	CLC
	ADC $0A
	STA $0A
	LDA [$0A]
	TAX
	LDA $22
	STA $04
	JSR RESET_CHAR_LEVEL_ONE
	LDA $02
	CLC
	ADC #$0008
	CLC
	ADC $06
	STA $06
	LDA [$06]
	BEQ @UNKNOWN50
	STORE_INT1632 $06
	MOVE_INT $06, $0E
	LDX #$0000
	LDA $04
	JSL GAIN_EXP
@UNKNOWN50:
	LDA $1A
	LDY #.SIZEOF(char_struct)
	JSL MULT168
<<<<<<< HEAD
	STA @VIRTUAL02
	LDX @VIRTUAL02
	LDA PARTY_CHARACTERS+char_struct::max_hp,X
	LDX @VIRTUAL02
	STA PARTY_CHARACTERS+char_struct::current_hp,X
	LDX @VIRTUAL02
	STA PARTY_CHARACTERS+char_struct::current_hp_target,X
	LDX @VIRTUAL02
	LDA PARTY_CHARACTERS+char_struct::max_pp,X
	LDX @VIRTUAL02
	STA PARTY_CHARACTERS+char_struct::current_pp,X
	LDX @VIRTUAL02
	STA PARTY_CHARACTERS+char_struct::current_pp_target,X
	LDX @VIRTUAL02
	STZ PARTY_CHARACTERS+char_struct::current_pp_fraction,X
	LDX @VIRTUAL02
	STZ PARTY_CHARACTERS+char_struct::current_hp_fraction,X
	LDA @VIRTUAL02
=======
	STA $02
	LDX $02
	LDA CHAR_STRUCT+char_struct::max_hp,X
	LDX $02
	STA CHAR_STRUCT+char_struct::current_hp,X
	LDX $02
	STA CHAR_STRUCT+char_struct::current_hp_target,X
	LDX $02
	LDA CHAR_STRUCT+char_struct::max_pp,X
	LDX $02
	STA CHAR_STRUCT+char_struct::current_pp,X
	LDX $02
	STA CHAR_STRUCT+char_struct::current_pp_target,X
	LDX $02
	STZ CHAR_STRUCT+char_struct::current_pp_fraction,X
	LDX $02
	STZ CHAR_STRUCT+char_struct::current_hp_fraction,X
	LDA $02
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	CLC
	ADC #.LOWORD(PARTY_CHARACTERS) + char_struct::items
	TAY
	STY $22
	SEP #PROC_FLAGS::ACCUM8
	LDA #$00
	STA $0E
	LDX #$000E
	REP #PROC_FLAGS::ACCUM8
	TYA
	JSL MEMSET16
	LOADPTR INITIAL_STATS, $06
	LDA $1A
	OPTIMIZED_MULT $04, 20
	CLC
	ADC #$000A
	CLC
	ADC $06
	STA $06
	STA $0E
	LDA $08
	STA $10
	LDX #$000A
	LDY $22
	TYA
	JSL MEMCPY16
	LDA #$0400
<<<<<<< HEAD
	LDX @VIRTUAL02
	STA PARTY_CHARACTERS+char_struct::hp_pp_window_options,X
	INC @LOCAL03
=======
	LDX $02
	STA CHAR_STRUCT+char_struct::hp_pp_window_options,X
	INC $1A
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
@UNKNOWN51:
	LDA #PLAYER_CHAR_COUNT
	CLC
	SBC $1A
	JUMPGTS @UNKNOWN49
	LOADPTR INITIAL_STATS, $06
	MOVE_INT $06, $16
	LDY #$0004
	LDA [$06],Y
	STORE_INT1632 $06
	MOVE_INT $06, GAME_STATE+game_state::money_carried
	MOVE_INT $16, $06
	LDY #$0002
	LDA [$06],Y
	ASL
	ASL
	ASL
	TAX
	LDA [$06]
	ASL
	ASL
	ASL
	JSL UNKNOWN_C0B65F
	SEP #PROC_FLAGS::ACCUM8
	LDA #$0050 ;'P'
	STA GAME_STATE+game_state::favourite_thing
	LDA #$004B ;'K'
	STA GAME_STATE+game_state::favourite_thing+1
	LDA #$0001
	STA GAME_STATE + game_state::unknownC3
	REP #PROC_FLAGS::ACCUM8
	LDA GAME_STATE+game_state::leader_x_coord
	STA RESPAWN_X
	LDA GAME_STATE+game_state::leader_y_coord
	STA RESPAWN_Y
	JSL UNKNOWN_C064D4
	LDX #$06E8
	LDA #$0840
	JSL UNKNOWN_C0B65F
	LOADPTR MSG_EVT_PROLOGUE_NEW, $0E
	JSL UNKNOWN_C46881
	LDX #$0001
	LDA #EVENT_FLAG::FLG_SYS_MONSTER_OFF
	JSL SET_EVENT_FLAG
	LDA #$0001
	STA SHOW_NPC_FLAG
@UNKNOWN59:
	JSR UNKNOWN_C1008E
	JSL UNKNOWN_C3EBCA
	LDA GAME_STATE+game_state::text_speed
	AND #$00FF
	TAX
	DEC
	STA $22
	LOADPTR UNKNOWN_C3FB1F, $0A
	LDA $22
	ASL
	ASL
	CLC
<<<<<<< HEAD
	ADC @VIRTUAL0A
	STA @VIRTUAL0A
	DEREFERENCE_PTR_TO @VIRTUAL0A, @VIRTUAL06
	MOVE_INT @VIRTUAL06, HP_METER_SPEED
	LDA @LOCAL07
=======
	ADC $0A
	STA $0A
	DEREFERENCE_PTR_TO $0A, $06
	MOVE_INT $06, UNKNOWN_7E9627
	LDA $22
>>>>>>> parent of e89e3811 (switch to new stack macro, delete old one and replace some magic numbers)
	STA SELECTED_TEXT_SPEED
	CPX #$0003
	BNE @UNKNOWN60
	LDA #$0000
	BRA @UNKNOWN61
@UNKNOWN60:
	TXA
	OPTIMIZED_MULT $04, 30
@UNKNOWN61:
	STA TEXT_SPEED_BASED_WAIT
	STZ UNREAD_7E5DBA
	DISPLAY_TEXT_PTR MSG_SYS_PRE_GAMESTART
	PLD
	RTS
